<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RECON — Defence Sector Prospecting</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0a0e17; --bg-secondary: #111827; --bg-tertiary: #1a2235;
    --bg-card: #151d2e; --bg-hover: #1e2a3f; --border: #243049; --border-light: #2d3a52;
    --text-primary: #e8ecf4; --text-secondary: #8b95a8; --text-muted: #5a6478;
    --accent-amber: #f59e0b; --accent-amber-dim: #92600a;
    --accent-green: #10b981; --accent-green-dim: #065f46;
    --accent-red: #ef4444; --accent-red-dim: #7f1d1d;
    --accent-blue: #3b82f6; --accent-blue-dim: #1e3a5f;
    --accent-purple: #8b5cf6;
    --status-prospect: #f59e0b; --status-contacted: #3b82f6; --status-engaged: #8b5cf6;
    --status-proposal: #ec4899; --status-won: #10b981; --status-lost: #ef4444; --status-dormant: #6b7280;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
  ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: var(--bg-primary); } ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .mono { font-family: 'JetBrains Mono', monospace; }
  input, textarea, select { font-family: 'DM Sans', sans-serif; background: var(--bg-secondary); border: 1px solid var(--border); color: var(--text-primary); padding: 8px 12px; border-radius: 6px; font-size: 13px; outline: none; width: 100%; transition: border-color 0.2s; }
  input:focus, textarea:focus, select:focus { border-color: var(--accent-amber); }
  textarea { resize: vertical; min-height: 80px; } select { cursor: pointer; }
  button { font-family: 'DM Sans', sans-serif; cursor: pointer; border: none; border-radius: 6px; font-size: 13px; font-weight: 500; padding: 8px 16px; transition: all 0.2s; }
  .btn-primary { background: var(--accent-amber); color: #000; } .btn-primary:hover { background: #fbbf24; }
  .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); } .btn-secondary:hover { background: var(--bg-hover); }
  .btn-danger { background: var(--accent-red-dim); color: var(--accent-red); } .btn-danger:hover { background: #991b1b; }
  .btn-green { background: var(--accent-green-dim); color: var(--accent-green); } .btn-green:hover { background: #047857; }
  .btn-blue { background: var(--accent-blue-dim); color: var(--accent-blue); } .btn-blue:hover { background: #1e40af; }
  .btn-small { padding: 4px 10px; font-size: 12px; } .btn-xs { padding: 2px 8px; font-size: 11px; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-family: 'JetBrains Mono', monospace; }
  .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
  .modal { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 24px; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; }
  .modal h3 { font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--accent-amber); font-family: 'JetBrains Mono', monospace; text-transform: uppercase; letter-spacing: 1px; }
  .form-group { margin-bottom: 12px; }
  .form-group label { display: block; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 4px; font-family: 'JetBrains Mono', monospace; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .fade-in { animation: fadeIn 0.3s ease; }
  .section-header { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; font-family: 'JetBrains Mono', monospace; }
  .contact-card { padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border); }
  .contact-card:hover { border-color: var(--border-light); }
  .call-log-entry { padding: 8px 10px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 6px; font-size: 12px; border-left: 3px solid var(--accent-green); }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;
const STORAGE_KEY = 'recon_data';
function loadData() { try { const r = localStorage.getItem(STORAGE_KEY); if (r) { const p = JSON.parse(r); if (p.companies?.length > 0) return p; } } catch(e) {} return null; }
async function loadSeedData() { try { const r = await fetch('./data.json'); if (r.ok) { const d = await r.json(); d.callLog = d.callLog || []; saveData(d); return d; } } catch(e) {} return { companies: [], tasks: [], trackRecord: '', callLog: [], settings: { apiKey: '' } }; }
function saveData(d) { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); } catch(e) {} }
function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
function today() { return new Date().toISOString().split('T')[0]; }
function futureDate(n) { const d = new Date(); d.setDate(d.getDate()+n); return d.toISOString().split('T')[0]; }
function fmt(d) { if(!d) return '—'; try { return new Date(d).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}); } catch { return d; } }
function isOD(d) { return d && d < today(); }
function isToday(d) { return d === today(); }
function isSoon(d) { if(!d) return false; const diff = (new Date(d)-new Date(today()))/864e5; return diff>=0 && diff<=2; }

const STATUSES = [
  {v:'prospect',l:'Prospect',c:'var(--status-prospect)'},{v:'contacted',l:'Contacted',c:'var(--status-contacted)'},
  {v:'engaged',l:'Engaged',c:'var(--status-engaged)'},{v:'proposal',l:'Proposal',c:'var(--status-proposal)'},
  {v:'won',l:'Won',c:'var(--status-won)'},{v:'lost',l:'Lost',c:'var(--status-lost)'},{v:'dormant',l:'Dormant',c:'var(--status-dormant)'}
];
const CATS = [
  {v:'management',l:'General Management',s:'MGMT',d:'MD, Director, CEO, COO',c:'var(--accent-amber)'},
  {v:'engineering',l:'Engineering Leadership',s:'ENG',d:'CTO, Eng Director, Tech Lead',c:'var(--accent-blue)'},
  {v:'hr',l:'HR / Recruitment',s:'HR',d:'HR Director, Talent, Recruitment',c:'var(--accent-purple)'}
];

async function callAI(key, sys, usr) {
  if (!key) throw new Error('No API key. Go to Settings.');
  const r = await fetch('https://api.anthropic.com/v1/messages', {
    method:'POST', headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
    body: JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1500,system:sys,messages:[{role:'user',content:usr}]})
  });
  if (!r.ok) { const e = await r.json().catch(()=>({})); throw new Error(e.error?.message||`API ${r.status}`); }
  return (await r.json()).content.map(b=>b.text||'').join('');
}

function StatusBadge({status}) { const s = STATUSES.find(x=>x.v===status)||STATUSES[0]; return <span className="badge" style={{color:s.c,background:s.c+'18',border:`1px solid ${s.c}33`}}>{s.l}</span>; }

// ─── SIDEBAR ───
function Sidebar({view, setView, actionCount}) {
  const items = [{id:'actions',icon:'⚡',label:'Daily Actions',badge:actionCount},{id:'companies',icon:'◆',label:'Companies'},{id:'tasks',icon:'◇',label:'Tasks'},{id:'trackrecord',icon:'◎',label:'Track Record'},{id:'settings',icon:'⚙',label:'Settings'}];
  return (
    <nav style={{width:220,minHeight:'100vh',background:'var(--bg-secondary)',borderRight:'1px solid var(--border)',display:'flex',flexDirection:'column',position:'fixed',top:0,left:0,zIndex:100}}>
      <div style={{padding:'20px 16px',borderBottom:'1px solid var(--border)'}}>
        <div className="mono" style={{fontSize:20,fontWeight:700,color:'var(--accent-amber)',letterSpacing:3}}>▣ RECON</div>
        <div className="mono" style={{fontSize:10,color:'var(--text-muted)',marginTop:2,letterSpacing:1}}>BANNER LANE</div>
      </div>
      <div style={{padding:'12px 8px',flex:1}}>
        {items.map(it=>(
          <div key={it.id} onClick={()=>setView(it.id)} style={{display:'flex',alignItems:'center',gap:10,padding:'10px 12px',borderRadius:8,cursor:'pointer',marginBottom:2,background:view===it.id?'var(--bg-hover)':'transparent',color:view===it.id?'var(--accent-amber)':'var(--text-secondary)',fontSize:13,fontWeight:view===it.id?600:400,borderLeft:view===it.id?'2px solid var(--accent-amber)':'2px solid transparent',transition:'all 0.15s'}}>
            <span style={{fontSize:14,width:20,textAlign:'center'}}>{it.icon}</span>{it.label}
            {it.badge>0&&<span style={{marginLeft:'auto',background:'var(--accent-red)',color:'#fff',borderRadius:10,padding:'1px 7px',fontSize:10,fontWeight:700}}>{it.badge}</span>}
          </div>
        ))}
      </div>
      <div className="mono" style={{padding:'12px 16px',borderTop:'1px solid var(--border)',fontSize:10,color:'var(--text-muted)'}}>v2.0</div>
    </nav>
  );
}

// ─── EMAIL MODAL ───
function EmailModal({contact, company, data, onClose, onSent, taskId}) {
  const [draft, setDraft] = useState('');
  const [loading, setLoading] = useState(true);
  useEffect(()=>{
    (async()=>{
      try {
        const news = company.aiNews ? `\nRecent intel: ${company.aiNews.slice(0,500)}` : '';
        const catPrompt = contact.category==='management'?'senior leadership — focus on strategic talent partnerships':contact.category==='engineering'?'engineering leadership — focus on finding niche technical talent':'HR/recruitment — focus on partnering to fill hard-to-find cleared/niche roles';
        const d = await callAI(data.settings.apiKey,
          `You write professional BD emails for Banner Lane, a specialist defence/aerospace recruitment consultancy. Track record:\n\n${data.trackRecord||'Defence sector recruitment specialist'}\n\nWrite concise, warm, professional outreach. Reference something about their company or sector. Under 180 words. No placeholder brackets. Clear CTA (brief call). Sign off from Banner Lane.`,
          `Email to: ${contact.name} (${contact.role}) at ${company.name}.\nSector: ${company.sector}, Country: ${company.country}.\nTheir category: ${catPrompt}.\nCompany notes: ${company.notes||'Defence sector company'}.${news}`
        );
        setDraft(d);
      } catch(e) { setDraft('Error: '+e.message); }
      setLoading(false);
    })();
  },[]);

  async function regen() {
    setLoading(true); setDraft('');
    try {
      const news = company.aiNews ? `\nRecent intel: ${company.aiNews.slice(0,500)}` : '';
      const d = await callAI(data.settings.apiKey,
        `You write professional BD emails for Banner Lane, defence/aerospace recruitment. Track record:\n${data.trackRecord||'Specialist'}\nWrite a DIFFERENT version. Under 180 words. No placeholders.`,
        `New version email to ${contact.name} (${contact.role}) at ${company.name}. ${company.sector}, ${company.country}. Notes: ${company.notes||''}.${news}`
      );
      setDraft(d);
    } catch(e) { setDraft('Error: '+e.message); }
    setLoading(false);
  }

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" style={{maxWidth:680}} onClick={e=>e.stopPropagation()}>
        <h3>✉ Email to {contact.name}</h3>
        <div style={{fontSize:12,color:'var(--text-muted)',marginBottom:12}}>
          {contact.role} at {company.name} · <span className="mono">{contact.email}</span>
        </div>
        {loading ? (
          <div style={{padding:40,textAlign:'center'}}><div className="mono" style={{color:'var(--text-muted)'}}>Generating personalised email...</div></div>
        ) : (<>
          <textarea value={draft} onChange={e=>setDraft(e.target.value)} style={{minHeight:260,fontSize:13,lineHeight:1.7}} />
          <div style={{display:'flex',gap:8,marginTop:16,justifyContent:'space-between',flexWrap:'wrap'}}>
            <button className="btn-secondary" onClick={regen}>↻ Regenerate</button>
            <div style={{display:'flex',gap:8}}>
              <button className="btn-secondary" onClick={()=>{navigator.clipboard.writeText(draft);alert('Copied!')}}>Copy Only</button>
              <button className="btn-primary" onClick={()=>{navigator.clipboard.writeText(draft);onSent(contact,taskId);}}>
                Copy & Mark Sent → Follow-up 4 days
              </button>
            </div>
          </div>
        </>)}
      </div>
    </div>
  );
}

// ─── CALL LOG MODAL ───
function CallLogModal({contact, company, data, onClose, onSave, taskId}) {
  const [outcome, setOutcome] = useState('no_answer');
  const [notes, setNotes] = useState('');
  const days = outcome==='spoke'?5:outcome==='voicemail'?3:2;
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={e=>e.stopPropagation()}>
        <h3>☎ Log Call — {contact.name}</h3>
        <div style={{fontSize:12,color:'var(--text-muted)',marginBottom:16}}>
          {contact.role} at {company.name}{contact.phone&&<span className="mono"> · {contact.phone}</span>}
        </div>
        <div className="form-group">
          <label>Outcome</label>
          <div style={{display:'flex',gap:8}}>
            {[{v:'spoke',l:'✓ Spoke',c:'btn-green'},{v:'voicemail',l:'✉ Voicemail',c:'btn-blue'},{v:'no_answer',l:'✗ No Answer',c:'btn-secondary'}].map(o=>(
              <button key={o.v} className={outcome===o.v?o.c:'btn-secondary'} style={{flex:1,border:outcome===o.v?'2px solid var(--accent-amber)':'1px solid var(--border)'}} onClick={()=>setOutcome(o.v)}>{o.l}</button>
            ))}
          </div>
        </div>
        <div className="form-group"><label>Notes</label><textarea value={notes} onChange={e=>setNotes(e.target.value)} placeholder="Key points, next steps, who to speak to..." style={{minHeight:100}} /></div>
        <div className="mono" style={{fontSize:11,color:'var(--text-muted)',marginBottom:12}}>Follow-up created in {days} days</div>
        <div style={{display:'flex',gap:8,justifyContent:'flex-end'}}>
          <button className="btn-secondary" onClick={onClose}>Cancel</button>
          <button className="btn-primary" onClick={()=>onSave(contact,outcome,notes,taskId)}>Save & Create Follow-up</button>
        </div>
      </div>
    </div>
  );
}

// ─── DAILY ACTIONS ───
function DailyActions({data,setData,setView,setSelectedCompany}) {
  const [emailM, setEmailM] = useState(null);
  const [callM, setCallM] = useState(null);

  const open = data.tasks.filter(t=>!t.completed).sort((a,b)=>new Date(a.dueDate)-new Date(b.dueDate));
  const overdue = open.filter(t=>isOD(t.dueDate));
  const todayT = open.filter(t=>isToday(t.dueDate));
  const upcoming = open.filter(t=>!isOD(t.dueDate)&&!isToday(t.dueDate)&&isSoon(t.dueDate));

  function handleEmailSent(contact, taskId) {
    const co = data.companies.find(c=>c.contacts?.some(ct=>ct.id===contact.id));
    if (!co) return;
    const uCo = data.companies.map(c=>{
      if(c.id!==co.id) return c;
      return {...c,status:c.status==='prospect'?'contacted':c.status,updatedAt:new Date().toISOString(),
        contacts:c.contacts.map(ct=>ct.id===contact.id?{...ct,contacted:true,contactMethod:'email',contactDate:today(),lastContactDate:today()}:ct)};
    });
    let uTasks = taskId ? data.tasks.map(t=>t.id===taskId?{...t,completed:true,completedDate:new Date().toISOString()}:t) : [...data.tasks];
    uTasks.push({id:genId(),companyId:co.id,contactId:contact.id,type:'followup',description:`Follow up with ${contact.name} at ${co.name} (email sent ${today()})`,dueDate:futureDate(4),completed:false,createdAt:new Date().toISOString()});
    setData({...data,companies:uCo,tasks:uTasks}); saveData({...data,companies:uCo,tasks:uTasks}); setEmailM(null);
  }

  function handleCallSave(contact, outcome, notes, taskId) {
    const co = data.companies.find(c=>c.contacts?.some(ct=>ct.id===contact.id));
    if (!co) return;
    const log = {id:genId(),companyId:co.id,contactId:contact.id,contactName:contact.name,companyName:co.name,outcome,notes,date:new Date().toISOString()};
    const uCo = data.companies.map(c=>{
      if(c.id!==co.id) return c;
      return {...c,status:c.status==='prospect'?'contacted':c.status,updatedAt:new Date().toISOString(),
        contacts:c.contacts.map(ct=>ct.id===contact.id?{...ct,contacted:true,contactMethod:'call',contactDate:today(),lastContactDate:today(),lastCallOutcome:outcome,lastCallNotes:notes}:ct)};
    });
    const days = outcome==='spoke'?5:outcome==='voicemail'?3:2;
    const desc = outcome==='spoke'?`Follow up after call with ${contact.name} at ${co.name}`:`Re-call ${contact.name} at ${co.name} (${outcome} ${today()})`;
    let uTasks = taskId ? data.tasks.map(t=>t.id===taskId?{...t,completed:true,completedDate:new Date().toISOString()}:t) : [...data.tasks];
    uTasks.push({id:genId(),companyId:co.id,contactId:contact.id,type:outcome==='spoke'?'followup':'call',description:desc,dueDate:futureDate(days),completed:false,createdAt:new Date().toISOString()});
    const ud = {...data,companies:uCo,tasks:uTasks,callLog:[...(data.callLog||[]),log]};
    setData(ud); saveData(ud); setCallM(null);
  }

  function completeTask(id) {
    const ud = {...data,tasks:data.tasks.map(t=>t.id===id?{...t,completed:true,completedDate:new Date().toISOString()}:t)};
    setData(ud); saveData(ud);
  }

  function TaskRow({task}) {
    const co = data.companies.find(c=>c.id===task.companyId);
    const ct = co?.contacts?.find(c=>c.id===task.contactId);
    return (
      <div style={{display:'flex',alignItems:'center',gap:10,padding:'12px 16px',borderBottom:'1px solid var(--border)',transition:'background 0.15s'}}
        onMouseEnter={e=>e.currentTarget.style.background='var(--bg-hover)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}>
        <span style={{fontSize:16,color:task.type==='call'?'var(--accent-green)':task.type==='email'?'var(--accent-blue)':'var(--accent-purple)',width:24,textAlign:'center'}}>
          {task.type==='call'?'☎':task.type==='email'?'✉':'◇'}
        </span>
        <div style={{flex:1,minWidth:0}}>
          <div style={{fontSize:13,fontWeight:500}}>{task.description}</div>
          <div style={{fontSize:11,color:'var(--text-muted)',marginTop:2}}>
            {co&&<span onClick={()=>{setSelectedCompany(co.id);setView('companyDetail')}} style={{cursor:'pointer',color:'var(--accent-amber)'}}>{co.name}</span>}
            {ct&&<span> · {ct.name}{ct.phone&&<span className="mono" style={{marginLeft:6,color:'var(--text-muted)'}}>{ct.phone}</span>}</span>}
          </div>
        </div>
        <span className="mono" style={{fontSize:11,color:isOD(task.dueDate)?'var(--accent-red)':isToday(task.dueDate)?'var(--accent-amber)':'var(--text-muted)',whiteSpace:'nowrap'}}>
          {isOD(task.dueDate)?'OVERDUE':isToday(task.dueDate)?'TODAY':fmt(task.dueDate)}
        </span>
        <div style={{display:'flex',gap:4}}>
          {ct?.email&&<button className="btn-blue btn-xs" onClick={()=>setEmailM({contact:ct,company:co,taskId:task.id})}>✉ Email</button>}
          {ct&&<button className="btn-green btn-xs" onClick={()=>setCallM({contact:ct,company:co,taskId:task.id})}>☎ Call</button>}
          <button className="btn-secondary btn-xs" onClick={()=>completeTask(task.id)}>✓</button>
        </div>
      </div>
    );
  }

  return (
    <div className="fade-in">
      <h2 style={{fontSize:22,fontWeight:300,marginBottom:4}}><span style={{color:'var(--accent-amber)'}} className="mono">⚡</span> Daily Actions</h2>
      <p style={{color:'var(--text-muted)',fontSize:13,marginBottom:24}}>{new Date().toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</p>

      {overdue.length>0&&(<div style={{marginBottom:20}}>
        <div className="section-header" style={{color:'var(--accent-red)'}}>⚠ OVERDUE ({overdue.length})</div>
        <div style={{background:'var(--bg-card)',border:'1px solid var(--accent-red)33',borderRadius:10,overflow:'hidden'}}>{overdue.map(t=><TaskRow key={t.id} task={t}/>)}</div>
      </div>)}

      <div style={{marginBottom:20}}>
        <div className="section-header" style={{color:'var(--accent-amber)'}}>TODAY ({todayT.length})</div>
        <div style={{background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:10,overflow:'hidden'}}>
          {todayT.length===0&&<div style={{padding:20,textAlign:'center',color:'var(--text-muted)',fontSize:13}}>No tasks today — time to prospect!</div>}
          {todayT.map(t=><TaskRow key={t.id} task={t}/>)}
        </div>
      </div>

      {upcoming.length>0&&(<div style={{marginBottom:20}}>
        <div className="section-header" style={{color:'var(--text-secondary)'}}>COMING UP ({upcoming.length})</div>
        <div style={{background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:10,overflow:'hidden'}}>{upcoming.map(t=><TaskRow key={t.id} task={t}/>)}</div>
      </div>)}

      <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12}}>
        {[{l:'Companies',v:data.companies.length,c:'var(--accent-amber)'},{l:'Contacts',v:data.companies.reduce((a,c)=>a+(c.contacts?.length||0),0),c:'var(--accent-blue)'},{l:'Open Tasks',v:open.length,c:'var(--accent-purple)'},{l:'Calls Logged',v:(data.callLog||[]).length,c:'var(--accent-green)'}].map((s,i)=>(
          <div key={i} style={{background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:10,padding:16,borderTop:`2px solid ${s.c}`}}>
            <div className="mono" style={{fontSize:22,fontWeight:700,color:s.c}}>{s.v}</div>
            <div className="mono" style={{fontSize:10,color:'var(--text-muted)',letterSpacing:1,marginTop:2,textTransform:'uppercase'}}>{s.l}</div>
          </div>
        ))}
      </div>

      {emailM&&<EmailModal contact={emailM.contact} company={emailM.company} data={data} taskId={emailM.taskId} onClose={()=>setEmailM(null)} onSent={handleEmailSent}/>}
      {callM&&<CallLogModal contact={callM.contact} company={callM.company} data={data} taskId={callM.taskId} onClose={()=>setCallM(null)} onSave={handleCallSave}/>}
    </div>
  );
}

// ─── COMPANY LIST ───
function CompanyList({data,setData,setView,setSelectedCompany}) {
  const [showAdd,setShowAdd]=useState(false);
  const [search,setSearch]=useState('');
  const [fStatus,setFStatus]=useState('');
  const [fCountry,setFCountry]=useState('');
  const [page,setPage]=useState(0);
  const PS=50;
  const [form,setForm]=useState({name:'',sector:'Defence',country:'UK',status:'prospect',notes:''});
  const countries=[...new Set(data.companies.map(c=>c.country))].sort();
  const cc={}; data.companies.forEach(c=>{cc[c.country]=(cc[c.country]||0)+1;});

  function addCo(){if(!form.name.trim())return;const n={id:genId(),...form,contacts:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),aiNews:''};const u={...data,companies:[...data.companies,n]};setData(u);saveData(u);setForm({name:'',sector:'Defence',country:'UK',status:'prospect',notes:''});setShowAdd(false);}
  function delCo(id){if(!confirm('Delete company?'))return;const u={...data,companies:data.companies.filter(c=>c.id!==id),tasks:data.tasks.filter(t=>t.companyId!==id)};setData(u);saveData(u);}

  const filtered=data.companies.filter(c=>{if(search&&!c.name.toLowerCase().includes(search.toLowerCase()))return false;if(fStatus&&c.status!==fStatus)return false;if(fCountry&&c.country!==fCountry)return false;return true;});
  const tp=Math.ceil(filtered.length/PS);const paged=filtered.slice(page*PS,(page+1)*PS);
  useEffect(()=>{setPage(0);},[search,fStatus,fCountry]);

  return (
    <div className="fade-in">
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:24}}>
        <h2 style={{fontSize:22,fontWeight:300}}><span style={{color:'var(--accent-amber)'}} className="mono">◆</span> Companies <span className="mono" style={{fontSize:13,color:'var(--text-muted)',marginLeft:8}}>{data.companies.length}</span></h2>
        <button className="btn-primary" onClick={()=>setShowAdd(true)}>+ Add Company</button>
      </div>
      <div style={{display:'flex',gap:12,marginBottom:12,flexWrap:'wrap'}}>
        <input placeholder="Search..." value={search} onChange={e=>setSearch(e.target.value)} style={{maxWidth:280}} />
        <select value={fCountry} onChange={e=>setFCountry(e.target.value)} style={{maxWidth:160}}><option value="">All Countries</option>{countries.map(c=><option key={c} value={c}>{c} ({cc[c]})</option>)}</select>
        <select value={fStatus} onChange={e=>setFStatus(e.target.value)} style={{maxWidth:160}}><option value="">All Statuses</option>{STATUSES.map(s=><option key={s.v} value={s.v}>{s.l}</option>)}</select>
        <span className="mono" style={{fontSize:12,color:'var(--text-muted)',alignSelf:'center'}}>{filtered.length} results</span>
      </div>
      <div style={{display:'flex',gap:6,marginBottom:16,flexWrap:'wrap'}}>
        {countries.map(c=><button key={c} className={fCountry===c?'btn-primary':'btn-secondary'} style={{padding:'3px 10px',fontSize:11}} onClick={()=>setFCountry(fCountry===c?'':c)}>{c} ({cc[c]})</button>)}
      </div>
      <div style={{background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:10,overflow:'hidden'}}>
        <div style={{display:'grid',gridTemplateColumns:'2fr 80px 1fr 80px 60px',padding:'10px 16px',background:'var(--bg-tertiary)',fontSize:10,fontWeight:600,textTransform:'uppercase',letterSpacing:1,color:'var(--text-muted)'}} className="mono">
          <span>Company</span><span>Country</span><span>Status</span><span>Contacts</span><span></span>
        </div>
        {paged.length===0&&<div style={{padding:32,textAlign:'center',color:'var(--text-muted)',fontSize:13}}>No matches</div>}
        {paged.map(c=>(
          <div key={c.id} style={{display:'grid',gridTemplateColumns:'2fr 80px 1fr 80px 60px',padding:'10px 16px',borderBottom:'1px solid var(--border)',cursor:'pointer',alignItems:'center',transition:'background 0.15s'}}
            onMouseEnter={e=>e.currentTarget.style.background='var(--bg-hover)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}
            onClick={()=>{setSelectedCompany(c.id);setView('companyDetail')}}>
            <div><span style={{fontWeight:500}}>{c.name}</span>{(c.contacts?.length||0)>0&&<span style={{fontSize:10,color:'var(--text-muted)',marginLeft:8}}>{c.contacts.filter(ct=>ct.contacted).length}/{c.contacts.length}</span>}</div>
            <span className="mono" style={{fontSize:11,color:'var(--text-muted)'}}>{c.country}</span>
            <StatusBadge status={c.status}/>
            <span className="mono" style={{fontSize:12,color:'var(--text-secondary)'}}>{c.contacts?.length||0}</span>
            <button className="btn-danger btn-xs" onClick={e=>{e.stopPropagation();delCo(c.id)}}>✕</button>
          </div>
        ))}
      </div>
      {tp>1&&<div style={{display:'flex',alignItems:'center',justifyContent:'center',gap:8,marginTop:16}}>
        <button className="btn-secondary btn-small" disabled={page===0} onClick={()=>setPage(p=>p-1)}>←</button>
        <span className="mono" style={{fontSize:12,color:'var(--text-muted)'}}>Page {page+1}/{tp}</span>
        <button className="btn-secondary btn-small" disabled={page>=tp-1} onClick={()=>setPage(p=>p+1)}>→</button>
      </div>}
      {showAdd&&<div className="modal-overlay" onClick={()=>setShowAdd(false)}><div className="modal" onClick={e=>e.stopPropagation()}>
        <h3>Add Company</h3>
        <div className="form-group"><label>Name</label><input value={form.name} onChange={e=>setForm({...form,name:e.target.value})} autoFocus/></div>
        <div className="form-row"><div className="form-group"><label>Sector</label><input value={form.sector} onChange={e=>setForm({...form,sector:e.target.value})}/></div><div className="form-group"><label>Country</label><input value={form.country} onChange={e=>setForm({...form,country:e.target.value})}/></div></div>
        <div className="form-group"><label>Status</label><select value={form.status} onChange={e=>setForm({...form,status:e.target.value})}>{STATUSES.map(s=><option key={s.v} value={s.v}>{s.l}</option>)}</select></div>
        <div className="form-group"><label>Notes</label><textarea value={form.notes} onChange={e=>setForm({...form,notes:e.target.value})}/></div>
        <div style={{display:'flex',gap:8,marginTop:16,justifyContent:'flex-end'}}><button className="btn-secondary" onClick={()=>setShowAdd(false)}>Cancel</button><button className="btn-primary" onClick={addCo}>Add</button></div>
      </div></div>}
    </div>
  );
}

// ─── COMPANY DETAIL ───
function CompanyDetail({companyId,data,setData,setView}) {
  const company=data.companies.find(c=>c.id===companyId);
  const [showAddCt,setShowAddCt]=useState(false);
  const [emailM,setEmailM]=useState(null);
  const [callM,setCallM]=useState(null);
  const [newsLoad,setNewsLoad]=useState(false);
  const [ctForm,setCtForm]=useState({name:'',role:'',category:'management',email:'',phone:'',linkedin:'',notes:''});

  if(!company) return <div style={{color:'var(--text-muted)'}}>Not found</div>;

  function upCo(u){const ud={...data,companies:data.companies.map(c=>c.id===companyId?{...c,...u,updatedAt:new Date().toISOString()}:c)};setData(ud);saveData(ud);}
  function upCt(cid,u){upCo({contacts:company.contacts.map(c=>c.id===cid?{...c,...u}:c)});}
  function delCt(cid){if(!confirm('Delete?'))return;upCo({contacts:company.contacts.filter(c=>c.id!==cid)});}
  function addCt(){if(!ctForm.name.trim())return;upCo({contacts:[...(company.contacts||[]),{id:genId(),...ctForm,contacted:false,contactMethod:'',contactDate:'',lastContactDate:''}]});setCtForm({name:'',role:'',category:'management',email:'',phone:'',linkedin:'',notes:''});setShowAddCt(false);}

  function handleEmailSent(contact){
    upCt(contact.id,{contacted:true,contactMethod:'email',contactDate:today(),lastContactDate:today()});
    if(company.status==='prospect')upCo({status:'contacted'});
    const ud={...data,tasks:[...data.tasks,{id:genId(),companyId:company.id,contactId:contact.id,type:'followup',description:`Follow up with ${contact.name} at ${company.name} (email ${today()})`,dueDate:futureDate(4),completed:false,createdAt:new Date().toISOString()}]};
    setData(ud);saveData(ud);setEmailM(null);
  }

  function handleCallSave(contact,outcome,notes){
    const log={id:genId(),companyId:company.id,contactId:contact.id,contactName:contact.name,companyName:company.name,outcome,notes,date:new Date().toISOString()};
    upCt(contact.id,{contacted:true,contactMethod:'call',contactDate:today(),lastContactDate:today(),lastCallOutcome:outcome,lastCallNotes:notes});
    if(company.status==='prospect')upCo({status:'contacted'});
    const days=outcome==='spoke'?5:outcome==='voicemail'?3:2;
    const ud={...data,tasks:[...data.tasks,{id:genId(),companyId:company.id,contactId:contact.id,type:outcome==='spoke'?'followup':'call',description:outcome==='spoke'?`Follow up after call with ${contact.name}`:`Re-call ${contact.name} (${outcome} ${today()})`,dueDate:futureDate(days),completed:false,createdAt:new Date().toISOString()}],callLog:[...(data.callLog||[]),log]};
    setData(ud);saveData(ud);setCallM(null);
  }

  async function fetchNews(){
    setNewsLoad(true);
    try{const n=await callAI(data.settings.apiKey,'Defence industry analyst. Brief company intel. Bullet points. Focus: contracts, leadership, M&A, hiring.',`Intel on ${company.name} (${company.sector}, ${company.country}). Notes: ${company.notes||'Defence company'}. 5-8 bullets.`);upCo({aiNews:n,newsDate:new Date().toISOString()});}catch(e){alert(e.message);}
    setNewsLoad(false);
  }

  const coTasks=data.tasks.filter(t=>t.companyId===companyId&&!t.completed);
  const coLogs=(data.callLog||[]).filter(l=>l.companyId===companyId).sort((a,b)=>new Date(b.date)-new Date(a.date));

  return (
    <div className="fade-in">
      <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:8}}>
        <button className="btn-secondary btn-small" onClick={()=>setView('companies')}>← Back</button>
        <h2 style={{fontSize:22,fontWeight:300,flex:1}}>{company.name}</h2>
        <select value={company.status} onChange={e=>upCo({status:e.target.value})} style={{maxWidth:140,fontSize:12}}>{STATUSES.map(s=><option key={s.v} value={s.v}>{s.l}</option>)}</select>
        <StatusBadge status={company.status}/>
      </div>
      <div className="mono" style={{fontSize:11,color:'var(--text-muted)',marginBottom:24}}>{company.sector} · {company.country}</div>

      <div style={{display:'grid',gridTemplateColumns:'5fr 3fr',gap:20}}>
        <div>
          <div style={{background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:10,padding:16,marginBottom:16}}>
            <div className="section-header" style={{color:'var(--accent-amber)'}}>NOTES</div>
            <textarea value={company.notes||''} onChange={e=>upCo({notes:e.target.value})} placeholder="Company notes..." style={{minHeight:50,fontSize:13}}/>
          </div>

          {CATS.map(cat=>{
            const cts=(company.contacts||[]).filter(c=>c.category===cat.v);
            return (<div key={cat.v} style={{background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:10,padding:16,marginBottom:16}}>
              <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}}>
                <div><div className="section-header" style={{color:cat.c,marginBottom:2}}>{cat.l.toUpperCase()}</div><div style={{fontSize:10,color:'var(--text-muted)'}}>{cat.d}</div></div>
                <button className="btn-secondary btn-small" onClick={()=>{setCtForm({...ctForm,category:cat.v});setShowAddCt(true)}}>+ Add</button>
              </div>
              {cts.length===0&&<div style={{color:'var(--text-muted)',fontSize:12,fontStyle:'italic'}}>No contacts — add from LinkedIn</div>}
              {cts.map(ct=>(<div key={ct.id} className="contact-card">
                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:4}}>
                  <span style={{fontWeight:600,fontSize:14}}>{ct.name}</span>
                  <span style={{fontSize:12,color:'var(--text-muted)'}}>{ct.role}</span>
                  <span style={{flex:1}}/>
                  {ct.contacted?<span className="badge" style={{color:'var(--accent-green)',background:'var(--accent-green)18'}}>CONTACTED</span>:<span className="badge" style={{color:'var(--text-muted)',background:'var(--bg-tertiary)'}}>NOT CONTACTED</span>}
                </div>
                <div style={{display:'flex',gap:16,fontSize:12,color:'var(--text-secondary)',marginBottom:4,flexWrap:'wrap'}}>
                  {ct.email&&<span className="mono">✉ {ct.email}</span>}
                  {ct.phone&&<span className="mono">☎ {ct.phone}</span>}
                  {ct.linkedin&&<a href={ct.linkedin.startsWith('http')?ct.linkedin:'https://'+ct.linkedin} target="_blank" style={{color:'var(--accent-blue)',textDecoration:'none'}}>LinkedIn ↗</a>}
                </div>
                {ct.lastContactDate&&<div className="mono" style={{fontSize:10,color:'var(--text-muted)',marginBottom:4}}>Last: {ct.contactMethod} on {fmt(ct.lastContactDate)}{ct.lastCallOutcome&&` (${ct.lastCallOutcome})`}</div>}
                {ct.notes&&<div style={{fontSize:12,color:'var(--text-secondary)',marginBottom:4}}>{ct.notes}</div>}
                {ct.lastCallNotes&&<div style={{fontSize:11,color:'var(--text-muted)',marginBottom:6,padding:'4px 8px',background:'var(--bg-tertiary)',borderRadius:4,borderLeft:'2px solid var(--accent-green)'}}>Call: {ct.lastCallNotes}</div>}
                <div style={{display:'flex',gap:6,flexWrap:'wrap',marginTop:6}}>
                  {ct.email&&<button className="btn-blue btn-xs" onClick={()=>setEmailM(ct)}>✉ AI Email</button>}
                  <button className="btn-green btn-xs" onClick={()=>setCallM(ct)}>☎ Log Call</button>
                  {ct.contacted&&<button className="btn-secondary btn-xs" onClick={()=>upCt(ct.id,{contacted:false,contactMethod:'',contactDate:'',lastContactDate:''})}>↩ Reset</button>}
                  <button className="btn-danger btn-xs" onClick={()=>delCt(ct.id)}>✕</button>
                </div>
              </div>))}
            </div>);
          })}
        </div>

        <div>
          <div style={{background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:10,padding:16,marginBottom:16}}>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}}>
              <div className="section-header" style={{color:'var(--accent-amber)',marginBottom:0}}>AI INTELLIGENCE</div>
              <button className="btn-secondary btn-xs" onClick={fetchNews} disabled={newsLoad}>{newsLoad?'...':'↻ Pull News'}</button>
            </div>
            {company.aiNews?(<div style={{fontSize:13,lineHeight:1.6,whiteSpace:'pre-wrap',color:'var(--text-secondary)'}}>{company.aiNews}{company.newsDate&&<div className="mono" style={{fontSize:10,color:'var(--text-muted)',marginTop:8}}>Updated: {fmt(company.newsDate)}</div>}</div>)
            :(<div style={{color:'var(--text-muted)',fontSize:12}}>Click "Pull News" for AI intelligence. This also personalises your outreach emails.</div>)}
          </div>
          <div style={{background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:10,padding:16,marginBottom:16}}>
            <div className="section-header" style={{color:'var(--accent-amber)'}}>OPEN TASKS ({coTasks.length})</div>
            {coTasks.length===0&&<div style={{color:'var(--text-muted)',fontSize:12}}>No tasks</div>}
            {coTasks.map(t=>(<div key={t.id} style={{padding:'6px 0',borderBottom:'1px solid var(--border)',display:'flex',alignItems:'center',gap:8,fontSize:12}}>
              <span style={{color:t.type==='call'?'var(--accent-green)':t.type==='email'?'var(--accent-blue)':'var(--accent-purple)'}}>{t.type==='call'?'☎':t.type==='email'?'✉':'◇'}</span>
              <span style={{flex:1,color:'var(--text-secondary)'}}>{t.description}</span>
              <span className="mono" style={{fontSize:10,color:isOD(t.dueDate)?'var(--accent-red)':'var(--text-muted)'}}>{t.dueDate}</span>
              <button className="btn-secondary btn-xs" onClick={()=>{const u={...data,tasks:data.tasks.map(x=>x.id===t.id?{...x,completed:true}:x)};setData(u);saveData(u);}}>✓</button>
            </div>))}
          </div>
          <div style={{background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:10,padding:16}}>
            <div className="section-header" style={{color:'var(--accent-green)'}}>CALL LOG ({coLogs.length})</div>
            {coLogs.length===0&&<div style={{color:'var(--text-muted)',fontSize:12}}>No calls logged</div>}
            {coLogs.slice(0,10).map(l=>(<div key={l.id} className="call-log-entry">
              <div style={{display:'flex',justifyContent:'space-between',marginBottom:2}}><span style={{fontWeight:500}}>{l.contactName}</span><span className="mono" style={{fontSize:10,color:'var(--text-muted)'}}>{fmt(l.date)}</span></div>
              <div><span style={{fontSize:10,fontWeight:600,color:l.outcome==='spoke'?'var(--accent-green)':l.outcome==='voicemail'?'var(--accent-blue)':'var(--text-muted)'}}>{l.outcome==='spoke'?'✓ Spoke':l.outcome==='voicemail'?'✉ VM':'✗ No ans'}</span>{l.notes&&<span style={{color:'var(--text-secondary)',marginLeft:8}}>{l.notes}</span>}</div>
            </div>))}
          </div>
        </div>
      </div>

      {showAddCt&&<div className="modal-overlay" onClick={()=>setShowAddCt(false)}><div className="modal" onClick={e=>e.stopPropagation()}>
        <h3>Add Decision Maker</h3>
        <p style={{fontSize:12,color:'var(--text-muted)',marginBottom:16}}>Paste details from LinkedIn</p>
        <div className="form-row"><div className="form-group"><label>Full Name</label><input value={ctForm.name} onChange={e=>setCtForm({...ctForm,name:e.target.value})} placeholder="John Smith" autoFocus/></div><div className="form-group"><label>Job Title</label><input value={ctForm.role} onChange={e=>setCtForm({...ctForm,role:e.target.value})} placeholder="Managing Director"/></div></div>
        <div className="form-group"><label>Category</label><select value={ctForm.category} onChange={e=>setCtForm({...ctForm,category:e.target.value})}>{CATS.map(c=><option key={c.v} value={c.v}>{c.l} ({c.d})</option>)}</select></div>
        <div className="form-row-3"><div className="form-group"><label>Email</label><input value={ctForm.email} onChange={e=>setCtForm({...ctForm,email:e.target.value})} placeholder="name@co.com"/></div><div className="form-group"><label>Phone</label><input value={ctForm.phone} onChange={e=>setCtForm({...ctForm,phone:e.target.value})} placeholder="+44..."/></div><div className="form-group"><label>LinkedIn</label><input value={ctForm.linkedin} onChange={e=>setCtForm({...ctForm,linkedin:e.target.value})} placeholder="linkedin.com/in/..."/></div></div>
        <div className="form-group"><label>Notes</label><textarea value={ctForm.notes} onChange={e=>setCtForm({...ctForm,notes:e.target.value})} placeholder="Background, why relevant..." style={{minHeight:60}}/></div>
        <div style={{display:'flex',gap:8,marginTop:16,justifyContent:'flex-end'}}><button className="btn-secondary" onClick={()=>setShowAddCt(false)}>Cancel</button><button className="btn-primary" onClick={addCt}>Add Contact</button></div>
      </div></div>}

      {emailM&&<EmailModal contact={emailM} company={company} data={data} onClose={()=>setEmailM(null)} onSent={handleEmailSent}/>}
      {callM&&<CallLogModal contact={callM} company={company} data={data} onClose={()=>setCallM(null)} onSave={handleCallSave}/>}
    </div>
  );
}

// ─── TASKS ───
function TaskList({data,setData,setView,setSelectedCompany}) {
  const [filter,setFilter]=useState('open');
  const [showAdd,setShowAdd]=useState(false);
  const [form,setForm]=useState({companyId:'',type:'followup',description:'',dueDate:''});
  const tasks=data.tasks.filter(t=>{if(filter==='open')return !t.completed;if(filter==='completed')return t.completed;if(filter==='overdue')return !t.completed&&isOD(t.dueDate);if(filter==='calls')return !t.completed&&t.type==='call';if(filter==='emails')return !t.completed&&(t.type==='email'||t.type==='followup');return true;}).sort((a,b)=>{if(a.completed!==b.completed)return a.completed?1:-1;return new Date(a.dueDate)-new Date(b.dueDate);});

  return (
    <div className="fade-in">
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:24}}>
        <h2 style={{fontSize:22,fontWeight:300}}><span style={{color:'var(--accent-amber)'}} className="mono">◇</span> Tasks</h2>
        <button className="btn-primary" onClick={()=>setShowAdd(true)}>+ Add Task</button>
      </div>
      <div style={{display:'flex',gap:8,marginBottom:20,flexWrap:'wrap'}}>
        {['open','overdue','calls','emails','completed','all'].map(f=><button key={f} className={filter===f?'btn-primary':'btn-secondary'} style={{textTransform:'capitalize'}} onClick={()=>setFilter(f)}>{f}{f==='overdue'&&` (${data.tasks.filter(t=>!t.completed&&isOD(t.dueDate)).length})`}</button>)}
      </div>
      <div style={{background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:10}}>
        {tasks.length===0&&<div style={{padding:32,textAlign:'center',color:'var(--text-muted)',fontSize:13}}>No tasks</div>}
        {tasks.map(t=>{const co=data.companies.find(c=>c.id===t.companyId);return(
          <div key={t.id} style={{display:'flex',alignItems:'center',gap:12,padding:'10px 16px',borderBottom:'1px solid var(--border)',opacity:t.completed?0.5:1}}>
            <input type="checkbox" checked={t.completed} onChange={()=>{const u={...data,tasks:data.tasks.map(x=>x.id===t.id?{...x,completed:!x.completed}:x)};setData(u);saveData(u);}} style={{width:16,height:16,cursor:'pointer'}}/>
            <span style={{fontSize:16,color:t.type==='call'?'var(--accent-green)':t.type==='email'?'var(--accent-blue)':'var(--accent-purple)'}}>{t.type==='call'?'☎':t.type==='email'?'✉':'◇'}</span>
            {co&&<span className="badge" style={{cursor:'pointer',color:'var(--accent-amber)',background:'var(--accent-amber)18'}} onClick={()=>{setSelectedCompany(co.id);setView('companyDetail')}}>{co.name}</span>}
            <span style={{flex:1,fontSize:13,textDecoration:t.completed?'line-through':'none'}}>{t.description}</span>
            <span className="mono" style={{fontSize:11,color:isOD(t.dueDate)?'var(--accent-red)':'var(--text-muted)'}}>{t.dueDate}</span>
            <button className="btn-danger btn-xs" onClick={()=>{const u={...data,tasks:data.tasks.filter(x=>x.id!==t.id)};setData(u);saveData(u);}}>✕</button>
          </div>
        );})}
      </div>
      {showAdd&&<div className="modal-overlay" onClick={()=>setShowAdd(false)}><div className="modal" onClick={e=>e.stopPropagation()}>
        <h3>Add Task</h3>
        <div className="form-group"><label>Company</label><select value={form.companyId} onChange={e=>setForm({...form,companyId:e.target.value})}><option value="">— None —</option>{data.companies.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
        <div className="form-row"><div className="form-group"><label>Type</label><select value={form.type} onChange={e=>setForm({...form,type:e.target.value})}><option value="email">Email</option><option value="call">Call</option><option value="followup">Follow-up</option></select></div><div className="form-group"><label>Due Date</label><input type="date" value={form.dueDate} onChange={e=>setForm({...form,dueDate:e.target.value})}/></div></div>
        <div className="form-group"><label>Description</label><input value={form.description} onChange={e=>setForm({...form,description:e.target.value})} placeholder="What needs doing?"/></div>
        <div style={{display:'flex',gap:8,marginTop:16,justifyContent:'flex-end'}}><button className="btn-secondary" onClick={()=>setShowAdd(false)}>Cancel</button><button className="btn-primary" onClick={()=>{if(!form.description.trim()||!form.dueDate)return;const u={...data,tasks:[...data.tasks,{id:genId(),...form,completed:false,createdAt:new Date().toISOString()}]};setData(u);saveData(u);setForm({companyId:'',type:'followup',description:'',dueDate:''});setShowAdd(false)}}>Add</button></div>
      </div></div>}
    </div>
  );
}

// ─── TRACK RECORD ───
function TrackRecord({data,setData}) {
  const [saving,setSaving]=useState(false);
  return (
    <div className="fade-in">
      <h2 style={{fontSize:22,fontWeight:300,marginBottom:8}}><span style={{color:'var(--accent-amber)'}} className="mono">◎</span> Track Record</h2>
      <p style={{color:'var(--text-secondary)',fontSize:13,marginBottom:24,maxWidth:600}}>Your background and engagements. The AI uses this to personalise every outreach email.</p>
      <div style={{background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:10,padding:20}}>
        <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}}>
          <div className="section-header" style={{color:'var(--accent-amber)',marginBottom:0}}>YOUR BACKGROUND</div>
          {saving&&<span className="mono" style={{fontSize:11,color:'var(--accent-green)'}}>SAVED ✓</span>}
        </div>
        <textarea value={data.trackRecord||''} onChange={e=>{const u={...data,trackRecord:e.target.value};setData(u);saveData(u);setSaving(true);setTimeout(()=>setSaving(false),1000);}} style={{minHeight:400,fontSize:13,lineHeight:1.7}}/>
      </div>
    </div>
  );
}

// ─── SETTINGS ───
function Settings({data,setData}) {
  const [key,setKey]=useState(data.settings?.apiKey||'');
  const [saved,setSaved]=useState(false);
  return (
    <div className="fade-in" style={{maxWidth:560}}>
      <h2 style={{fontSize:22,fontWeight:300,marginBottom:24}}><span style={{color:'var(--accent-amber)'}} className="mono">⚙</span> Settings</h2>
      <div style={{background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:10,padding:20,marginBottom:20}}>
        <div className="section-header" style={{color:'var(--accent-amber)'}}>ANTHROPIC API KEY</div>
        <p style={{fontSize:12,color:'var(--text-muted)',marginBottom:12}}>For AI emails + company intel. Get at <a href="https://console.anthropic.com" target="_blank" style={{color:'var(--accent-amber)'}}>console.anthropic.com</a></p>
        <div style={{display:'flex',gap:8}}><input type="password" value={key} onChange={e=>setKey(e.target.value)} placeholder="sk-ant-..." style={{flex:1}}/><button className="btn-primary" onClick={()=>{const u={...data,settings:{...data.settings,apiKey:key}};setData(u);saveData(u);setSaved(true);setTimeout(()=>setSaved(false),2000);}}>Save</button></div>
        {saved&&<div className="mono" style={{fontSize:11,color:'var(--accent-green)',marginTop:8}}>SAVED ✓</div>}
      </div>
      <div style={{background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:10,padding:20}}>
        <div className="section-header" style={{color:'var(--accent-amber)'}}>DATA</div>
        <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
          <button className="btn-secondary" onClick={()=>{const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`recon-${today()}.json`;a.click();}}>↓ Export</button>
          <label className="btn-secondary" style={{display:'inline-flex',alignItems:'center',cursor:'pointer',padding:'8px 16px',borderRadius:6,border:'1px solid var(--border)',background:'var(--bg-tertiary)',fontSize:13}}>↑ Import<input type="file" accept=".json" onChange={e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.companies){d.callLog=d.callLog||[];setData(d);saveData(d);setKey(d.settings?.apiKey||'');alert('Done!');}else alert('Invalid');}catch{alert('Error');}};r.readAsText(f);}} style={{display:'none'}}/></label>
          <button className="btn-danger" onClick={()=>{if(confirm('Delete ALL?')&&confirm('Sure?')){const f={companies:[],tasks:[],trackRecord:'',callLog:[],settings:{apiKey:data.settings?.apiKey}};setData(f);saveData(f);}}}>⚠ Clear</button>
          <button className="btn-secondary" onClick={async()=>{if(confirm('Reset to seed? Contacts/tasks lost.')){localStorage.removeItem(STORAGE_KEY);const f=await loadSeedData();setData(f);setKey(f.settings?.apiKey||'');}}}>↺ Reset</button>
        </div>
      </div>
    </div>
  );
}

// ─── APP ───
function App() {
  const [data,setData]=useState(null);
  const [loading,setLoading]=useState(true);
  const [view,setView]=useState('actions');
  const [selCo,setSelCo]=useState(null);
  useEffect(()=>{const e=loadData();if(e){e.callLog=e.callLog||[];setData(e);setLoading(false);}else{loadSeedData().then(d=>{setData(d);setLoading(false);});}},[]);
  if(loading||!data) return <div style={{display:'flex',alignItems:'center',justifyContent:'center',height:'100vh',background:'var(--bg-primary)'}}><div style={{textAlign:'center'}}><div className="mono" style={{fontSize:24,color:'var(--accent-amber)',letterSpacing:4,marginBottom:12}}>▣ RECON</div><div style={{color:'var(--text-muted)',fontSize:13}}>Loading...</div></div></div>;
  const ac=data.tasks.filter(t=>!t.completed&&(isOD(t.dueDate)||isToday(t.dueDate)||isSoon(t.dueDate))).length;
  const rv=()=>{switch(view){case 'actions':return<DailyActions data={data} setData={setData} setView={setView} setSelectedCompany={setSelCo}/>;case 'companies':return<CompanyList data={data} setData={setData} setView={setView} setSelectedCompany={setSelCo}/>;case 'companyDetail':return<CompanyDetail companyId={selCo} data={data} setData={setData} setView={setView}/>;case 'tasks':return<TaskList data={data} setData={setData} setView={setView} setSelectedCompany={setSelCo}/>;case 'trackrecord':return<TrackRecord data={data} setData={setData}/>;case 'settings':return<Settings data={data} setData={setData}/>;default:return<DailyActions data={data} setData={setData} setView={setView} setSelectedCompany={setSelCo}/>;}}
  return <div style={{display:'flex',minHeight:'100vh'}}><Sidebar view={view} setView={setView} actionCount={ac}/><main style={{marginLeft:220,flex:1,padding:'32px 40px',maxWidth:1100}}>{rv()}</main></div>;
}
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
