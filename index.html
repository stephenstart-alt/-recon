<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RECON ‚Äî Defence Sector Prospecting</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg0:#0a0e17;--bg1:#111827;--bg2:#1a2235;--bgc:#151d2e;--bgh:#1e2a3f;--bd:#243049;--bdl:#2d3a52;--t1:#e8ecf4;--t2:#8b95a8;--tm:#5a6478;--amber:#f59e0b;--amberd:#92600a;--green:#10b981;--greend:#065f46;--red:#ef4444;--redd:#7f1d1d;--blue:#3b82f6;--blued:#1e3a5f;--purple:#8b5cf6;--sp:var(--amber);--sc:var(--blue);--se:var(--purple);--spr:#ec4899;--sw:var(--green);--sl:var(--red);--sd:#6b7280}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg0);color:var(--t1);min-height:100vh;overflow-x:hidden}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg0)}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}
.mono{font-family:'JetBrains Mono',monospace}
input,textarea,select{font-family:'DM Sans',sans-serif;background:var(--bg1);border:1px solid var(--bd);color:var(--t1);padding:8px 12px;border-radius:6px;font-size:13px;outline:none;width:100%;transition:border-color .2s}
input:focus,textarea:focus,select:focus{border-color:var(--amber)}
textarea{resize:vertical;min-height:80px}select{cursor:pointer}
button{font-family:'DM Sans',sans-serif;cursor:pointer;border:none;border-radius:6px;font-size:13px;font-weight:500;padding:8px 16px;transition:all .2s}
.bp{background:var(--amber);color:#000}.bp:hover{background:#fbbf24}
.bs{background:var(--bg2);color:var(--t1);border:1px solid var(--bd)}.bs:hover{background:var(--bgh)}
.bd{background:var(--redd);color:var(--red)}.bd:hover{background:#991b1b}
.bg{background:var(--greend);color:var(--green)}.bg:hover{background:#047857}
.bb{background:var(--blued);color:var(--blue)}.bb:hover{background:#1e40af}
.bpu{background:var(--purple)22;color:var(--purple);border:1px solid var(--purple)33}.bpu:hover{background:var(--purple)44}
.bsm{padding:4px 10px;font-size:12px}.bx{padding:2px 8px;font-size:11px}
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;font-family:'JetBrains Mono',monospace}
.mo{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px)}
.ml{background:var(--bg1);border:1px solid var(--bd);border-radius:12px;padding:24px;width:90%;max-width:600px;max-height:85vh;overflow-y:auto}
.ml h3{font-size:16px;font-weight:600;margin-bottom:16px;color:var(--amber);font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:1px}
.fg{margin-bottom:12px}.fg label{display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--t2);margin-bottom:4px;font-family:'JetBrains Mono',monospace}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:12px}.fr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
@keyframes fi{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}.fi{animation:fi .3s ease}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.sh{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;font-family:'JetBrains Mono',monospace}
.cc{padding:12px;background:var(--bg1);border-radius:8px;margin-bottom:8px;border:1px solid var(--bd)}.cc:hover{border-color:var(--bdl)}
.cl{padding:8px 10px;background:var(--bg2);border-radius:6px;margin-bottom:6px;font-size:12px;border-left:3px solid var(--green)}
.li-box{margin-top:10px;padding:12px;background:#1a1a2e;border:1px solid #2563eb44;border-radius:8px;border-left:3px solid var(--blue)}
.subj-row{display:flex;align-items:center;gap:8px;margin-bottom:12px;padding:10px 12px;background:var(--bg0);border:1px solid var(--bd);border-radius:8px}
.subj-row input{background:transparent;border:none;font-size:14px;font-weight:600;padding:0;flex:1}
.subj-row input:focus{border:none}
.progress-dots{display:flex;gap:3px;align-items:center}
.progress-dot{width:8px;height:8px;border-radius:50%;border:1.5px solid var(--bd)}
.progress-dot.filled{border-color:var(--green);background:var(--green)}
.progress-dot.partial{border-color:var(--amber);background:var(--amber)}
.queue-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;font-family:'JetBrains Mono',monospace;background:var(--blued);color:var(--blue);border:1px solid var(--blue)33}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-hdr{font-size:9px;text-align:center;color:var(--tm);padding:4px 0;font-family:'JetBrains Mono',monospace;font-weight:600}
.cal-day{aspect-ratio:1;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:10px;font-family:'JetBrains Mono',monospace;position:relative;cursor:default;transition:all .15s}
.cal-day:hover{transform:scale(1.15);z-index:2}
.cal-future{background:var(--bg2);color:var(--tm);opacity:.3}
.cal-noact{background:var(--bg2);color:var(--tm)}
.cal-partial{background:#92600a44;color:var(--amber);border:1px solid var(--amber)44}
.cal-full{background:var(--greend);color:var(--green);border:1px solid var(--green)44;font-weight:700}
.cal-today{outline:2px solid var(--amber);outline-offset:1px}
.target-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--bd)}
.target-row:last-child{border-bottom:none}
.target-bar{flex:1;height:6px;background:var(--bg2);border-radius:3px;overflow:hidden}
.target-fill{height:100%;border-radius:3px;transition:width .4s ease}
.recent-chip{display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--bg1);border:1px solid var(--bd);border-radius:8px;cursor:pointer;transition:all .15s;font-size:12px;white-space:nowrap}
.recent-chip:hover{border-color:var(--amber);background:var(--bgh)}
.save-bar{display:flex;align-items:center;gap:8px;padding:6px 12px;border-radius:6px;font-size:11px;font-family:'JetBrains Mono',monospace;cursor:pointer;transition:all .15s}
.save-bar:hover{background:var(--bgh)}
.restore-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:var(--bg0);gap:24px;text-align:center}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useRef,useCallback}=React;
const SK='recon_data',RK='recon_recent';

// ‚îÄ‚îÄ‚îÄ FILE-BASED PERSISTENCE ‚îÄ‚îÄ‚îÄ
// fileHandle is stored in module scope so it persists across re-renders
let _fileHandle=null;
let _saveTimeout=null;

async function writeToFile(data){
  if(!_fileHandle)return;
  try{
    const writable=await _fileHandle.createWritable();
    await writable.write(JSON.stringify(data,null,2));
    await writable.close();
    return true;
  }catch(e){console.error('File save failed:',e);_fileHandle=null;return false}
}

async function connectSaveFile(){
  try{
    _fileHandle=await window.showSaveFilePicker({
      suggestedName:'recon-data.json',
      types:[{description:'JSON',accept:{'application/json':['.json']}}]
    });
    return true;
  }catch(e){return false}
}

async function loadFromFile(){
  try{
    const [handle]=await window.showOpenFilePicker({
      types:[{description:'JSON',accept:{'application/json':['.json']}}]
    });
    const file=await handle.getFile();
    const text=await file.text();
    const data=JSON.parse(text);
    if(data.companies){
      data.callLog=data.callLog||[];data.activity=data.activity||{};
      _fileHandle=handle;
      return data;
    }
  }catch(e){}
  return null;
}

function ld(){try{const r=localStorage.getItem(SK);if(r){const p=JSON.parse(r);if(p.companies?.length>0)return p}}catch(e){}return null}
async function lds(){try{const r=await fetch('./data.json');if(r.ok){const d=await r.json();d.callLog=d.callLog||[];d.activity=d.activity||{};sv(d);return d}}catch(e){}return{companies:[],tasks:[],trackRecord:'',callLog:[],activity:{},settings:{apiKey:''}}}

function sv(d){
  // Always save to localStorage
  try{localStorage.setItem(SK,JSON.stringify(d))}catch(e){}
  // Debounced save to file (if connected)
  if(_fileHandle){
    clearTimeout(_saveTimeout);
    _saveTimeout=setTimeout(()=>writeToFile(d),1000);
  }
}

function gid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8)}
function td(){return new Date().toISOString().split('T')[0]}
function fd(n){const d=new Date();d.setDate(d.getDate()+n);return d.toISOString().split('T')[0]}
function fmt(d){if(!d)return'‚Äî';try{return new Date(d).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})}catch{return d}}
function isOD(d){return d&&d<td()}
function isT(d){return d===td()}
function isS(d){if(!d)return false;const x=(new Date(d)-new Date(td()))/864e5;return x>=0&&x<=2}
function daysFromNow(d){if(!d)return 999;return Math.round((new Date(d)-new Date(td()))/864e5)}

function getRecent(){try{return JSON.parse(localStorage.getItem(RK)||'[]')}catch{return[]}}
function addRecent(id,name){let r=getRecent().filter(x=>x.id!==id);r.unshift({id,name,t:Date.now()});if(r.length>5)r=r.slice(0,5);localStorage.setItem(RK,JSON.stringify(r))}

function getAct(data,date){const a=data.activity||{};const d=a[date]||{companies:[],emails:0,linkedin:0,calls:0};return{companies:d.companies||[],emails:d.emails||0,linkedin:d.linkedin||0,calls:d.calls||0}}
function logAct(data,setData,type,companyId){
  const today=td();const act={...data.activity};
  if(!act[today])act[today]={companies:[],emails:0,linkedin:0,calls:0};
  const d=act[today];
  if(type==='company'&&companyId&&!d.companies.includes(companyId))d.companies=[...d.companies,companyId];
  if(type==='email')d.emails=(d.emails||0)+1;
  if(type==='linkedin')d.linkedin=(d.linkedin||0)+1;
  if(type==='call')d.calls=(d.calls||0)+1;
  const u={...data,activity:act};setData(u);sv(u);return u;
}
const TARGETS={companies:5,emails:5,linkedin:5};

const STS=[{v:'prospect',l:'Prospect',c:'var(--sp)'},{v:'contacted',l:'Contacted',c:'var(--sc)'},{v:'engaged',l:'Engaged',c:'var(--se)'},{v:'proposal',l:'Proposal',c:'var(--spr)'},{v:'won',l:'Won',c:'var(--sw)'},{v:'lost',l:'Lost',c:'var(--sl)'},{v:'dormant',l:'Dormant',c:'var(--sd)'}];
const CATS=[{v:'management',l:'General Management',s:'MGMT',d:'MD, Director, CEO, COO',c:'var(--amber)'},{v:'engineering',l:'Engineering Leadership',s:'ENG',d:'CTO, Eng Director, Tech Lead',c:'var(--blue)'},{v:'hr',l:'HR / Recruitment',s:'HR',d:'HR Director, Talent, Recruitment',c:'var(--purple)'}];

function getAnonTR(tr){
  if(!tr)return'Defence sector recruitment specialist with extensive track record.';
  return tr.replace(/Vialite\s*Communications?/gi,'a leading RF over Fibre company')
    .replace(/PPM\s*(?:Power|Systems|Ltd)/gi,'a specialist RF/power electronics company')
    .replace(/L3Harris\s*(?:ASV|TRL)?/gi,'a major defence prime')
    .replace(/Jankel\s*(?:Armouring)?/gi,'a vehicle armouring specialist')
    .replace(/NP\s*Aerospace/gi,'an armour and vehicle company')
    .replace(/MSI\s*Defence\s*Systems?/gi,'a weapon systems manufacturer')
    .replace(/Seebyte/gi,'a UUV software company').replace(/CRFS/gi,'an RF spectrum monitoring company')
    .replace(/MTU\s*Maintenance/gi,'a major aeroengine MRO provider')
    .replace(/Trelleborg/gi,'a global aerospace seals manufacturer')
    .replace(/Drumgrange/gi,'a military comms company')
    .replace(/Enterprise\s*Control\s*Systems?/gi,'a datalinks/EW equipment company')
    .replace(/Gooch\s*(?:&|and)\s*Housego/gi,'an optical subsystems company')
    .replace(/BAE\s*Systems?/gi,'a major defence prime')
    .replace(/Peter\s*Hardisty/gi,'a senior industry figure')
    .replace(/Emcore/gi,'a competitor').replace(/DE&S/gi,'a key MOD customer');
}

const EMAIL_SYS={
  management:{
    initial:`You write BD emails for a specialist defence/aerospace recruitment consultancy. Writing to a SENIOR LEADER (MD, Director, CEO, COO).
STYLE: Write like a seasoned business person. Short sentences. Direct. Confident but not pushy. NO corporate fluff. NO "I hope this email finds you well". NO "reaching out". NO "in today's rapidly evolving landscape". NO "I wanted to". Just get to the point.
FOCUS: Leadership hires, functional heads, strategic talent. Reference types of senior roles placed (without naming client companies).
Keep under 150 words. One clear ask. Sign off with "Kind regards,\nStephen" and on the next line "Banner Lane".
Format:
SUBJECT: [subject line]
---
[email body]`,
    followup:`Follow-up to a senior leader. Emailed days ago, no reply. Under 80 words. New angle. Casual, human. No desperation. Sign off with "Kind regards,\nStephen" and on the next line "Banner Lane".
Format:
SUBJECT: [subject line]
---
[body]`
  },
  engineering:{
    initial:`You write BD emails for a specialist defence/aerospace recruitment consultancy. Writing to an ENGINEERING LEADER (CTO, Eng Director, Tech Lead).
STYLE: Technical credibility. Peer-to-peer. Not salesy. NO buzzwords. NO "talent solutions". NO "I hope this finds you well". NO "reaching out".
FOCUS: Hard-to-find engineers. Cleared talent. Niche skillsets (RF, embedded, FPGA, optical, DSP). Track record finding people others can't.
Under 150 words. One ask. Sign off with "Kind regards,\nStephen" and on the next line "Banner Lane".
Format:
SUBJECT: [subject line]
---
[body]`,
    followup:`Follow-up to engineering leader. Under 80 words. Don't repeat first email. Reference a technical hiring challenge. Casual, credible. Sign off with "Kind regards,\nStephen" and on the next line "Banner Lane".
Format:
SUBJECT: [subject line]
---
[body]`
  },
  hr:{
    initial:`You write BD emails for a specialist defence/aerospace recruitment consultancy. Writing to HR/RECRUITMENT.
STYLE: Collaborative, partnership-focused. Show what's different: retained search, headhunting competitors, "invisible" market of cleared personnel. NO generic pitches. Be specific.
FOCUS: Hard-to-fill roles. Cleared talent. Salary benchmarking. Retained RPO. Supplementing their team.
Under 150 words. Suggest partnership conversation. Sign off with "Kind regards,\nStephen" and on the next line "Banner Lane".
Format:
SUBJECT: [subject line]
---
[body]`,
    followup:`Follow-up to HR. Under 80 words. Offer value ‚Äî market insight, salary data, recent search. Resource not vendor. Sign off with "Kind regards,\nStephen" and on the next line "Banner Lane".
Format:
SUBJECT: [subject line]
---
[body]`
  }
};

async function callAI(key,sys,usr){
  if(!key)throw new Error('No API key. Go to Settings.');
  const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1500,system:sys,messages:[{role:'user',content:usr}]})});
  if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.error?.message||`API ${r.status}`);}
  return(await r.json()).content.map(b=>b.text||'').join('');
}

function parseEmail(text){const sm=text.match(/^SUBJECT:\s*(.+?)[\r\n]/i);const s=sm?sm[1].trim():'Introduction ‚Äî Banner Lane';const bs=text.indexOf('---');const b=bs>=0?text.slice(bs+3).trim():text.replace(/^SUBJECT:.*[\r\n]+/i,'').trim();return{subject:s,body:b}}
function SB({status}){const s=STS.find(x=>x.v===status)||STS[0];return<span className="badge" style={{color:s.c,background:s.c+'18',border:`1px solid ${s.c}33`}}>{s.l}</span>}
function ContactProgress({contacts}){
  const cats=CATS.map(cat=>{const cts=(contacts||[]).filter(c=>c.category===cat.v);return{...cat,total:cts.length,contacted:cts.filter(c=>c.contacted).length}});
  return(<div style={{display:'flex',gap:8,alignItems:'center'}}>
    {cats.map(cat=>(<div key={cat.v} title={`${cat.s}: ${cat.contacted}/${cat.total}`} style={{display:'flex',alignItems:'center',gap:3}}>
      <span style={{fontSize:9,color:cat.c,fontWeight:700,fontFamily:'JetBrains Mono,monospace',width:32}}>{cat.s}</span>
      {cat.total===0?<span style={{width:10,height:10,borderRadius:'50%',border:'1.5px dashed var(--bd)',display:'inline-block'}}/>
      :<div className="progress-dots">{Array.from({length:Math.min(cat.total,5)}).map((_,i)=><div key={i} className={`progress-dot ${i<cat.contacted?'filled':'partial'}`} style={i>=cat.contacted?{background:'transparent'}:{}}/>)}{cat.total>5&&<span style={{fontSize:9,color:'var(--tm)'}}>+{cat.total-5}</span>}</div>}
    </div>))}
  </div>);
}
function getStaggerDate(cid,tasks){const ex=tasks.filter(t=>t.companyId===cid&&t.type==='email'&&!t.completed).map(t=>t.dueDate).sort();if(ex.length===0)return fd(1);const d=new Date(ex[ex.length-1]);d.setDate(d.getDate()+14);return d.toISOString().split('T')[0]}

function exportCSV(data){
  const rows=[['Company','Country','Sector','Status','Contact Name','Role','Category','Email','Phone','LinkedIn','Contacted','LinkedIn Noted','Last Contact','Contact Method']];
  data.companies.forEach(co=>{
    if(!co.contacts||co.contacts.length===0){rows.push([co.name,co.country,co.sector||'',co.status,'','','','','','','','','',''])}
    else{co.contacts.forEach(ct=>{rows.push([co.name,co.country,co.sector||'',co.status,ct.name,ct.role||'',ct.category||'',ct.email||'',ct.phone||'',ct.linkedin||'',ct.contacted?'Yes':'No',ct.linkedinNoted?'Yes':'No',ct.lastContactDate||'',ct.contactMethod||''])})}
  });
  const csv=rows.map(r=>r.map(c=>`"${(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const b=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`recon-contacts-${td()}.csv`;a.click();
}

// ‚îÄ‚îÄ‚îÄ SAVE STATUS BAR ‚îÄ‚îÄ‚îÄ
function SaveBar({fileConnected,onConnect,onSaveNow}){
  return(<div className="save-bar" onClick={fileConnected?onSaveNow:onConnect}
    style={{color:fileConnected?'var(--green)':'var(--amber)',background:fileConnected?'var(--greend)33':'var(--amberd)33',border:`1px solid ${fileConnected?'var(--green)':'var(--amber)'}33`}}>
    <span style={{fontSize:13}}>{fileConnected?'‚óè':'‚ö†'}</span>
    <span>{fileConnected?'Auto-saving to file':'Connect save file'}</span>
  </div>);
}

// ‚îÄ‚îÄ‚îÄ RESTORE SCREEN ‚îÄ‚îÄ‚îÄ
function RestoreScreen({onRestore,onFresh}){
  return(<div className="restore-screen">
    <div className="mono" style={{fontSize:32,color:'var(--amber)',letterSpacing:4}}>‚ñ£ RECON</div>
    <div style={{fontSize:16,color:'var(--t2)',maxWidth:400}}>Your browser data was cleared. No worries ‚Äî if you had a save file connected, you can restore it now.</div>
    <div style={{display:'flex',gap:12,marginTop:12}}>
      <button className="bp" style={{padding:'12px 24px',fontSize:15}} onClick={onRestore}>Load from Save File</button>
      <button className="bs" style={{padding:'12px 24px',fontSize:15}} onClick={onFresh}>Start Fresh (load seed data)</button>
    </div>
    <div className="mono" style={{fontSize:11,color:'var(--tm)',maxWidth:400,marginTop:16}}>
      Your save file is the recon-data.json you connected previously. If you never connected one, hit "Start Fresh" and connect one right away in Settings.
    </div>
  </div>);
}

function ActivityDashboard({data}){
  const today=getAct(data,td());const [hovDay,setHovDay]=useState(null);
  const weeks=12;const totalDays=weeks*7;const calDays=[];const startDate=new Date();startDate.setDate(startDate.getDate()-totalDays+1);
  const startDow=startDate.getDay()||7;if(startDow!==1)startDate.setDate(startDate.getDate()-(startDow-1));
  const realTotal=totalDays+(startDow===1?0:7);
  for(let i=0;i<realTotal;i++){const d=new Date(startDate);d.setDate(d.getDate()+i);const ds=d.toISOString().split('T')[0];const act=getAct(data,ds);const score=(Math.min(act.companies.length,TARGETS.companies)+Math.min(act.emails,TARGETS.emails)+Math.min(act.linkedin,TARGETS.linkedin))/(TARGETS.companies+TARGETS.emails+TARGETS.linkedin);calDays.push({date:ds,day:d.getDate(),act,score,future:ds>td(),isToday:ds===td()})}
  let streak=0;const ck=new Date();const ts=(today.companies.length+today.emails+today.linkedin);if(ts===0)ck.setDate(ck.getDate()-1);
  for(let i=0;i<90;i++){const ds=ck.toISOString().split('T')[0];const dw=ck.getDay();if(dw===0||dw===6){ck.setDate(ck.getDate()-1);continue}const a=getAct(data,ds);if(a.companies.length>0||a.emails>0||a.linkedin>0){streak++;ck.setDate(ck.getDate()-1)}else break}
  const ws=new Date();ws.setDate(ws.getDate()-(ws.getDay()||7)+1);let wC=0,wE=0,wL=0;
  for(let i=0;i<7;i++){const d=new Date(ws);d.setDate(d.getDate()+i);const a=getAct(data,d.toISOString().split('T')[0]);wC+=a.companies.length;wE+=a.emails;wL+=a.linkedin}
  const hov=hovDay?getAct(data,hovDay):null;
  return(<div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:12,padding:20,marginBottom:24}}>
    <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:16}}>
      <div className="sh" style={{color:'var(--amber)',marginBottom:0}}>DAILY TARGETS</div>
      {streak>0&&<div className="mono" style={{fontSize:12,color:'var(--green)'}}>üî• {streak} day streak</div>}
    </div>
    <div style={{marginBottom:20}}>
      {[{l:'Companies',v:today.companies.length,t:TARGETS.companies,c1:'var(--amber)',c2:'var(--green)',icon:'‚óÜ'},
        {l:'Emails',v:today.emails,t:TARGETS.emails,c1:'var(--blue)',c2:'var(--green)',icon:'‚úâ'},
        {l:'LinkedIn',v:today.linkedin,t:TARGETS.linkedin,c1:'var(--purple)',c2:'var(--green)',icon:'in'}].map((r,i)=>(
        <div key={i} className="target-row">
          <span style={{width:20,textAlign:'center',color:r.c1,fontSize:r.icon==='in'?11:13}}>{r.icon}</span>
          <span style={{width:100,fontSize:13}}>{r.l}</span>
          <div className="target-bar"><div className="target-fill" style={{width:`${Math.min(r.v/r.t*100,100)}%`,background:r.v>=r.t?r.c2:r.c1}}/></div>
          <span className="mono" style={{fontSize:13,fontWeight:700,color:r.v>=r.t?'var(--green)':'var(--t1)',width:40,textAlign:'right'}}>{r.v}/{r.t}</span>
        </div>))}
    </div>
    <div style={{display:'flex',gap:20,marginBottom:16,padding:'10px 0',borderTop:'1px solid var(--bd)',borderBottom:'1px solid var(--bd)'}}>
      <div className="mono" style={{fontSize:10,color:'var(--tm)',letterSpacing:1}}>THIS WEEK:</div>
      <div style={{fontSize:12}}><span style={{color:'var(--amber)',fontWeight:600}}>{wC}</span><span style={{color:'var(--tm)'}}> companies</span></div>
      <div style={{fontSize:12}}><span style={{color:'var(--blue)',fontWeight:600}}>{wE}</span><span style={{color:'var(--tm)'}}> emails</span></div>
      <div style={{fontSize:12}}><span style={{color:'var(--purple)',fontWeight:600}}>{wL}</span><span style={{color:'var(--tm)'}}> LinkedIn</span></div>
    </div>
    <div style={{display:'flex',alignItems:'flex-start',gap:16}}>
      <div style={{flex:1}}>
        <div className="cal-grid">
          {['M','T','W','T','F','S','S'].map((d,i)=><div key={i} className="cal-hdr">{d}</div>)}
          {calDays.map((d,i)=>{let cls='cal-noact';if(d.future)cls='cal-future';else if(d.score>=0.9)cls='cal-full';else if(d.score>0)cls='cal-partial';
            return<div key={i} className={`cal-day ${cls} ${d.isToday?'cal-today':''}`} onMouseEnter={()=>setHovDay(d.date)} onMouseLeave={()=>setHovDay(null)}>{d.day}</div>})}
        </div>
        <div style={{display:'flex',gap:12,marginTop:8,justifyContent:'flex-end',fontSize:10,color:'var(--tm)'}}>
          <span style={{display:'flex',alignItems:'center',gap:4}}><span style={{width:10,height:10,borderRadius:2,background:'var(--bg2)',display:'inline-block'}}/> None</span>
          <span style={{display:'flex',alignItems:'center',gap:4}}><span style={{width:10,height:10,borderRadius:2,background:'#92600a44',border:'1px solid var(--amber)44',display:'inline-block'}}/> Partial</span>
          <span style={{display:'flex',alignItems:'center',gap:4}}><span style={{width:10,height:10,borderRadius:2,background:'var(--greend)',border:'1px solid var(--green)44',display:'inline-block'}}/> All targets</span>
        </div>
      </div>
      <div style={{width:140,padding:12,background:'var(--bg1)',borderRadius:8,border:'1px solid var(--bd)',minHeight:80}}>
        {hovDay?(<div><div className="mono" style={{fontSize:10,color:'var(--tm)',marginBottom:8}}>{new Date(hovDay+'T12:00:00').toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'})}</div>
          <div style={{fontSize:12,marginBottom:4}}><span style={{color:'var(--amber)'}}>‚óÜ</span> {hov.companies.length} companies</div>
          <div style={{fontSize:12,marginBottom:4}}><span style={{color:'var(--blue)'}}>‚úâ</span> {hov.emails} emails</div>
          <div style={{fontSize:12}}><span style={{color:'var(--purple)'}}>in</span> {hov.linkedin} LinkedIn</div>
        </div>):(<div className="mono" style={{fontSize:10,color:'var(--tm)'}}>Hover a day</div>)}
      </div>
    </div>
  </div>);
}

function LinkedInBox({contact,company,onCopy}){
  const [msg,setMsg]=useState('');const [copied,setCopied]=useState(false);
  useEffect(()=>{const s=company.sector||'defence';const n=contact.name?.split(' ')[0]||'';let m='';
    if(contact.category==='management')m=`Hi ${n}, I run a specialist recruitment practice in the ${s.toLowerCase()} sector ‚Äî we help businesses like ${company.name} find leadership and functional heads. Would be great to connect. Always happy to share market insight.`;
    else if(contact.category==='engineering')m=`Hi ${n}, I specialise in placing niche engineers in ${s.toLowerCase()} ‚Äî cleared talent, embedded, RF, FPGA etc. Thought it'd be worth connecting given your role at ${company.name}. Happy to share what we're seeing in the market.`;
    else m=`Hi ${n}, I run a retained search practice focused on ${s.toLowerCase()} recruitment ‚Äî specialising in hard-to-fill technical and leadership roles. Would be great to connect and see if there's scope to support ${company.name}'s hiring.`;
    if(m.length>300)m=m.slice(0,297)+'...';setMsg(m)},[contact,company]);
  function doCopy(){navigator.clipboard.writeText(msg);setCopied(true);if(onCopy)onCopy();setTimeout(()=>setCopied(false),2000)}
  return(<div className="li-box fi">
    <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:6}}>
      <span className="mono" style={{fontSize:10,color:'var(--blue)',letterSpacing:1,fontWeight:600}}>LINKEDIN INVITE MESSAGE</span>
      <span className="mono" style={{fontSize:10,color:msg.length>300?'var(--red)':'var(--tm)'}}>{msg.length}/300</span>
    </div>
    <textarea value={msg} onChange={e=>{if(e.target.value.length<=300)setMsg(e.target.value)}} style={{minHeight:60,fontSize:12,lineHeight:1.5,background:'var(--bg0)',border:'1px solid var(--bd)'}}/>
    <div style={{display:'flex',gap:8,marginTop:8}}><button className={copied?'bg bx':'bb bx'} onClick={doCopy}>{copied?'‚úì Copied':'Copy to Clipboard'}</button></div>
  </div>);
}

function EmailModal({contact,company,data,setData,onClose,onSent,taskId,isFollowUp}){
  const [subject,setSubject]=useState('');const [body,setBody]=useState('');const [loading,setLoading]=useState(true);const [sc,setSC]=useState(false);
  const anonTR=getAnonTR(data.trackRecord);const cfg=EMAIL_SYS[contact.category]||EMAIL_SYS.management;
  async function generate(){setLoading(true);setSubject('');setBody('');
    try{const news=company.aiNews?`\nRecent intel: ${company.aiNews.slice(0,500)}`:'';
      const sys=(isFollowUp?cfg.followup:cfg.initial)+`\n\nTrack record (NO specific company names):\n${anonTR}`;
      const raw=await callAI(data.settings.apiKey,sys,`${isFollowUp?'Follow-up':'Initial outreach'} to:\nName: ${contact.name}\nTitle: ${contact.role}\nCompany: ${company.name}\nSector: ${company.sector||'Defence'}\nCountry: ${company.country}\nNotes: ${company.notes||'Defence company'}\n${news}\n\nSound human. Vary sentence length. No clich√©s.`);
      const p=parseEmail(raw);setSubject(p.subject);setBody(p.body)}catch(e){setBody('Error: '+e.message);setSubject('Error')}setLoading(false)}
  useEffect(()=>{generate()},[]);
  return(<div className="mo" onClick={onClose}><div className="ml" style={{maxWidth:700}} onClick={e=>e.stopPropagation()}>
    <h3>{isFollowUp?'‚óá Follow-up':'‚úâ Email'} to {contact.name}</h3>
    <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8,padding:'10px 14px',background:'var(--bg0)',borderRadius:8,border:'1px solid var(--bd)'}}>
      <span style={{fontSize:12,color:'var(--tm)'}}>To:</span>
      <span className="mono" style={{fontSize:14,fontWeight:600,color:'var(--t1)',flex:1}}>{contact.email}</span>
      <button className="bs bx" onClick={()=>{navigator.clipboard.writeText(contact.email);}} style={{whiteSpace:'nowrap'}}>Copy Email</button>
    </div>
    <div style={{fontSize:12,color:'var(--tm)',marginBottom:4}}>{contact.role} at {company.name}</div>
    <div style={{display:'flex',gap:6,marginBottom:16}}>
      <span className="badge" style={{color:CATS.find(c=>c.v===contact.category)?.c,background:CATS.find(c=>c.v===contact.category)?.c+'18'}}>{contact.category}</span>
      <span className="badge" style={{color:isFollowUp?'var(--purple)':'var(--blue)',background:isFollowUp?'var(--purple)18':'var(--blue)18'}}>{isFollowUp?'FOLLOW-UP':'INITIAL'}</span>
    </div>
    {loading?<div style={{padding:40,textAlign:'center'}}><div className="mono" style={{color:'var(--tm)'}}>Writing...</div></div>
    :<><div className="subj-row"><span className="mono" style={{fontSize:10,color:'var(--t2)',letterSpacing:1,fontWeight:600,whiteSpace:'nowrap'}}>SUBJECT:</span>
        <input value={subject} onChange={e=>setSubject(e.target.value)}/>
        <button className={sc?'bg bx':'bs bx'} onClick={()=>{navigator.clipboard.writeText(subject);setSC(true);setTimeout(()=>setSC(false),1500)}}>{sc?'‚úì':'Copy'}</button></div>
      <textarea value={body} onChange={e=>setBody(e.target.value)} style={{minHeight:220,fontSize:13,lineHeight:1.7}}/>
      <div style={{display:'flex',gap:8,marginTop:16,justifyContent:'space-between',flexWrap:'wrap'}}>
        <button className="bs" onClick={generate}>‚Üª Regenerate</button>
        <div style={{display:'flex',gap:8}}>
          <button className="bs" onClick={()=>{navigator.clipboard.writeText(`Subject: ${subject}\n\n${body}`);alert('Copied!')}}>Copy All</button>
          <button className="bp" onClick={()=>{navigator.clipboard.writeText(`Subject: ${subject}\n\n${body}`);onSent(contact,taskId)}}>‚úì Sent ‚Üí Follow-up in 4d</button>
        </div></div></>}
  </div></div>);
}

function CallModal({contact,company,onClose,onSave}){
  const [outcome,setOutcome]=useState('no_answer');const [notes,setNotes]=useState('');
  const days=outcome==='spoke'?5:outcome==='voicemail'?3:2;
  return(<div className="mo" onClick={onClose}><div className="ml" onClick={e=>e.stopPropagation()}>
    <h3>‚òé Call ‚Äî {contact.name}</h3>
    <div style={{fontSize:12,color:'var(--tm)',marginBottom:16}}>{contact.role} at {company.name}{contact.phone&&<span className="mono"> ¬∑ {contact.phone}</span>}</div>
    <div className="fg"><label>Outcome</label><div style={{display:'flex',gap:8}}>
      {[{v:'spoke',l:'‚úì Spoke',c:'bg'},{v:'voicemail',l:'‚úâ VM',c:'bb'},{v:'no_answer',l:'‚úó No Answer',c:'bs'}].map(o=>(
        <button key={o.v} className={outcome===o.v?o.c:'bs'} style={{flex:1,border:outcome===o.v?'2px solid var(--amber)':'1px solid var(--bd)'}} onClick={()=>setOutcome(o.v)}>{o.l}</button>))}</div></div>
    <div className="fg"><label>Notes</label><textarea value={notes} onChange={e=>setNotes(e.target.value)} placeholder="Key points..." style={{minHeight:100}}/></div>
    <div className="mono" style={{fontSize:11,color:'var(--tm)',marginBottom:12}}>Follow-up in {days} days</div>
    <div style={{display:'flex',gap:8,justifyContent:'flex-end'}}><button className="bs" onClick={onClose}>Cancel</button><button className="bp" onClick={()=>onSave(contact,outcome,notes)}>Save & Create Follow-up</button></div>
  </div></div>);
}

function Sidebar({view,setView,ac,fileConnected,onConnect,onSaveNow}){
  const items=[{id:'actions',icon:'‚ö°',l:'Daily Actions',badge:ac},{id:'companies',icon:'‚óÜ',l:'Companies'},{id:'contacts',icon:'‚óé',l:'Contacts'},{id:'tasks',icon:'‚óá',l:'Tasks'},{id:'trackrecord',icon:'‚ñ£',l:'Track Record'},{id:'settings',icon:'‚öô',l:'Settings'}];
  return(<nav style={{width:220,minHeight:'100vh',background:'var(--bg1)',borderRight:'1px solid var(--bd)',display:'flex',flexDirection:'column',position:'fixed',top:0,left:0,zIndex:100}}>
    <div style={{padding:'20px 16px',borderBottom:'1px solid var(--bd)'}}><div className="mono" style={{fontSize:20,fontWeight:700,color:'var(--amber)',letterSpacing:3}}>‚ñ£ RECON</div><div className="mono" style={{fontSize:10,color:'var(--tm)',marginTop:2,letterSpacing:1}}>BANNER LANE</div></div>
    <div style={{padding:'12px 8px',flex:1}}>{items.map(it=>(
      <div key={it.id} onClick={()=>setView(it.id)} style={{display:'flex',alignItems:'center',gap:10,padding:'10px 12px',borderRadius:8,cursor:'pointer',marginBottom:2,background:view===it.id?'var(--bgh)':'transparent',color:view===it.id?'var(--amber)':'var(--t2)',fontSize:13,fontWeight:view===it.id?600:400,borderLeft:view===it.id?'2px solid var(--amber)':'2px solid transparent',transition:'all .15s'}}>
        <span style={{fontSize:14,width:20,textAlign:'center'}}>{it.icon}</span>{it.l}
        {it.badge>0&&<span style={{marginLeft:'auto',background:'var(--red)',color:'#fff',borderRadius:10,padding:'1px 7px',fontSize:10,fontWeight:700}}>{it.badge}</span>}
      </div>))}</div>
    <div style={{padding:'8px 8px 12px'}}>
      <SaveBar fileConnected={fileConnected} onConnect={onConnect} onSaveNow={onSaveNow}/>
    </div>
    <div className="mono" style={{padding:'0 16px 12px',fontSize:10,color:'var(--tm)'}}>v3.4</div>
  </nav>);
}

function ContactsView({data,setView,setSel}){
  const [search,setSearch]=useState('');const [fCat,setFCat]=useState('');const [fStatus,setFStatus]=useState('');
  const all=[];data.companies.forEach(co=>{(co.contacts||[]).forEach(ct=>{all.push({...ct,companyName:co.name,companyId:co.id,companyCountry:co.country,companyStatus:co.status})})});
  const filtered=all.filter(c=>{
    if(search){const s=search.toLowerCase();if(!c.name.toLowerCase().includes(s)&&!c.companyName.toLowerCase().includes(s)&&!(c.role||'').toLowerCase().includes(s)&&!(c.email||'').toLowerCase().includes(s))return false}
    if(fCat&&c.category!==fCat)return false;
    if(fStatus==='contacted'&&!c.contacted)return false;if(fStatus==='not_contacted'&&c.contacted)return false;if(fStatus==='li_noted'&&!c.linkedinNoted)return false;
    return true}).sort((a,b)=>a.name.localeCompare(b.name));
  const total=all.length;const contacted=all.filter(c=>c.contacted).length;
  return(<div className="fi">
    <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:24}}>
      <h2 style={{fontSize:22,fontWeight:300}}><span style={{color:'var(--amber)'}} className="mono">‚óé</span> Contacts <span className="mono" style={{fontSize:13,color:'var(--tm)',marginLeft:8}}>{total} total ¬∑ {contacted} contacted</span></h2>
      <button className="bs" onClick={()=>exportCSV(data)}>‚Üì Export CSV</button>
    </div>
    <div style={{display:'flex',gap:12,marginBottom:16,flexWrap:'wrap'}}>
      <input placeholder="Search name, company, role, email..." value={search} onChange={e=>setSearch(e.target.value)} style={{maxWidth:360}}/>
      <select value={fCat} onChange={e=>setFCat(e.target.value)} style={{maxWidth:160}}><option value="">All Categories</option>{CATS.map(c=><option key={c.v} value={c.v}>{c.l}</option>)}</select>
      <select value={fStatus} onChange={e=>setFStatus(e.target.value)} style={{maxWidth:160}}><option value="">All</option><option value="contacted">Contacted</option><option value="not_contacted">Not Contacted</option><option value="li_noted">LinkedIn Noted</option></select>
      <span className="mono" style={{fontSize:12,color:'var(--tm)',alignSelf:'center'}}>{filtered.length}</span>
    </div>
    <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,overflow:'hidden'}}>
      <div style={{display:'grid',gridTemplateColumns:'180px 120px 1fr 80px 180px 100px',padding:'10px 16px',background:'var(--bg2)',fontSize:10,fontWeight:600,textTransform:'uppercase',letterSpacing:1,color:'var(--tm)'}} className="mono"><span>Name</span><span>Category</span><span>Company</span><span>Country</span><span>Email</span><span>Status</span></div>
      {filtered.length===0&&<div style={{padding:32,textAlign:'center',color:'var(--tm)',fontSize:13}}>No contacts found</div>}
      {filtered.slice(0,100).map(c=>(
        <div key={c.id} style={{display:'grid',gridTemplateColumns:'180px 120px 1fr 80px 180px 100px',padding:'10px 16px',borderBottom:'1px solid var(--bd)',alignItems:'center',fontSize:12,cursor:'pointer',transition:'background .15s'}}
          onMouseEnter={e=>e.currentTarget.style.background='var(--bgh)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}
          onClick={()=>{addRecent(c.companyId,c.companyName);setSel(c.companyId);setView('companyDetail')}}>
          <div><span style={{fontWeight:600}}>{c.name}</span><div style={{fontSize:10,color:'var(--tm)'}}>{c.role}</div></div>
          <span className="badge" style={{color:CATS.find(x=>x.v===c.category)?.c||'var(--tm)',background:(CATS.find(x=>x.v===c.category)?.c||'var(--tm)')+'18'}}>{c.category}</span>
          <span style={{color:'var(--amber)'}}>{c.companyName}</span>
          <span className="mono" style={{color:'var(--tm)'}}>{c.companyCountry}</span>
          <span className="mono" style={{fontSize:11,color:'var(--t2)'}}>{c.email||'‚Äî'}</span>
          <div style={{display:'flex',gap:4,alignItems:'center'}}>{c.contacted?<span className="badge" style={{color:'var(--green)',background:'var(--green)18'}}>DONE</span>:<span className="badge" style={{color:'var(--tm)',background:'var(--bg2)'}}>PENDING</span>}
          {c.linkedinNoted&&<span className="badge" style={{color:'var(--blue)',background:'var(--blue)18'}}>LI</span>}</div>
        </div>))}
      {filtered.length>100&&<div style={{padding:12,textAlign:'center',color:'var(--tm)',fontSize:12}}>Showing first 100 of {filtered.length}</div>}
    </div>
  </div>);
}

function DailyActions({data,setData,setView,setSel}){
  const [emailM,setEmailM]=useState(null);const [callM,setCallM]=useState(null);const recent=getRecent();
  const open=data.tasks.filter(t=>!t.completed).sort((a,b)=>new Date(a.dueDate)-new Date(b.dueDate));
  const overdue=open.filter(t=>isOD(t.dueDate));const todayT=open.filter(t=>isT(t.dueDate));const upcoming=open.filter(t=>!isOD(t.dueDate)&&!isT(t.dueDate)&&isS(t.dueDate));
  function handleSent(ct,taskId){const co=data.companies.find(c=>c.contacts?.some(x=>x.id===ct.id));if(!co)return;const uCo=data.companies.map(c=>{if(c.id!==co.id)return c;return{...c,status:c.status==='prospect'?'contacted':c.status,updatedAt:new Date().toISOString(),contacts:c.contacts.map(x=>x.id===ct.id?{...x,contacted:true,contactMethod:'email',contactDate:td(),lastContactDate:td()}:x)}});let uT=taskId?data.tasks.map(t=>t.id===taskId?{...t,completed:true,completedDate:new Date().toISOString()}:t):[...data.tasks];uT.push({id:gid(),companyId:co.id,contactId:ct.id,type:'followup',description:`Follow up with ${ct.name} at ${co.name}`,dueDate:fd(4),completed:false,createdAt:new Date().toISOString()});const act={...data.activity};const today=td();if(!act[today])act[today]={companies:[],emails:0,linkedin:0,calls:0};act[today]={...act[today],emails:(act[today].emails||0)+1};const u={...data,companies:uCo,tasks:uT,activity:act};setData(u);sv(u);setEmailM(null)}
  function handleCall(ct,outcome,notes,taskId){const co=data.companies.find(c=>c.contacts?.some(x=>x.id===ct.id));if(!co)return;const log={id:gid(),companyId:co.id,contactId:ct.id,contactName:ct.name,companyName:co.name,outcome,notes,date:new Date().toISOString()};logAct(data,setData,'call');const uCo=data.companies.map(c=>{if(c.id!==co.id)return c;return{...c,status:c.status==='prospect'?'contacted':c.status,updatedAt:new Date().toISOString(),contacts:c.contacts.map(x=>x.id===ct.id?{...x,contacted:true,contactMethod:'call',contactDate:td(),lastContactDate:td(),lastCallOutcome:outcome,lastCallNotes:notes}:x)}});const days=outcome==='spoke'?5:outcome==='voicemail'?3:2;let uT=taskId?data.tasks.map(t=>t.id===taskId?{...t,completed:true,completedDate:new Date().toISOString()}:t):[...data.tasks];uT.push({id:gid(),companyId:co.id,contactId:ct.id,type:outcome==='spoke'?'followup':'call',description:outcome==='spoke'?`Follow up after call with ${ct.name} at ${co.name}`:`Re-call ${ct.name} at ${co.name} (${outcome})`,dueDate:fd(days),completed:false,createdAt:new Date().toISOString()});const u={...data,companies:uCo,tasks:uT,callLog:[...(data.callLog||[]),log]};setData(u);sv(u);setCallM(null)}
  function complete(id){const u={...data,tasks:data.tasks.map(t=>t.id===id?{...t,completed:true,completedDate:new Date().toISOString()}:t)};setData(u);sv(u)}
  function TR({task}){const co=data.companies.find(c=>c.id===task.companyId);const ct=co?.contacts?.find(c=>c.id===task.contactId);const isFU=task.type==='followup';
    return(<div style={{display:'flex',alignItems:'center',gap:10,padding:'12px 16px',borderBottom:'1px solid var(--bd)',transition:'background .15s'}} onMouseEnter={e=>e.currentTarget.style.background='var(--bgh)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}>
      <span style={{fontSize:16,color:task.type==='call'?'var(--green)':task.type==='email'?'var(--blue)':'var(--purple)',width:24,textAlign:'center'}}>{task.type==='call'?'‚òé':task.type==='email'?'‚úâ':'‚óá'}</span>
      <div style={{flex:1,minWidth:0}}><div style={{fontSize:13,fontWeight:500}}>{task.description}</div>
        <div style={{fontSize:11,color:'var(--tm)',marginTop:2}}>{co&&<span onClick={()=>{addRecent(co.id,co.name);setSel(co.id);setView('companyDetail')}} style={{cursor:'pointer',color:'var(--amber)'}}>{co.name}</span>}{ct&&<span> ¬∑ {ct.name}{ct.phone&&<span className="mono" style={{marginLeft:6,color:'var(--tm)'}}>{ct.phone}</span>}</span>}</div></div>
      <span className="mono" style={{fontSize:11,color:isOD(task.dueDate)?'var(--red)':isT(task.dueDate)?'var(--amber)':'var(--tm)',whiteSpace:'nowrap'}}>{isOD(task.dueDate)?'OVERDUE':isT(task.dueDate)?'TODAY':fmt(task.dueDate)}</span>
      <div style={{display:'flex',gap:4}}>{ct?.email&&<button className={isFU?'bpu bx':'bb bx'} onClick={()=>setEmailM({contact:ct,company:co,taskId:task.id,isFollowUp:isFU})}>{isFU?'‚óá Follow-up':'‚úâ Email'}</button>}{ct&&<button className="bg bx" onClick={()=>setCallM({contact:ct,company:co,taskId:task.id})}>‚òé</button>}<button className="bs bx" onClick={()=>complete(task.id)}>‚úì</button></div>
    </div>)}
  return(<div className="fi">
    <h2 style={{fontSize:22,fontWeight:300,marginBottom:4}}><span style={{color:'var(--amber)'}} className="mono">‚ö°</span> Daily Actions</h2>
    <p style={{color:'var(--tm)',fontSize:13,marginBottom:24}}>{new Date().toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</p>
    <ActivityDashboard data={data}/>
    {recent.length>0&&<div style={{marginBottom:20}}><div className="sh" style={{color:'var(--t2)'}}>RECENTLY VIEWED</div><div style={{display:'flex',gap:8,flexWrap:'wrap'}}>{recent.map(r=>{const co=data.companies.find(c=>c.id===r.id);if(!co)return null;return<div key={r.id} className="recent-chip" onClick={()=>{addRecent(co.id,co.name);setSel(co.id);setView('companyDetail')}}><SB status={co.status}/><span style={{fontWeight:500}}>{co.name}</span><span className="mono" style={{fontSize:10,color:'var(--tm)'}}>{co.country}</span>{(co.contacts||[]).length>0&&<span className="mono" style={{fontSize:10,color:'var(--green)'}}>{(co.contacts||[]).filter(c=>c.contacted).length}/{(co.contacts||[]).length}</span>}</div>})}</div></div>}
    {overdue.length>0&&<div style={{marginBottom:20}}><div className="sh" style={{color:'var(--red)'}}>‚ö† OVERDUE ({overdue.length})</div><div style={{background:'var(--bgc)',border:'1px solid var(--red)33',borderRadius:10,overflow:'hidden'}}>{overdue.map(t=><TR key={t.id} task={t}/>)}</div></div>}
    <div style={{marginBottom:20}}><div className="sh" style={{color:'var(--amber)'}}>TODAY ({todayT.length})</div><div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,overflow:'hidden'}}>{todayT.length===0&&<div style={{padding:20,textAlign:'center',color:'var(--tm)',fontSize:13}}>No tasks today</div>}{todayT.map(t=><TR key={t.id} task={t}/>)}</div></div>
    {upcoming.length>0&&<div style={{marginBottom:20}}><div className="sh" style={{color:'var(--t2)'}}>COMING UP ({upcoming.length})</div><div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,overflow:'hidden'}}>{upcoming.map(t=><TR key={t.id} task={t}/>)}</div></div>}
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12}}>
      {[{l:'Companies',v:data.companies.length,c:'var(--amber)'},{l:'Contacts',v:data.companies.reduce((a,c)=>a+(c.contacts?.length||0),0),c:'var(--blue)'},{l:'Open Tasks',v:open.length,c:'var(--purple)'},{l:'Calls',v:(data.callLog||[]).length,c:'var(--green)'}].map((s,i)=>(
        <div key={i} style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:16,borderTop:`2px solid ${s.c}`}}><div className="mono" style={{fontSize:22,fontWeight:700,color:s.c}}>{s.v}</div><div className="mono" style={{fontSize:10,color:'var(--tm)',letterSpacing:1,marginTop:2,textTransform:'uppercase'}}>{s.l}</div></div>))}
    </div>
    {emailM&&<EmailModal contact={emailM.contact} company={emailM.company} data={data} setData={setData} taskId={emailM.taskId} isFollowUp={emailM.isFollowUp} onClose={()=>setEmailM(null)} onSent={handleSent}/>}
    {callM&&<CallModal contact={callM.contact} company={callM.company} onClose={()=>setCallM(null)} onSave={(ct,o,n)=>handleCall(ct,o,n,callM.taskId)}/>}
  </div>);
}

function CompanyList({data,setData,setView,setSel}){
  const [showAdd,setShowAdd]=useState(false);const [search,setSearch]=useState('');const [fS,setFS]=useState('');const [fC,setFC]=useState('');const [page,setPage]=useState(0);const PS=50;
  const [form,setForm]=useState({name:'',sector:'Defence',country:'UK',status:'prospect',notes:''});
  const countries=[...new Set(data.companies.map(c=>c.country))].sort();const cc={};data.companies.forEach(c=>{cc[c.country]=(cc[c.country]||0)+1});
  function addCo(){if(!form.name.trim())return;const n={id:gid(),...form,contacts:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),aiNews:''};const u={...data,companies:[...data.companies,n]};setData(u);sv(u);setForm({name:'',sector:'Defence',country:'UK',status:'prospect',notes:''});setShowAdd(false)}
  function delCo(id){if(!confirm('Delete?'))return;const u={...data,companies:data.companies.filter(c=>c.id!==id),tasks:data.tasks.filter(t=>t.companyId!==id)};setData(u);sv(u)}
  const filtered=data.companies.filter(c=>{if(search&&!c.name.toLowerCase().includes(search.toLowerCase()))return false;if(fS&&c.status!==fS)return false;if(fC&&c.country!==fC)return false;return true});
  const tp=Math.ceil(filtered.length/PS);const paged=filtered.slice(page*PS,(page+1)*PS);
  useEffect(()=>{setPage(0)},[search,fS,fC]);
  return(<div className="fi">
    <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:24}}><h2 style={{fontSize:22,fontWeight:300}}><span style={{color:'var(--amber)'}} className="mono">‚óÜ</span> Companies <span className="mono" style={{fontSize:13,color:'var(--tm)',marginLeft:8}}>{data.companies.length}</span></h2><button className="bp" onClick={()=>setShowAdd(true)}>+ Add Company</button></div>
    <div style={{display:'flex',gap:12,marginBottom:12,flexWrap:'wrap'}}><input placeholder="Search..." value={search} onChange={e=>setSearch(e.target.value)} style={{maxWidth:280}}/><select value={fC} onChange={e=>setFC(e.target.value)} style={{maxWidth:160}}><option value="">All Countries</option>{countries.map(c=><option key={c} value={c}>{c} ({cc[c]})</option>)}</select><select value={fS} onChange={e=>setFS(e.target.value)} style={{maxWidth:160}}><option value="">All Statuses</option>{STS.map(s=><option key={s.v} value={s.v}>{s.l}</option>)}</select><span className="mono" style={{fontSize:12,color:'var(--tm)',alignSelf:'center'}}>{filtered.length}</span></div>
    <div style={{display:'flex',gap:6,marginBottom:16,flexWrap:'wrap'}}>{countries.map(c=><button key={c} className={fC===c?'bp':'bs'} style={{padding:'3px 10px',fontSize:11}} onClick={()=>setFC(fC===c?'':c)}>{c} ({cc[c]})</button>)}</div>
    <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,overflow:'hidden'}}>
      <div style={{display:'grid',gridTemplateColumns:'2fr 70px 100px 200px 40px',padding:'10px 16px',background:'var(--bg2)',fontSize:10,fontWeight:600,textTransform:'uppercase',letterSpacing:1,color:'var(--tm)'}} className="mono"><span>Company</span><span>Country</span><span>Status</span><span>Contacts</span><span></span></div>
      {paged.length===0&&<div style={{padding:32,textAlign:'center',color:'var(--tm)',fontSize:13}}>No matches</div>}
      {paged.map(c=>{const tc=(c.contacts||[]).length;const cc2=(c.contacts||[]).filter(x=>x.contacted).length;
        return(<div key={c.id} style={{display:'grid',gridTemplateColumns:'2fr 70px 100px 200px 40px',padding:'10px 16px',borderBottom:'1px solid var(--bd)',cursor:'pointer',alignItems:'center',transition:'background .15s'}} onMouseEnter={e=>e.currentTarget.style.background='var(--bgh)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'} onClick={()=>{addRecent(c.id,c.name);setSel(c.id);setView('companyDetail')}}>
          <div><span style={{fontWeight:500}}>{c.name}</span>{tc>0&&<span className="mono" style={{fontSize:10,marginLeft:8,color:cc2===tc?'var(--green)':cc2>0?'var(--amber)':'var(--tm)'}}>{cc2}/{tc}</span>}</div>
          <span className="mono" style={{fontSize:11,color:'var(--tm)'}}>{c.country}</span><SB status={c.status}/><ContactProgress contacts={c.contacts}/><button className="bd bx" onClick={e=>{e.stopPropagation();delCo(c.id)}}>‚úï</button>
        </div>)})}
    </div>
    {tp>1&&<div style={{display:'flex',alignItems:'center',justifyContent:'center',gap:8,marginTop:16}}><button className="bs bsm" disabled={page===0} onClick={()=>setPage(p=>p-1)}>‚Üê</button><span className="mono" style={{fontSize:12,color:'var(--tm)'}}>{page+1}/{tp}</span><button className="bs bsm" disabled={page>=tp-1} onClick={()=>setPage(p=>p+1)}>‚Üí</button></div>}
    {showAdd&&<div className="mo" onClick={()=>setShowAdd(false)}><div className="ml" onClick={e=>e.stopPropagation()}><h3>Add Company</h3><div className="fg"><label>Name</label><input value={form.name} onChange={e=>setForm({...form,name:e.target.value})} autoFocus/></div><div className="fr"><div className="fg"><label>Sector</label><input value={form.sector} onChange={e=>setForm({...form,sector:e.target.value})}/></div><div className="fg"><label>Country</label><input value={form.country} onChange={e=>setForm({...form,country:e.target.value})}/></div></div><div className="fg"><label>Status</label><select value={form.status} onChange={e=>setForm({...form,status:e.target.value})}>{STS.map(s=><option key={s.v} value={s.v}>{s.l}</option>)}</select></div><div className="fg"><label>Notes</label><textarea value={form.notes} onChange={e=>setForm({...form,notes:e.target.value})}/></div><div style={{display:'flex',gap:8,marginTop:16,justifyContent:'flex-end'}}><button className="bs" onClick={()=>setShowAdd(false)}>Cancel</button><button className="bp" onClick={addCo}>Add</button></div></div></div>}
  </div>);
}

function CompanyDetail({cid,data,setData,setView}){
  const company=data.companies.find(c=>c.id===cid);
  const [showAddCt,setShowAddCt]=useState(false);const [emailM,setEmailM]=useState(null);const [callM,setCallM]=useState(null);
  const [newsLoad,setNewsLoad]=useState(false);const [justAdded,setJustAdded]=useState(null);
  const [ctForm,setCtForm]=useState({name:'',role:'',category:'management',email:'',phone:'',linkedin:'',notes:''});
  if(!company)return<div style={{color:'var(--tm)'}}>Not found</div>;
  useEffect(()=>{addRecent(cid,company.name)},[cid]);
  function upCo(u){const ud={...data,companies:data.companies.map(c=>c.id===cid?{...c,...u,updatedAt:new Date().toISOString()}:c)};setData(ud);sv(ud)}
  function upCt(ctid,u){upCo({contacts:company.contacts.map(c=>c.id===ctid?{...c,...u}:c)})}
  function delCt(ctid){if(!confirm('Delete?'))return;upCo({contacts:company.contacts.filter(c=>c.id!==ctid)});if(justAdded===ctid)setJustAdded(null)}
  function addCt(){if(!ctForm.name.trim())return;const newId=gid();const nc={id:newId,...ctForm,contacted:false,contactMethod:'',contactDate:'',lastContactDate:''};let newTasks=[...data.tasks];if(ctForm.email||ctForm.phone){const sd=getStaggerDate(company.id,data.tasks);newTasks.push({id:gid(),companyId:company.id,contactId:newId,type:'email',description:`Initial outreach to ${ctForm.name} at ${company.name}`,dueDate:sd,completed:false,createdAt:new Date().toISOString()})}logAct(data,setData,'company',company.id);const u={...data,companies:data.companies.map(c=>c.id===cid?{...c,contacts:[...(c.contacts||[]),nc],updatedAt:new Date().toISOString()}:c),tasks:newTasks};setData(u);sv(u);setJustAdded(newId);setCtForm({name:'',role:'',category:'management',email:'',phone:'',linkedin:'',notes:''});setShowAddCt(false)}
  function handleLinkedInCopy(){logAct(data,setData,'linkedin')}
  function handleSent(ct){
    const act={...data.activity};const today=td();if(!act[today])act[today]={companies:[],emails:0,linkedin:0,calls:0};act[today]={...act[today],emails:(act[today].emails||0)+1};
    const newStatus=(company.status==='prospect')?'contacted':company.status;
    const uCo=data.companies.map(c=>{if(c.id!==cid)return c;return{...c,status:newStatus,updatedAt:new Date().toISOString(),contacts:c.contacts.map(x=>x.id===ct.id?{...x,contacted:true,contactMethod:'email',contactDate:td(),lastContactDate:td()}:x)}});
    const uT=[...data.tasks,{id:gid(),companyId:company.id,contactId:ct.id,type:'followup',description:`Follow up with ${ct.name} at ${company.name}`,dueDate:fd(4),completed:false,createdAt:new Date().toISOString()}];
    const u={...data,companies:uCo,tasks:uT,activity:act};setData(u);sv(u);setEmailM(null)}
  function handleCall(ct,outcome,notes){
    const log={id:gid(),companyId:company.id,contactId:ct.id,contactName:ct.name,companyName:company.name,outcome,notes,date:new Date().toISOString()};
    const act={...data.activity};const today=td();if(!act[today])act[today]={companies:[],emails:0,linkedin:0,calls:0};act[today]={...act[today],calls:(act[today].calls||0)+1};
    const newStatus=(company.status==='prospect')?'contacted':company.status;
    const uCo=data.companies.map(c=>{if(c.id!==cid)return c;return{...c,status:newStatus,updatedAt:new Date().toISOString(),contacts:c.contacts.map(x=>x.id===ct.id?{...x,contacted:true,contactMethod:'call',contactDate:td(),lastContactDate:td(),lastCallOutcome:outcome,lastCallNotes:notes}:x)}});
    const days=outcome==='spoke'?5:outcome==='voicemail'?3:2;
    const uT=[...data.tasks,{id:gid(),companyId:company.id,contactId:ct.id,type:outcome==='spoke'?'followup':'call',description:outcome==='spoke'?`Follow up after call with ${ct.name}`:`Re-call ${ct.name} (${outcome})`,dueDate:fd(days),completed:false,createdAt:new Date().toISOString()}];
    const u={...data,companies:uCo,tasks:uT,callLog:[...(data.callLog||[]),log],activity:act};setData(u);sv(u);setCallM(null)}
  async function fetchNews(){setNewsLoad(true);try{const n=await callAI(data.settings.apiKey,'Defence industry analyst. Brief factual intel. Bullet points. Focus: contracts, leadership changes, M&A, hiring, growth.',`Intel on ${company.name} (${company.sector||'Defence'}, ${company.country}). Notes: ${company.notes||'Defence company'}. 5-8 bullets.`);upCo({aiNews:n,newsDate:new Date().toISOString()})}catch(e){alert(e.message)}setNewsLoad(false)}
  const coTasks=data.tasks.filter(t=>t.companyId===cid&&!t.completed).sort((a,b)=>new Date(a.dueDate)-new Date(b.dueDate));
  const coLogs=(data.callLog||[]).filter(l=>l.companyId===cid).sort((a,b)=>new Date(b.date)-new Date(a.date));
  return(<div className="fi">
    <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:8}}><button className="bs bsm" onClick={()=>setView('companies')}>‚Üê Back</button><h2 style={{fontSize:22,fontWeight:300,flex:1}}>{company.name}</h2><select value={company.status} onChange={e=>upCo({status:e.target.value})} style={{maxWidth:140,fontSize:12}}>{STS.map(s=><option key={s.v} value={s.v}>{s.l}</option>)}</select><SB status={company.status}/></div>
    <div className="mono" style={{fontSize:11,color:'var(--tm)',marginBottom:24}}>{company.sector} ¬∑ {company.country}</div>
    <div style={{display:'grid',gridTemplateColumns:'5fr 3fr',gap:20}}>
      <div>
        <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:16,marginBottom:16}}><div className="sh" style={{color:'var(--amber)'}}>NOTES</div><textarea value={company.notes||''} onChange={e=>upCo({notes:e.target.value})} placeholder="Company notes..." style={{minHeight:50,fontSize:13}}/></div>
        {CATS.map(cat=>{const cts=(company.contacts||[]).filter(c=>c.category===cat.v);
          return(<div key={cat.v} style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:16,marginBottom:16}}>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}}><div><div className="sh" style={{color:cat.c,marginBottom:2}}>{cat.l.toUpperCase()}</div><div style={{fontSize:10,color:'var(--tm)'}}>{cat.d}</div></div><button className="bs bsm" onClick={()=>{setCtForm({...ctForm,category:cat.v});setShowAddCt(true)}}>+ Add</button></div>
            {cts.length===0&&<div style={{color:'var(--tm)',fontSize:12,fontStyle:'italic'}}>No contacts ‚Äî add from LinkedIn</div>}
            {cts.map(ct=>{const qt=data.tasks.find(t=>t.contactId===ct.id&&t.type==='email'&&!t.completed);const du=qt?daysFromNow(qt.dueDate):null;
              return(<div key={ct.id} className="cc">
                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:4}}>
                  <span style={{fontWeight:600,fontSize:14}}>{ct.name}</span><span style={{fontSize:12,color:'var(--tm)'}}>{ct.role}</span><span style={{flex:1}}/>
                  {ct.contacted?<span className="badge" style={{color:'var(--green)',background:'var(--green)18'}}>CONTACTED</span>
                  :qt?<span className="queue-badge">QUEUED ¬∑ {du<=0?'TODAY':du===1?'TOMORROW':`${du}d`}</span>
                  :<span className="badge" style={{color:'var(--tm)',background:'var(--bg2)'}}>NEW</span>}
                  {ct.linkedinNoted&&<span className="badge" style={{color:'var(--blue)',background:'var(--blue)18'}}>LI NOTED</span>}
                </div>
                <div style={{display:'flex',gap:16,fontSize:12,color:'var(--t2)',marginBottom:4,flexWrap:'wrap'}}>
                  {ct.email&&<span className="mono">‚úâ {ct.email}</span>}{ct.phone&&<span className="mono">‚òé {ct.phone}</span>}
                  {ct.linkedin&&<a href={ct.linkedin.startsWith('http')?ct.linkedin:'https://'+ct.linkedin} target="_blank" style={{color:'var(--blue)',textDecoration:'none'}}>LinkedIn ‚Üó</a>}
                </div>
                {ct.lastContactDate&&<div className="mono" style={{fontSize:10,color:'var(--tm)',marginBottom:4}}>Last: {ct.contactMethod} on {fmt(ct.lastContactDate)}{ct.lastCallOutcome&&` (${ct.lastCallOutcome})`}</div>}
                {ct.linkedinNoted&&<div className="mono" style={{fontSize:10,color:'var(--blue)',marginBottom:4}}>LinkedIn note sent {fmt(ct.linkedinNoteDate)}</div>}
                {ct.notes&&<div style={{fontSize:12,color:'var(--t2)',marginBottom:4}}>{ct.notes}</div>}
                {ct.lastCallNotes&&<div style={{fontSize:11,color:'var(--tm)',marginBottom:6,padding:'4px 8px',background:'var(--bg2)',borderRadius:4,borderLeft:'2px solid var(--green)'}}>Call: {ct.lastCallNotes}</div>}
                <div style={{display:'flex',gap:6,flexWrap:'wrap',marginTop:6}}>
                  {ct.email&&<button className="bb bx" onClick={()=>setEmailM({contact:ct,isFollowUp:false})}>‚úâ New Email</button>}
                  {ct.email&&ct.contacted&&<button className="bpu bx" onClick={()=>setEmailM({contact:ct,isFollowUp:true})}>‚óá Follow-up</button>}
                  <button className="bg bx" onClick={()=>setCallM(ct)}>‚òé Log Call</button>
                  {!ct.linkedinNoted?<button className="bb bx" onClick={()=>{
                    const act={...data.activity};const today=td();if(!act[today])act[today]={companies:[],emails:0,linkedin:0,calls:0};act[today]={...act[today],linkedin:(act[today].linkedin||0)+1};
                    const newStatus=(company.status==='prospect')?'contacted':company.status;
                    const uCo=data.companies.map(c=>{if(c.id!==cid)return c;return{...c,status:newStatus,updatedAt:new Date().toISOString(),contacts:c.contacts.map(x=>x.id===ct.id?{...x,linkedinNoted:true,linkedinNoteDate:td(),contacted:true,contactMethod:x.contactMethod||'linkedin',contactDate:x.contactDate||td(),lastContactDate:td()}:x)}});
                    const u={...data,companies:uCo,activity:act};setData(u);sv(u)}}>in Note Sent</button>
                  :<button className="bs bx" onClick={()=>upCt(ct.id,{linkedinNoted:false,linkedinNoteDate:''})}>‚Ü© in</button>}
                  {ct.contacted&&<button className="bs bx" onClick={()=>upCt(ct.id,{contacted:false,contactMethod:'',contactDate:'',lastContactDate:''})}>‚Ü©</button>}
                  <button className="bd bx" onClick={()=>delCt(ct.id)}>‚úï</button>
                </div>
                {justAdded===ct.id&&<LinkedInBox contact={ct} company={company} onCopy={handleLinkedInCopy}/>}
              </div>)})}
          </div>)})}
      </div>
      <div>
        <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:16,marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}}><div className="sh" style={{color:'var(--amber)',marginBottom:0}}>AI INTELLIGENCE</div><button className="bs bx" onClick={fetchNews} disabled={newsLoad}>{newsLoad?'...':'‚Üª Pull News'}</button></div>
          {company.aiNews?<div style={{fontSize:13,lineHeight:1.6,whiteSpace:'pre-wrap',color:'var(--t2)'}}>{company.aiNews}{company.newsDate&&<div className="mono" style={{fontSize:10,color:'var(--tm)',marginTop:8}}>Updated: {fmt(company.newsDate)}</div>}</div>:<div style={{color:'var(--tm)',fontSize:12}}>Click "Pull News" for AI intel.</div>}
        </div>
        <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:16,marginBottom:16}}>
          <div className="sh" style={{color:'var(--amber)'}}>OUTREACH QUEUE & TASKS ({coTasks.length})</div>
          {coTasks.length===0&&<div style={{color:'var(--tm)',fontSize:12}}>No tasks</div>}
          {coTasks.map(t=>{const ct=company.contacts?.find(c=>c.id===t.contactId);const d=daysFromNow(t.dueDate);
            return(<div key={t.id} style={{padding:'6px 0',borderBottom:'1px solid var(--bd)',display:'flex',alignItems:'center',gap:8,fontSize:12}}>
              <span style={{color:t.type==='call'?'var(--green)':t.type==='email'?'var(--blue)':'var(--purple)'}}>{t.type==='call'?'‚òé':t.type==='email'?'‚úâ':'‚óá'}</span>
              <span style={{flex:1,color:'var(--t2)'}}>{ct?ct.name+' ‚Äî ':''}{t.type==='email'?'Initial outreach':t.description}</span>
              <span className="mono" style={{fontSize:10,color:isOD(t.dueDate)?'var(--red)':d<=0?'var(--amber)':'var(--tm)'}}>{isOD(t.dueDate)?'OVERDUE':d===0?'TODAY':d===1?'TOMORROW':t.dueDate}</span>
              <button className="bs bx" onClick={()=>{const u={...data,tasks:data.tasks.map(x=>x.id===t.id?{...x,completed:true}:x)};setData(u);sv(u)}}>‚úì</button></div>)})}
        </div>
        <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:16}}>
          <div className="sh" style={{color:'var(--green)'}}>CALL LOG ({coLogs.length})</div>
          {coLogs.length===0&&<div style={{color:'var(--tm)',fontSize:12}}>No calls</div>}
          {coLogs.slice(0,10).map(l=>(<div key={l.id} className="cl"><div style={{display:'flex',justifyContent:'space-between',marginBottom:2}}><span style={{fontWeight:500}}>{l.contactName}</span><span className="mono" style={{fontSize:10,color:'var(--tm)'}}>{fmt(l.date)}</span></div><div><span style={{fontSize:10,fontWeight:600,color:l.outcome==='spoke'?'var(--green)':l.outcome==='voicemail'?'var(--blue)':'var(--tm)'}}>{l.outcome==='spoke'?'‚úì Spoke':l.outcome==='voicemail'?'‚úâ VM':'‚úó No ans'}</span>{l.notes&&<span style={{color:'var(--t2)',marginLeft:8}}>{l.notes}</span>}</div></div>))}
        </div>
      </div>
    </div>
    {showAddCt&&<div className="mo" onClick={()=>setShowAddCt(false)}><div className="ml" onClick={e=>e.stopPropagation()}><h3>Add Decision Maker</h3><p style={{fontSize:12,color:'var(--tm)',marginBottom:4}}>Paste from LinkedIn ‚Äî connect message + outreach task auto-created</p><p style={{fontSize:11,color:'var(--blue)',marginBottom:16}}>Contacts at same company spaced 2 weeks apart.</p><div className="fr"><div className="fg"><label>Full Name</label><input value={ctForm.name} onChange={e=>setCtForm({...ctForm,name:e.target.value})} placeholder="John Smith" autoFocus/></div><div className="fg"><label>Job Title</label><input value={ctForm.role} onChange={e=>setCtForm({...ctForm,role:e.target.value})} placeholder="Managing Director"/></div></div><div className="fg"><label>Category</label><select value={ctForm.category} onChange={e=>setCtForm({...ctForm,category:e.target.value})}>{CATS.map(c=><option key={c.v} value={c.v}>{c.l} ({c.d})</option>)}</select></div><div className="fr3"><div className="fg"><label>Email</label><input value={ctForm.email} onChange={e=>setCtForm({...ctForm,email:e.target.value})} placeholder="name@co.com"/></div><div className="fg"><label>Phone</label><input value={ctForm.phone} onChange={e=>setCtForm({...ctForm,phone:e.target.value})} placeholder="+44..."/></div><div className="fg"><label>LinkedIn</label><input value={ctForm.linkedin} onChange={e=>setCtForm({...ctForm,linkedin:e.target.value})} placeholder="linkedin.com/in/..."/></div></div><div className="fg"><label>Notes</label><textarea value={ctForm.notes} onChange={e=>setCtForm({...ctForm,notes:e.target.value})} placeholder="Background..." style={{minHeight:60}}/></div><div style={{display:'flex',gap:8,marginTop:16,justifyContent:'flex-end'}}><button className="bs" onClick={()=>setShowAddCt(false)}>Cancel</button><button className="bp" onClick={addCt}>Save & Queue Outreach</button></div></div></div>}
    {emailM&&<EmailModal contact={emailM.contact} company={company} data={data} setData={setData} isFollowUp={emailM.isFollowUp} onClose={()=>setEmailM(null)} onSent={handleSent}/>}
    {callM&&<CallModal contact={callM} company={company} onClose={()=>setCallM(null)} onSave={handleCall}/>}
  </div>);
}

function TaskList({data,setData,setView,setSel}){
  const [filter,setFilter]=useState('open');const [showAdd,setShowAdd]=useState(false);
  const [form,setForm]=useState({companyId:'',type:'followup',description:'',dueDate:''});
  const tasks=data.tasks.filter(t=>{if(filter==='open')return!t.completed;if(filter==='completed')return t.completed;if(filter==='overdue')return!t.completed&&isOD(t.dueDate);if(filter==='calls')return!t.completed&&t.type==='call';if(filter==='emails')return!t.completed&&(t.type==='email'||t.type==='followup');return true}).sort((a,b)=>{if(a.completed!==b.completed)return a.completed?1:-1;return new Date(a.dueDate)-new Date(b.dueDate)});
  return(<div className="fi">
    <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:24}}><h2 style={{fontSize:22,fontWeight:300}}><span style={{color:'var(--amber)'}} className="mono">‚óá</span> Tasks</h2><button className="bp" onClick={()=>setShowAdd(true)}>+ Add Task</button></div>
    <div style={{display:'flex',gap:8,marginBottom:20,flexWrap:'wrap'}}>{['open','overdue','calls','emails','completed','all'].map(f=><button key={f} className={filter===f?'bp':'bs'} style={{textTransform:'capitalize'}} onClick={()=>setFilter(f)}>{f}{f==='overdue'&&` (${data.tasks.filter(t=>!t.completed&&isOD(t.dueDate)).length})`}</button>)}</div>
    <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10}}>
      {tasks.length===0&&<div style={{padding:32,textAlign:'center',color:'var(--tm)',fontSize:13}}>No tasks</div>}
      {tasks.map(t=>{const co=data.companies.find(c=>c.id===t.companyId);return(
        <div key={t.id} style={{display:'flex',alignItems:'center',gap:12,padding:'10px 16px',borderBottom:'1px solid var(--bd)',opacity:t.completed?.5:1}}>
          <input type="checkbox" checked={t.completed} onChange={()=>{const u={...data,tasks:data.tasks.map(x=>x.id===t.id?{...x,completed:!x.completed}:x)};setData(u);sv(u)}} style={{width:16,height:16,cursor:'pointer'}}/>
          <span style={{fontSize:16,color:t.type==='call'?'var(--green)':t.type==='email'?'var(--blue)':'var(--purple)'}}>{t.type==='call'?'‚òé':t.type==='email'?'‚úâ':'‚óá'}</span>
          {co&&<span className="badge" style={{cursor:'pointer',color:'var(--amber)',background:'var(--amber)18'}} onClick={()=>{addRecent(co.id,co.name);setSel(co.id);setView('companyDetail')}}>{co.name}</span>}
          <span style={{flex:1,fontSize:13,textDecoration:t.completed?'line-through':'none'}}>{t.description}</span>
          <span className="mono" style={{fontSize:11,color:isOD(t.dueDate)?'var(--red)':'var(--tm)'}}>{t.dueDate}</span>
          <button className="bd bx" onClick={()=>{const u={...data,tasks:data.tasks.filter(x=>x.id!==t.id)};setData(u);sv(u)}}>‚úï</button>
        </div>)})}
    </div>
    {showAdd&&<div className="mo" onClick={()=>setShowAdd(false)}><div className="ml" onClick={e=>e.stopPropagation()}><h3>Add Task</h3><div className="fg"><label>Company</label><select value={form.companyId} onChange={e=>setForm({...form,companyId:e.target.value})}><option value="">‚Äî None ‚Äî</option>{data.companies.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div><div className="fr"><div className="fg"><label>Type</label><select value={form.type} onChange={e=>setForm({...form,type:e.target.value})}><option value="email">Email</option><option value="call">Call</option><option value="followup">Follow-up</option></select></div><div className="fg"><label>Due Date</label><input type="date" value={form.dueDate} onChange={e=>setForm({...form,dueDate:e.target.value})}/></div></div><div className="fg"><label>Description</label><input value={form.description} onChange={e=>setForm({...form,description:e.target.value})} placeholder="What needs doing?"/></div><div style={{display:'flex',gap:8,marginTop:16,justifyContent:'flex-end'}}><button className="bs" onClick={()=>setShowAdd(false)}>Cancel</button><button className="bp" onClick={()=>{if(!form.description.trim()||!form.dueDate)return;const u={...data,tasks:[...data.tasks,{id:gid(),...form,completed:false,createdAt:new Date().toISOString()}]};setData(u);sv(u);setForm({companyId:'',type:'followup',description:'',dueDate:''});setShowAdd(false)}}>Add</button></div></div></div>}
  </div>);
}

function TrackRecord({data,setData}){const [s,setS]=useState(false);
  return(<div className="fi"><h2 style={{fontSize:22,fontWeight:300,marginBottom:8}}><span style={{color:'var(--amber)'}} className="mono">‚ñ£</span> Track Record</h2><p style={{color:'var(--t2)',fontSize:13,marginBottom:8,maxWidth:600}}>Your background. AI uses this to personalise emails.</p><p style={{color:'var(--amber)',fontSize:12,marginBottom:24,maxWidth:600,background:'var(--amberd)33',padding:'8px 12px',borderRadius:6}}>‚ö† Client names automatically anonymised in AI emails.</p><div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:20}}><div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}}><div className="sh" style={{color:'var(--amber)',marginBottom:0}}>YOUR BACKGROUND</div>{s&&<span className="mono" style={{fontSize:11,color:'var(--green)'}}>SAVED ‚úì</span>}</div><textarea value={data.trackRecord||''} onChange={e=>{const u={...data,trackRecord:e.target.value};setData(u);sv(u);setS(true);setTimeout(()=>setS(false),1000)}} style={{minHeight:400,fontSize:13,lineHeight:1.7}}/></div></div>)}

function Settings({data,setData,fileConnected,onConnect}){
  const [key,setKey]=useState(data.settings?.apiKey||'');const [saved,setSaved]=useState(false);
  return(<div className="fi" style={{maxWidth:560}}>
    <h2 style={{fontSize:22,fontWeight:300,marginBottom:24}}><span style={{color:'var(--amber)'}} className="mono">‚öô</span> Settings</h2>
    <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:20,marginBottom:20}}>
      <div className="sh" style={{color:'var(--amber)'}}>ANTHROPIC API KEY</div>
      <p style={{fontSize:12,color:'var(--tm)',marginBottom:12}}><a href="https://console.anthropic.com" target="_blank" style={{color:'var(--amber)'}}>console.anthropic.com</a></p>
      <div style={{display:'flex',gap:8}}><input type="password" value={key} onChange={e=>setKey(e.target.value)} placeholder="sk-ant-..." style={{flex:1}}/><button className="bp" onClick={()=>{const u={...data,settings:{...data.settings,apiKey:key}};setData(u);sv(u);setSaved(true);setTimeout(()=>setSaved(false),2000)}}>Save</button></div>
      {saved&&<div className="mono" style={{fontSize:11,color:'var(--green)',marginTop:8}}>SAVED ‚úì</div>}
    </div>
    <div style={{background:'var(--bgc)',border:`1px solid ${fileConnected?'var(--green)':'var(--amber)'}33`,borderRadius:10,padding:20,marginBottom:20}}>
      <div className="sh" style={{color:fileConnected?'var(--green)':'var(--amber)'}}>üíæ AUTO-SAVE FILE</div>
      <p style={{fontSize:12,color:'var(--t2)',marginBottom:12}}>{fileConnected?'Connected ‚Äî your data is being saved to a file on your computer. If you clear your browser cache, just load from this file.':'Connect a save file so your data survives browser cache clears. You\'ll need to reconnect once each time you open the app.'}</p>
      <div style={{display:'flex',gap:8}}>
        <button className={fileConnected?'bg':'bp'} onClick={onConnect}>{fileConnected?'‚óè Connected ‚Äî Change File':'Connect Save File'}</button>
        {fileConnected&&<button className="bs" onClick={async()=>{await writeToFile(data);alert('Saved!')}}>Save Now</button>}
      </div>
      {!fileConnected&&<p className="mono" style={{fontSize:10,color:'var(--amber)',marginTop:8}}>‚ö† NOT CONNECTED ‚Äî data only in browser cache</p>}
    </div>
    <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:20}}>
      <div className="sh" style={{color:'var(--amber)'}}>DATA</div>
      <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
        <button className="bs" onClick={()=>{const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`recon-${td()}.json`;a.click()}}>‚Üì Export JSON</button>
        <button className="bs" onClick={()=>exportCSV(data)}>‚Üì Export CSV</button>
        <label className="bs" style={{display:'inline-flex',alignItems:'center',cursor:'pointer'}}>‚Üë Import<input type="file" accept=".json" onChange={e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.companies){d.callLog=d.callLog||[];d.activity=d.activity||{};setData(d);sv(d);setKey(d.settings?.apiKey||'');alert('Done!')}}catch{alert('Error')}};r.readAsText(f)}} style={{display:'none'}}/></label>
        <button className="bd" onClick={()=>{if(confirm('Delete ALL?')&&confirm('Sure?')){const f={companies:[],tasks:[],trackRecord:'',callLog:[],activity:{},settings:{apiKey:data.settings?.apiKey}};setData(f);sv(f)}}}>‚ö† Clear</button>
        <button className="bs" onClick={async()=>{if(confirm('Reset to seed? Contacts/tasks/activity lost.')){localStorage.removeItem(SK);const f=await lds();setData(f);setKey(f.settings?.apiKey||'')}}}>‚Ü∫ Reset</button>
      </div>
    </div>
  </div>);
}

function App(){
  const [data,setData]=useState(null);const [loading,setLoading]=useState(true);const [view,setView]=useState('actions');const [sel,setSel]=useState(null);
  const [fileConnected,setFileConnected]=useState(false);const [showRestore,setShowRestore]=useState(false);

  useEffect(()=>{
    const existing=ld();
    if(existing){existing.callLog=existing.callLog||[];existing.activity=existing.activity||{};setData(existing);setLoading(false)}
    else{
      // localStorage is empty ‚Äî show restore screen
      setShowRestore(true);setLoading(false);
    }
  },[]);

  async function handleRestore(){
    const restored=await loadFromFile();
    if(restored){setData(restored);sv(restored);setFileConnected(true);setShowRestore(false)}
    else{alert('Could not load file.')}
  }
  async function handleFresh(){const f=await lds();setData(f);setShowRestore(false)}
  async function handleConnect(){
    const ok=await connectSaveFile();
    if(ok){setFileConnected(true);if(data)await writeToFile(data)}
  }
  async function handleSaveNow(){if(data&&_fileHandle){const ok=await writeToFile(data);if(ok)alert('Saved to file!')}}

  if(loading)return<div style={{display:'flex',alignItems:'center',justifyContent:'center',height:'100vh',background:'var(--bg0)'}}><div style={{textAlign:'center'}}><div className="mono" style={{fontSize:24,color:'var(--amber)',letterSpacing:4,marginBottom:12}}>‚ñ£ RECON</div><div style={{color:'var(--tm)',fontSize:13}}>Loading...</div></div></div>;
  if(showRestore)return<RestoreScreen onRestore={handleRestore} onFresh={handleFresh}/>;
  if(!data)return null;

  const ac=data.tasks.filter(t=>!t.completed&&(isOD(t.dueDate)||isT(t.dueDate)||isS(t.dueDate))).length;
  const rv=()=>{switch(view){case'actions':return<DailyActions data={data} setData={setData} setView={setView} setSel={setSel}/>;case'companies':return<CompanyList data={data} setData={setData} setView={setView} setSel={setSel}/>;case'contacts':return<ContactsView data={data} setView={setView} setSel={setSel}/>;case'companyDetail':return<CompanyDetail cid={sel} data={data} setData={setData} setView={setView}/>;case'tasks':return<TaskList data={data} setData={setData} setView={setView} setSel={setSel}/>;case'trackrecord':return<TrackRecord data={data} setData={setData}/>;case'settings':return<Settings data={data} setData={setData} fileConnected={fileConnected} onConnect={handleConnect}/>;default:return<DailyActions data={data} setData={setData} setView={setView} setSel={setSel}/>}};
  return<div style={{display:'flex',minHeight:'100vh'}}><Sidebar view={view} setView={setView} ac={ac} fileConnected={fileConnected} onConnect={handleConnect} onSaveNow={handleSaveNow}/><main style={{marginLeft:220,flex:1,padding:'32px 40px',maxWidth:1200}}>{rv()}</main></div>;
}
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
