<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RECON ‚Äî Defence Sector Prospecting</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg0:#0a0e17;--bg1:#111827;--bg2:#1a2235;--bgc:#151d2e;--bgh:#1e2a3f;--bd:#243049;--bdl:#2d3a52;--t1:#e8ecf4;--t2:#8b95a8;--tm:#5a6478;--amber:#f59e0b;--amberd:#92600a;--green:#10b981;--greend:#065f46;--red:#ef4444;--redd:#7f1d1d;--blue:#3b82f6;--blued:#1e3a5f;--purple:#8b5cf6;--sp:var(--amber);--sc:var(--blue);--se:var(--purple);--spr:#ec4899;--sw:var(--green);--sl:var(--red);--sd:#6b7280}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg0);color:var(--t1);min-height:100vh;overflow-x:hidden}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg0)}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}
.mono{font-family:'JetBrains Mono',monospace}
input,textarea,select{font-family:'DM Sans',sans-serif;background:var(--bg1);border:1px solid var(--bd);color:var(--t1);padding:8px 12px;border-radius:6px;font-size:13px;outline:none;width:100%;transition:border-color .2s}
input:focus,textarea:focus,select:focus{border-color:var(--amber)}
textarea{resize:vertical;min-height:80px}select{cursor:pointer}
button{font-family:'DM Sans',sans-serif;cursor:pointer;border:none;border-radius:6px;font-size:13px;font-weight:500;padding:8px 16px;transition:all .2s}
.bp{background:var(--amber);color:#000}.bp:hover{background:#fbbf24}
.bs{background:var(--bg2);color:var(--t1);border:1px solid var(--bd)}.bs:hover{background:var(--bgh)}
.bd{background:var(--redd);color:var(--red)}.bd:hover{background:#991b1b}
.bg{background:var(--greend);color:var(--green)}.bg:hover{background:#047857}
.bb{background:var(--blued);color:var(--blue)}.bb:hover{background:#1e40af}
.bpu{background:var(--purple)22;color:var(--purple);border:1px solid var(--purple)33}.bpu:hover{background:var(--purple)44}
.bsm{padding:4px 10px;font-size:12px}.bx{padding:2px 8px;font-size:11px}
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;font-family:'JetBrains Mono',monospace}
.mo{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px)}
.ml{background:var(--bg1);border:1px solid var(--bd);border-radius:12px;padding:24px;width:90%;max-width:600px;max-height:85vh;overflow-y:auto}
.ml h3{font-size:16px;font-weight:600;margin-bottom:16px;color:var(--amber);font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:1px}
.fg{margin-bottom:12px}.fg label{display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--t2);margin-bottom:4px;font-family:'JetBrains Mono',monospace}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:12px}.fr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
@keyframes fi{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}.fi{animation:fi .3s ease}
.sh{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;font-family:'JetBrains Mono',monospace}
.cc{padding:12px;background:var(--bg1);border-radius:8px;margin-bottom:8px;border:1px solid var(--bd)}.cc:hover{border-color:var(--bdl)}
.cl{padding:8px 10px;background:var(--bg2);border-radius:6px;margin-bottom:6px;font-size:12px;border-left:3px solid var(--green)}
.li-box{margin-top:10px;padding:12px;background:#1a1a2e;border:1px solid #2563eb44;border-radius:8px;border-left:3px solid var(--blue)}
.subj-row{display:flex;align-items:center;gap:8px;margin-bottom:12px;padding:10px 12px;background:var(--bg0);border:1px solid var(--bd);border-radius:8px}
.subj-row input{background:transparent;border:none;font-size:14px;font-weight:600;padding:0;flex:1}
.subj-row input:focus{border:none}
.progress-dots{display:flex;gap:3px;align-items:center}
.progress-dot{width:8px;height:8px;border-radius:50%;border:1.5px solid var(--bd)}
.progress-dot.filled{border-color:var(--green);background:var(--green)}
.progress-dot.partial{border-color:var(--amber);background:var(--amber)}
.queue-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;font-family:'JetBrains Mono',monospace;background:var(--blued);color:var(--blue);border:1px solid var(--blue)33}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-hdr{font-size:9px;text-align:center;color:var(--tm);padding:4px 0;font-family:'JetBrains Mono',monospace;font-weight:600}
.cal-day{aspect-ratio:1;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:10px;font-family:'JetBrains Mono',monospace;position:relative;cursor:default;transition:all .15s}
.cal-day:hover{transform:scale(1.15);z-index:2}
.cal-future{background:var(--bg2);color:var(--tm);opacity:.3}
.cal-noact{background:var(--bg2);color:var(--tm)}
.cal-partial{background:#92600a44;color:var(--amber);border:1px solid var(--amber)44}
.cal-full{background:var(--greend);color:var(--green);border:1px solid var(--green)44;font-weight:700}
.cal-today{outline:2px solid var(--amber);outline-offset:1px}
.target-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--bd)}
.target-row:last-child{border-bottom:none}
.target-bar{flex:1;height:6px;background:var(--bg2);border-radius:3px;overflow:hidden}
.target-fill{height:100%;border-radius:3px;transition:width .4s ease}
.recent-chip{display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--bg1);border:1px solid var(--bd);border-radius:8px;cursor:pointer;transition:all .15s;font-size:12px;white-space:nowrap}
.recent-chip:hover{border-color:var(--amber);background:var(--bgh)}
.save-bar{display:flex;align-items:center;gap:8px;padding:6px 12px;border-radius:6px;font-size:11px;font-family:'JetBrains Mono',monospace;cursor:pointer;transition:all .15s}
.save-bar:hover{background:var(--bgh)}
.restore-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:var(--bg0);gap:24px;text-align:center}
.user-sw{display:flex;gap:2px;background:var(--bg2);border-radius:8px;padding:3px;border:1px solid var(--bd)}
.user-btn{padding:8px 16px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .15s;font-family:'DM Sans',sans-serif}
.user-btn.active{background:var(--amber);color:#000}
.user-btn:not(.active){background:transparent;color:var(--t2)}
.user-btn:not(.active):hover{color:var(--t1);background:var(--bgh)}
.vs-card{background:var(--bgc);border:1px solid var(--bd);border-radius:10px;padding:16px;flex:1}
.vs-bar{display:flex;height:8px;border-radius:4px;overflow:hidden;background:var(--bg2);margin:6px 0}
.owner-tag{font-size:9px;padding:1px 6px;border-radius:3px;font-family:'JetBrains Mono',monospace;font-weight:600;letter-spacing:.5px}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useRef,useCallback}=React;
const SK='recon_data',RK='recon_recent';

// ‚îÄ‚îÄ‚îÄ USERS ‚îÄ‚îÄ‚îÄ
const USERS={
  stephen:{id:'stephen',name:'Stephen',initials:'SB',color:'var(--amber)',targets:{companies:5,emails:5,linkedin:5}},
  ebrima:{id:'ebrima',name:'Ebrima',initials:'EB',color:'var(--green)',targets:{companies:25,emails:25,linkedin:25}}
};

let _fileHandle=null;let _saveTimeout=null;
async function writeToFile(data){if(!_fileHandle)return;try{const w=await _fileHandle.createWritable();await w.write(JSON.stringify(data,null,2));await w.close();return true}catch(e){console.error('File save failed:',e);_fileHandle=null;return false}}
async function connectSaveFile(){
  if(!window.showSaveFilePicker){alert('Your browser doesn\'t support auto-save. Use Export JSON in Settings to back up manually.');return false}
  try{_fileHandle=await window.showSaveFilePicker({suggestedName:'recon-data.json',types:[{description:'JSON',accept:{'application/json':['.json']}}]});return true}catch(e){if(e.name!=='AbortError')alert('Error: '+e.message);return false}
}
async function loadFromFile(){
  try{
    const[h]=await window.showOpenFilePicker({types:[{description:'JSON',accept:{'application/json':['.json']}}]});
    const f=await h.getFile();
    const t=await f.text();
    const d=JSON.parse(t);
    if(d.companies){d.callLog=d.callLog||[];d.activity=d.activity||{};d.tasks=d.tasks||[];d.settings=d.settings||{apiKey:''};d.trackRecord=d.trackRecord||'';_fileHandle=h;return d}
    else{alert('File loaded but no companies found. Is this the right file?');return null}
  }catch(e){
    if(e.name==='AbortError')return null;// user cancelled picker
    alert('Error loading file: '+e.message);console.error('Load error:',e);return null}
}

function ld(){try{const r=localStorage.getItem(SK);if(r){const p=JSON.parse(r);if(p.companies?.length>0)return p}}catch(e){}return null}
async function lds(){try{const r=await fetch('./data.json');if(r.ok){const d=await r.json();d.callLog=d.callLog||[];d.activity=d.activity||{};sv(d);return d}}catch(e){}return{companies:[],tasks:[],trackRecord:'',callLog:[],activity:{},settings:{apiKey:''}}}

// ‚îÄ‚îÄ‚îÄ DATA MIGRATION ‚îÄ‚îÄ‚îÄ
function migrateData(d){
  if(d._version>=3)return d;
  let tasks=(d.tasks||[]).map(t=>({...t,userId:t.userId||'stephen'}));
  let callLog=(d.callLog||[]).map(l=>({...l,userId:l.userId||'stephen'}));
  let companies=(d.companies||[]).map(co=>{
    const cts=(co.contacts||[]).map(ct=>({...ct,userId:ct.userId||'stephen'}));
    const hasActivity=cts.some(ct=>ct.contacted);
    return{...co,contacts:cts,
      enrichedDate:co.enrichedDate||((co.notes||'').length>50?co.updatedAt||new Date().toISOString():null),
      claimedBy:co.claimedBy||(hasActivity?'stephen':cts.length>0?'stephen':null),
      claimDate:co.claimDate||(hasActivity?co.updatedAt||new Date().toISOString():cts.length>0?co.updatedAt||new Date().toISOString():null)};
  });
  // Migrate activity: if keyed by date directly, wrap under stephen
  let activity=d.activity||{};
  if(!activity.stephen&&!activity.ebrima){
    activity={stephen:activity,ebrima:{}};
  }
  return{...d,companies,tasks,callLog,activity,_version:3};
}

function sv(d){
  if(!d||!Array.isArray(d.companies)){console.error('BLOCKED: tried to save corrupted data');return}
  try{localStorage.setItem(SK,JSON.stringify(d))}catch(e){}
  if(_fileHandle){clearTimeout(_saveTimeout);_saveTimeout=setTimeout(()=>writeToFile(d),1000)}
}

function gid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8)}
function td(){return new Date().toISOString().split('T')[0]}
function fd(n){const d=new Date();d.setDate(d.getDate()+n);return d.toISOString().split('T')[0]}
function fmt(d){if(!d)return'‚Äî';try{return new Date(d).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})}catch{return d}}
function isOD(d){return d&&d<td()}
function isT(d){return d===td()}
function isS(d){if(!d)return false;const x=(new Date(d)-new Date(td()))/864e5;return x>=0&&x<=2}
function daysFromNow(d){if(!d)return 999;return Math.round((new Date(d)-new Date(td()))/864e5)}

function getRecent(){try{return JSON.parse(localStorage.getItem(RK)||'[]')}catch{return[]}}
function addRecent(id,name){let r=getRecent().filter(x=>x.id!==id);r.unshift({id,name,t:Date.now()});if(r.length>5)r=r.slice(0,5);localStorage.setItem(RK,JSON.stringify(r))}

function getAct(data,uid,date){const ua=(data.activity||{})[uid]||{};const d=ua[date]||{companies:[],emails:0,linkedin:0,calls:0};return{companies:d.companies||[],emails:d.emails||0,linkedin:d.linkedin||0,calls:d.calls||0}}

function logActAtomic(data,uid,type,companyId){
  const today=td();const act={...data.activity};
  if(!act[uid])act[uid]={};
  const ua={...act[uid]};
  if(!ua[today])ua[today]={companies:[],emails:0,linkedin:0,calls:0};
  const d={...ua[today]};
  if(type==='company'&&companyId&&!(d.companies||[]).includes(companyId))d.companies=[...(d.companies||[]),companyId];
  if(type==='email')d.emails=(d.emails||0)+1;
  if(type==='linkedin')d.linkedin=(d.linkedin||0)+1;
  if(type==='call')d.calls=(d.calls||0)+1;
  ua[today]=d;act[uid]=ua;return act;
}

const STS=[{v:'prospect',l:'Prospect',c:'var(--sp)'},{v:'contacted',l:'Contacted',c:'var(--sc)'},{v:'engaged',l:'Engaged',c:'var(--se)'},{v:'proposal',l:'Proposal',c:'var(--spr)'},{v:'won',l:'Won',c:'var(--sw)'},{v:'lost',l:'Lost',c:'var(--sl)'},{v:'dormant',l:'Dormant',c:'var(--sd)'}];
const CATS=[{v:'management',l:'General Management',s:'MGMT',d:'MD, Director, CEO, COO',c:'var(--amber)'},{v:'engineering',l:'Engineering Leadership',s:'ENG',d:'CTO, Eng Director, Tech Lead',c:'var(--blue)'},{v:'hr',l:'HR / Recruitment',s:'HR',d:'HR Director, Talent, Recruitment',c:'var(--purple)'}];

function getAnonTR(tr){if(!tr)return'Defence sector recruitment specialist with extensive track record.';return tr.replace(/Vialite\s*Communications?/gi,'a leading RF over Fibre company').replace(/PPM\s*(?:Power|Systems|Ltd)/gi,'a specialist RF/power electronics company').replace(/L3Harris\s*(?:ASV|TRL)?/gi,'a major defence prime').replace(/Jankel\s*(?:Armouring)?/gi,'a vehicle armouring specialist').replace(/NP\s*Aerospace/gi,'an armour and vehicle company').replace(/MSI\s*Defence\s*Systems?/gi,'a weapon systems manufacturer').replace(/Seebyte/gi,'a UUV software company').replace(/CRFS/gi,'an RF spectrum monitoring company').replace(/MTU\s*Maintenance/gi,'a major aeroengine MRO provider').replace(/Trelleborg/gi,'a global aerospace seals manufacturer').replace(/Drumgrange/gi,'a military comms company').replace(/Enterprise\s*Control\s*Systems?/gi,'a datalinks/EW equipment company').replace(/Gooch\s*(?:&|and)\s*Housego/gi,'an optical subsystems company').replace(/BAE\s*Systems?/gi,'a major defence prime').replace(/Peter\s*Hardisty/gi,'a senior industry figure').replace(/Emcore/gi,'a competitor').replace(/DE&S/gi,'a key MOD customer')}



const BANNED_PHRASES=`"I hope this finds you well", "reaching out", "in today's", "rapidly evolving", "I wanted to", "leverage", "synergy", "landscape", "ecosystem", "holistic", "streamline", "talent solutions", "value proposition", "strategic partnership", "I'd love to", "excited to", "thrilled", "delighted", "comprehensive", "robust", "cutting-edge", "innovative approach", "unique position", "deep understanding", "proven track record", "at the forefront", "drive results", "moving forward", "circle back", "touch base", "best-in-class", "end-to-end", "seamless", "bespoke", "tailored solutions"`;
const BANNED_FU=`"just following up", "wanted to circle back", "I hope this finds you", "touching base", "checking in to see if", "I understand you're busy", "float to the top of your inbox", "per my last email", "as mentioned", "comprehensive", "robust", "synergy"`;

const EMAIL_SYS_STEPHEN={management:{initial:`You write BD emails for a specialist defence/aerospace executive search consultancy, Banner Lane. Writing to a SENIOR LEADER (MD, Director, CEO, COO).
CRITICAL STYLE RULES:
- Write like a real person typing an email at their desk. Not a marketing department.
- Use SIMPLE words. "Help" not "assist". "Find" not "identify". "Talk" not "explore synergies".
- Vary sentence length. Some short. Some a bit longer.
- Start with something specific to them or their company.
- ONE idea per paragraph. Short paragraphs. 1-3 sentences.
- End with a single, specific ask. "Worth a 10 min call next week?" not "I'd welcome the opportunity to discuss."
BANNED PHRASES: ${BANNED_PHRASES}
FOCUS: Leadership hires, functional heads, strategic talent. Reference types of senior roles placed (no client names).
If company intel is provided (headcount, specialisms, programmes, growth signals), weave it in naturally to show you've done your homework.
Keep under 150 words. Sign off with "Kind regards,\\nStephen\\nBanner Lane".
Format:\nSUBJECT: [subject line]\n---\n[email body]`,
followup:`Follow-up to a senior leader. Emailed days ago, no reply. Under 80 words.
STYLE: Sound like a human checking in, not a CRM sequence. New angle or something useful. One or two short paragraphs max.
BANNED: ${BANNED_FU}
Sign off with "Kind regards,\\nStephen\\nBanner Lane".\nFormat:\nSUBJECT: [subject line]\n---\n[body]`},
engineering:{initial:`You write BD emails for Banner Lane, a specialist defence/aerospace executive search consultancy. Writing to an ENGINEERING LEADER (CTO, Eng Director, Tech Lead).
STYLE: Peer-to-peer. Engineer to engineer. No sales language. Be specific about the types of people you find ‚Äî mention actual skill areas. Short, direct sentences. Reference a real problem they probably have (cleared engineers are hard to find, niche skills take months, competitors poaching).
BANNED PHRASES: ${BANNED_PHRASES}
FOCUS: Hard-to-find engineers. Cleared talent. Niche skillsets (RF, embedded, FPGA, optical, DSP). If company specialisms or programmes provided, reference them.
Under 150 words. Sign off with "Kind regards,\\nStephen\\nBanner Lane".\nFormat:\nSUBJECT: [subject line]\n---\n[body]`,
followup:`Follow-up to engineering leader. Under 80 words. Don't repeat first email. Quick, casual, credible. Mention a specific hiring pain point.
BANNED: ${BANNED_FU}
Sign off with "Kind regards,\\nStephen\\nBanner Lane".\nFormat:\nSUBJECT: [subject line]\n---\n[body]`},
hr:{initial:`You write BD emails for Banner Lane, a specialist defence/aerospace executive search consultancy. Writing to HR/RECRUITMENT.
STYLE: Fellow professional, not vendor pitching. Be specific about what makes you different ‚Äî retained search, headhunting competitors, cleared personnel not on job boards. Acknowledge they get 50 recruiter emails a week. Don't sound like the other 49.
BANNED PHRASES: ${BANNED_PHRASES}
FOCUS: Hard-to-fill roles. Cleared talent. Salary benchmarking. Retained search. Supplementing their team.
Under 150 words. Sign off with "Kind regards,\\nStephen\\nBanner Lane".\nFormat:\nSUBJECT: [subject line]\n---\n[body]`,
followup:`Follow-up to HR. Under 80 words. Offer something useful ‚Äî market observation, salary trend, recent relevant search type.
BANNED: ${BANNED_FU}
Sign off with "Kind regards,\\nStephen\\nBanner Lane".\nFormat:\nSUBJECT: [subject line]\n---\n[body]`}};

const EMAIL_SYS_EBRIMA={management:{initial:`You write BD emails on behalf of Banner Lane, a specialist defence/aerospace executive search consultancy. The email is FROM Ebrima, Market Intelligence Analyst, who tracks the defence sector and identifies companies where Banner Lane's founder, Stephen Start, can add value. Stephen personally leads every search assignment.
WRITING TO: A SENIOR LEADER (MD, Director, CEO, COO).
CRITICAL STYLE RULES:
- Professional, warm, direct. Ebrima is a market analyst who has identified their company as relevant and is connecting them with the right person.
- Be transparent: Ebrima is introducing Stephen, not pretending to be the consultant.
- Start with something specific about THEIR company ‚Äî headcount growth, programmes, specialisms, hiring signals. Show homework has been done.
- The ask is ALWAYS a short conversation or call with Stephen. "Would you be open to a brief call with Stephen?" or "Happy to set up a 10 min chat with Stephen if useful."
- NOT a pitch meeting. A conversation.
- Keep it human. Vary sentence length. Simple words.
BANNED PHRASES: ${BANNED_PHRASES}
FOCUS: Why Stephen and Banner Lane are relevant to THEIR business. Types of leadership/senior hires placed in their sector. If company intel provided (headcount, specialisms, programmes, growth), USE it.
Under 150 words. Sign off with "Kind regards,\\nEbrima\\nMarket Intelligence Analyst\\nBanner Lane".
Format:\nSUBJECT: [subject line]\n---\n[email body]`,
followup:`Follow-up from Ebrima (Market Intelligence Analyst, Banner Lane) to a senior leader. Emailed a few days ago on behalf of Stephen Start. No reply yet. Under 80 words. New angle or added value ‚Äî a market observation, a relevant trend in their sector. Light, human. The ask is still a short call with Stephen.
BANNED: ${BANNED_FU}
Sign off with "Kind regards,\\nEbrima\\nBanner Lane".\nFormat:\nSUBJECT: [subject line]\n---\n[body]`},
engineering:{initial:`You write BD emails on behalf of Banner Lane, a specialist defence/aerospace executive search consultancy. FROM Ebrima, Market Intelligence Analyst. He tracks the defence talent market and connects relevant companies with Stephen Start, the founder.
WRITING TO: An ENGINEERING LEADER (CTO, Eng Director, Tech Lead).
STYLE: Technically aware but honest that Stephen is the deep expert. Ebrima tracks the market ‚Äî reference the types of engineers Banner Lane finds (RF, embedded, FPGA, DSP, cleared talent). The email should feel like a market analyst who understands their sector connecting them with the right specialist.
If company specialisms or key programmes are provided, reference them specifically. Show you know what they build and therefore what kind of engineers they need.
BANNED PHRASES: ${BANNED_PHRASES}
Under 150 words. Ask: brief conversation with Stephen about their technical hiring challenges.
Sign off with "Kind regards,\\nEbrima\\nMarket Intelligence Analyst\\nBanner Lane".
Format:\nSUBJECT: [subject line]\n---\n[body]`,
followup:`Follow-up from Ebrima (Market Intelligence Analyst, Banner Lane) to engineering leader. On behalf of Stephen. Under 80 words. Different angle ‚Äî reference a specific technical hiring challenge in their sector or a skill area that's hard to fill right now.
BANNED: ${BANNED_FU}
Sign off with "Kind regards,\\nEbrima\\nBanner Lane".\nFormat:\nSUBJECT: [subject line]\n---\n[body]`},
hr:{initial:`You write BD emails on behalf of Banner Lane, a specialist defence/aerospace executive search consultancy. FROM Ebrima, Market Intelligence Analyst. He tracks the defence talent market and connects relevant companies with Stephen Start, the founder.
WRITING TO: HR / RECRUITMENT.
STYLE: Collaborative. Ebrima is connecting them with Stephen who can discuss partnership models ‚Äî retained search, RPO, hard-to-fill technical roles, cleared talent pipelines. Position Banner Lane as supplementing their internal team, not competing with it.
Reference company intel if available ‚Äî headcount, growth signals, specialisms. Show you understand their hiring context.
BANNED PHRASES: ${BANNED_PHRASES}
Under 150 words. Ask: conversation with Stephen about how Banner Lane supports HR teams in their sector.
Sign off with "Kind regards,\\nEbrima\\nMarket Intelligence Analyst\\nBanner Lane".
Format:\nSUBJECT: [subject line]\n---\n[body]`,
followup:`Follow-up from Ebrima (Market Intelligence Analyst, Banner Lane) to HR. On behalf of Stephen. Under 80 words. Offer something specific ‚Äî market insight, salary benchmarking, a relevant type of recent search.
BANNED: ${BANNED_FU}
Sign off with "Kind regards,\\nEbrima\\nBanner Lane".\nFormat:\nSUBJECT: [subject line]\n---\n[body]`}};

function getEmailSys(uid){return uid==='ebrima'?EMAIL_SYS_EBRIMA:EMAIL_SYS_STEPHEN}

async function callAI(key,sys,usr){if(!key)throw new Error('No API key. Go to Settings.');const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1500,system:sys,messages:[{role:'user',content:usr}]})});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.error?.message||`API ${r.status}`)}return(await r.json()).content.map(b=>b.text||'').join('')}
function parseEmail(text){const sm=text.match(/^SUBJECT:\s*(.+?)[\r\n]/i);const s=sm?sm[1].trim():'Introduction ‚Äî Banner Lane';const bs=text.indexOf('---');const b=bs>=0?text.slice(bs+3).trim():text.replace(/^SUBJECT:.*[\r\n]+/i,'').trim();return{subject:s,body:b}}
function SB({status}){const s=STS.find(x=>x.v===status)||STS[0];return<span className="badge" style={{color:s.c,background:s.c+'18',border:`1px solid ${s.c}33`}}>{s.l}</span>}
function OwnerTag({userId}){const u=USERS[userId];if(!u)return null;return<span className="owner-tag" style={{color:u.color,background:u.color+'18'}}>{u.initials}</span>}

function ContactProgress({contacts,userId}){
  const cts=userId?(contacts||[]).filter(c=>c.userId===userId):(contacts||[]);
  const cats=CATS.map(cat=>{const cc=cts.filter(c=>c.category===cat.v);return{...cat,total:cc.length,contacted:cc.filter(c=>c.contacted).length}});
  return(<div style={{display:'flex',gap:8,alignItems:'center'}}>{cats.map(cat=>(<div key={cat.v} title={`${cat.s}: ${cat.contacted}/${cat.total}`} style={{display:'flex',alignItems:'center',gap:3}}><span style={{fontSize:9,color:cat.c,fontWeight:700,fontFamily:'JetBrains Mono,monospace',width:32}}>{cat.s}</span>{cat.total===0?<span style={{width:10,height:10,borderRadius:'50%',border:'1.5px dashed var(--bd)',display:'inline-block'}}/>:<div className="progress-dots">{Array.from({length:Math.min(cat.total,5)}).map((_,i)=><div key={i} className={`progress-dot ${i<cat.contacted?'filled':'partial'}`} style={i>=cat.contacted?{background:'transparent'}:{}}/>)}{cat.total>5&&<span style={{fontSize:9,color:'var(--tm)'}}>+{cat.total-5}</span>}</div>}</div>))}</div>);
}
function getStaggerDate(cid,tasks,uid){const ex=tasks.filter(t=>t.companyId===cid&&t.userId===uid&&t.type==='email'&&!t.completed).map(t=>t.dueDate).sort();if(ex.length===0)return fd(1);const d=new Date(ex[ex.length-1]);d.setDate(d.getDate()+14);return d.toISOString().split('T')[0]}

// ‚îÄ‚îÄ‚îÄ COMPANY CLAIMING ‚îÄ‚îÄ‚îÄ
function getClaimStatus(company,uid){
  if(!company.claimedBy)return{status:'free',claimedBy:null,months:0};
  const ms=Math.round((new Date()-new Date(company.claimDate||company.updatedAt))/(1000*60*60*24*30.44));
  if(company.claimedBy===uid)return{status:'mine',claimedBy:company.claimedBy,months:ms,stale:ms>=3};
  if(ms<3)return{status:'locked',claimedBy:company.claimedBy,months:ms};
  if(ms<6)return{status:'stale',claimedBy:company.claimedBy,months:ms};
  return{status:'expired',claimedBy:company.claimedBy,months:ms};
}
function claimCompany(data,cid,uid){
  return data.companies.map(c=>c.id===cid?{...c,claimedBy:uid,claimDate:new Date().toISOString()}:c);
}
function StarRating({value,onChange,size}){
  const sz=size||16;
  return(<div style={{display:'inline-flex',gap:1,cursor:onChange?'pointer':'default'}}>{[1,2,3].map(i=>(
    <span key={i} onClick={e=>{e.stopPropagation();if(onChange)onChange(value===i?0:i)}} style={{fontSize:sz,color:i<=value?'var(--amber)':'var(--bd)',transition:'color .15s',lineHeight:1}}>{i<=value?'‚òÖ':'‚òÜ'}</span>
  ))}</div>);
}

function exportCSV(data){
  const rows=[['Company','Country','Sector','Website','Status','Headcount','Revenue','Specialisms','Key Programmes','Growth Signal','Claimed By','Owner','Contact Name','Role','Category','Email','Phone','LinkedIn','Contacted','LinkedIn Noted','Last Contact','Contact Method']];
  data.companies.forEach(co=>{const cts=co.contacts||[];if(cts.length===0)rows.push([co.name,co.country,co.sector||'',co.website||'',co.status,co.headcount||'',co.revenue||'',co.specialisms||'',co.keyProgrammes||'',co.growthSignal||'',co.claimedBy||'','','','','','','','','','','','']);else cts.forEach(ct=>{rows.push([co.name,co.country,co.sector||'',co.website||'',co.status,co.headcount||'',co.revenue||'',co.specialisms||'',co.keyProgrammes||'',co.growthSignal||'',co.claimedBy||'',ct.userId||'',ct.name,ct.role||'',ct.category||'',ct.email||'',ct.phone||'',ct.linkedin||'',ct.contacted?'Yes':'No',ct.linkedinNoted?'Yes':'No',ct.lastContactDate||'',ct.contactMethod||''])})});
  const csv=rows.map(r=>r.map(c=>`"${(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const b=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`recon-contacts-${td()}.csv`;a.click();
}

// ‚îÄ‚îÄ‚îÄ PROGRESS COMPARISON ‚îÄ‚îÄ‚îÄ
function ProgressComparison({data}){
  const today=td();
  const stats=Object.values(USERS).map(u=>{
    const a=getAct(data,u.id,today);
    const ws=new Date();ws.setDate(ws.getDate()-(ws.getDay()||7)+1);let wC=0,wE=0,wL=0;
    for(let i=0;i<7;i++){const d=new Date(ws);d.setDate(d.getDate()+i);const da=getAct(data,u.id,d.toISOString().split('T')[0]);wC+=da.companies.length;wE+=da.emails;wL+=da.linkedin}
    let streak=0;const ck=new Date();const ts=a.companies.length+a.emails+a.linkedin;if(ts===0)ck.setDate(ck.getDate()-1);
    for(let i=0;i<90;i++){const ds=ck.toISOString().split('T')[0];const dw=ck.getDay();if(dw===0||dw===6){ck.setDate(ck.getDate()-1);continue}const da=getAct(data,u.id,ds);if(da.companies.length>0||da.emails>0||da.linkedin>0){streak++;ck.setDate(ck.getDate()-1)}else break}
    return{...u,today:a,weekC:wC,weekE:wE,weekL:wL,streak,
      pctC:Math.min(a.companies.length/u.targets.companies*100,100),
      pctE:Math.min(a.emails/u.targets.emails*100,100),
      pctL:Math.min(a.linkedin/u.targets.linkedin*100,100)};
  });
  return(<div style={{display:'flex',gap:16,marginBottom:24}}>
    {stats.map(s=>(
      <div key={s.id} className="vs-card" style={{borderTop:`3px solid ${s.color}`}}>
        <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}}>
          <div style={{display:'flex',alignItems:'center',gap:8}}>
            <div style={{width:28,height:28,borderRadius:'50%',background:s.color+'22',border:`2px solid ${s.color}`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontWeight:700,color:s.color}} className="mono">{s.initials}</div>
            <span style={{fontWeight:600,fontSize:14}}>{s.name}</span>
          </div>
          {s.streak>0&&<span className="mono" style={{fontSize:11,color:'var(--green)'}}>üî• {s.streak}d</span>}
        </div>
        {[{l:'Companies',v:s.today.companies.length,t:s.targets.companies,pct:s.pctC,c:'var(--amber)'},
          {l:'Emails',v:s.today.emails,t:s.targets.emails,pct:s.pctE,c:'var(--blue)'},
          {l:'LinkedIn',v:s.today.linkedin,t:s.targets.linkedin,pct:s.pctL,c:'var(--purple)'}].map((r,i)=>(
          <div key={i} style={{marginBottom:6}}>
            <div style={{display:'flex',justifyContent:'space-between',fontSize:11,color:'var(--t2)',marginBottom:2}}>
              <span>{r.l}</span>
              <span className="mono" style={{fontWeight:700,color:r.v>=r.t?'var(--green)':'var(--t1)'}}>{r.v}/{r.t}</span>
            </div>
            <div className="vs-bar"><div style={{height:'100%',borderRadius:4,width:`${r.pct}%`,background:r.v>=r.t?'var(--green)':r.c,transition:'width .4s'}}/></div>
          </div>))}
        <div style={{display:'flex',gap:12,marginTop:10,fontSize:10,color:'var(--tm)'}} className="mono">
          <span>Week: {s.weekC}co ¬∑ {s.weekE}em ¬∑ {s.weekL}li</span>
        </div>
      </div>))}
  </div>);
}

// ‚îÄ‚îÄ‚îÄ ACTIVITY DASHBOARD (per user) ‚îÄ‚îÄ‚îÄ
function ActivityDashboard({data,uid}){
  const user=USERS[uid];const targets=user.targets;
  const today=getAct(data,uid,td());const [hovDay,setHovDay]=useState(null);
  const weeks=12;const totalDays=weeks*7;const calDays=[];const startDate=new Date();startDate.setDate(startDate.getDate()-totalDays+1);
  const startDow=startDate.getDay()||7;if(startDow!==1)startDate.setDate(startDate.getDate()-(startDow-1));
  const realTotal=totalDays+(startDow===1?0:7);
  for(let i=0;i<realTotal;i++){const d=new Date(startDate);d.setDate(d.getDate()+i);const ds=d.toISOString().split('T')[0];const act=getAct(data,uid,ds);const score=(Math.min(act.companies.length,targets.companies)+Math.min(act.emails,targets.emails)+Math.min(act.linkedin,targets.linkedin))/(targets.companies+targets.emails+targets.linkedin);calDays.push({date:ds,day:d.getDate(),act,score,future:ds>td(),isToday:ds===td()})}
  const hov=hovDay?getAct(data,uid,hovDay):null;
  return(<div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:12,padding:20,marginBottom:24}}>
    <div className="sh" style={{color:user.color,marginBottom:12}}>MY ACTIVITY ‚Äî 12 WEEKS</div>
    <div style={{display:'flex',alignItems:'flex-start',gap:16}}>
      <div style={{flex:1}}>
        <div className="cal-grid">
          {['M','T','W','T','F','S','S'].map((d,i)=><div key={i} className="cal-hdr">{d}</div>)}
          {calDays.map((d,i)=>{let cls='cal-noact';if(d.future)cls='cal-future';else if(d.score>=0.9)cls='cal-full';else if(d.score>0)cls='cal-partial';
            return<div key={i} className={`cal-day ${cls} ${d.isToday?'cal-today':''}`} onMouseEnter={()=>setHovDay(d.date)} onMouseLeave={()=>setHovDay(null)}>{d.day}</div>})}
        </div>
        <div style={{display:'flex',gap:12,marginTop:8,justifyContent:'flex-end',fontSize:10,color:'var(--tm)'}}>
          <span style={{display:'flex',alignItems:'center',gap:4}}><span style={{width:10,height:10,borderRadius:2,background:'var(--bg2)',display:'inline-block'}}/> None</span>
          <span style={{display:'flex',alignItems:'center',gap:4}}><span style={{width:10,height:10,borderRadius:2,background:'#92600a44',border:'1px solid var(--amber)44',display:'inline-block'}}/> Partial</span>
          <span style={{display:'flex',alignItems:'center',gap:4}}><span style={{width:10,height:10,borderRadius:2,background:'var(--greend)',border:'1px solid var(--green)44',display:'inline-block'}}/> All targets</span>
        </div>
      </div>
      <div style={{width:140,padding:12,background:'var(--bg1)',borderRadius:8,border:'1px solid var(--bd)',minHeight:80}}>
        {hovDay?(<div><div className="mono" style={{fontSize:10,color:'var(--tm)',marginBottom:8}}>{new Date(hovDay+'T12:00:00').toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'})}</div>
          <div style={{fontSize:12,marginBottom:4}}><span style={{color:'var(--amber)'}}>‚óÜ</span> {hov.companies.length} companies</div>
          <div style={{fontSize:12,marginBottom:4}}><span style={{color:'var(--blue)'}}>‚úâ</span> {hov.emails} emails</div>
          <div style={{fontSize:12}}><span style={{color:'var(--purple)'}}>in</span> {hov.linkedin} LinkedIn</div>
        </div>):(<div className="mono" style={{fontSize:10,color:'var(--tm)'}}>Hover a day</div>)}
      </div>
    </div>
  </div>);
}

function LinkedInBox({contact,company,onCopy}){
  const [msg,setMsg]=useState('');const [copied,setCopied]=useState(false);
  useEffect(()=>{const s=company.sector||'defence';const n=contact.name?.split(' ')[0]||'';let m='';
    if(contact.category==='management')m=`Hi ${n}, I run a specialist recruitment practice in the ${s.toLowerCase()} sector ‚Äî we help businesses like ${company.name} find leadership and functional heads. Would be great to connect. Always happy to share market insight.`;
    else if(contact.category==='engineering')m=`Hi ${n}, I specialise in placing niche engineers in ${s.toLowerCase()} ‚Äî cleared talent, embedded, RF, FPGA etc. Thought it'd be worth connecting given your role at ${company.name}. Happy to share what we're seeing in the market.`;
    else m=`Hi ${n}, I run a retained search practice focused on ${s.toLowerCase()} recruitment ‚Äî specialising in hard-to-fill technical and leadership roles. Would be great to connect and see if there's scope to support ${company.name}'s hiring.`;
    if(m.length>300)m=m.slice(0,297)+'...';setMsg(m)},[contact,company]);
  function doCopy(){navigator.clipboard.writeText(msg);setCopied(true);if(onCopy)onCopy();setTimeout(()=>setCopied(false),2000)}
  return(<div className="li-box fi"><div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:6}}><span className="mono" style={{fontSize:10,color:'var(--blue)',letterSpacing:1,fontWeight:600}}>LINKEDIN INVITE MESSAGE</span><span className="mono" style={{fontSize:10,color:msg.length>300?'var(--red)':'var(--tm)'}}>{msg.length}/300</span></div><textarea value={msg} onChange={e=>{if(e.target.value.length<=300)setMsg(e.target.value)}} style={{minHeight:60,fontSize:12,lineHeight:1.5,background:'var(--bg0)',border:'1px solid var(--bd)'}}/><div style={{display:'flex',gap:8,marginTop:8}}><button className={copied?'bg bx':'bb bx'} onClick={doCopy}>{copied?'‚úì Copied':'Copy to Clipboard'}</button></div></div>);
}

function EmailModal({contact,company,data,setData,onClose,onSent,taskId,isFollowUp,uid}){
  const [subject,setSubject]=useState('');const [body,setBody]=useState('');const [loading,setLoading]=useState(true);const [sc,setSC]=useState(false);
  const anonTR=getAnonTR(data.trackRecord);const emailSys=getEmailSys(uid);const cfg=emailSys[contact.category]||emailSys.management;
  async function generate(){setLoading(true);setSubject('');setBody('');
    try{const news=company.aiNews?`\nRecent intel: ${company.aiNews.slice(0,500)}`:'';
      const sys=(isFollowUp?cfg.followup:cfg.initial)+`\n\nTrack record (NO specific company names):\n${anonTR}`;
      const coIntel=[
        company.headcount&&`Headcount: ~${company.headcount}`,
        company.revenue&&`Revenue: ${company.revenue}`,
        company.specialisms&&`Specialisms: ${company.specialisms}`,
        company.keyProgrammes&&`Key programmes: ${company.keyProgrammes}`,
        company.growthSignal&&`Growth signal: ${company.growthSignal}`,
        company.founded&&`Founded: ${company.founded}`,
      ].filter(Boolean).join('\n');
      const raw=await callAI(data.settings.apiKey,sys,`${isFollowUp?'Follow-up':'Initial outreach'} to:\nName: ${contact.name}\nTitle: ${contact.role}\nCompany: ${company.name}\nSector: ${company.sector||'Defence'}\nCountry: ${company.country}\nNotes: ${company.notes||'Defence company'}\n${coIntel?'COMPANY INTEL:\n'+coIntel:''}\n${news}\n\nIMPORTANT: Write this like a real person wrote it. Read it back to yourself ‚Äî if any sentence sounds like it came from ChatGPT or a marketing team, rewrite it. Use plain English. No filler words. No fluff. Every sentence should earn its place. If company intel is provided, use it to make this specific to them ‚Äî don't waste it.`);
      const p=parseEmail(raw);setSubject(p.subject);setBody(p.body)}catch(e){setBody('Error: '+e.message);setSubject('Error')}setLoading(false)}
  useEffect(()=>{generate()},[]);
  return(<div className="mo" onClick={onClose}><div className="ml" style={{maxWidth:700}} onClick={e=>e.stopPropagation()}>
    <h3>{isFollowUp?'‚óá Follow-up':'‚úâ Email'} to {contact.name}</h3>
    <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8,padding:'10px 14px',background:'var(--bg0)',borderRadius:8,border:'1px solid var(--bd)'}}><span style={{fontSize:12,color:'var(--tm)'}}>To:</span><span className="mono" style={{fontSize:14,fontWeight:600,color:'var(--t1)',flex:1}}>{contact.email}</span><button className="bs bx" onClick={()=>navigator.clipboard.writeText(contact.email)}>Copy Email</button></div>
    <div style={{fontSize:12,color:'var(--tm)',marginBottom:4}}>{contact.role} at {company.name}</div>
    <div style={{display:'flex',gap:6,marginBottom:16}}>
      <span className="badge" style={{color:CATS.find(c=>c.v===contact.category)?.c,background:CATS.find(c=>c.v===contact.category)?.c+'18'}}>{contact.category}</span>
      <span className="badge" style={{color:isFollowUp?'var(--purple)':'var(--blue)',background:isFollowUp?'var(--purple)18':'var(--blue)18'}}>{isFollowUp?'FOLLOW-UP':'INITIAL'}</span>
    </div>
    {loading?<div style={{padding:40,textAlign:'center'}}><div className="mono" style={{color:'var(--tm)'}}>Writing...</div></div>
    :<><div className="subj-row"><span className="mono" style={{fontSize:10,color:'var(--t2)',letterSpacing:1,fontWeight:600,whiteSpace:'nowrap'}}>SUBJECT:</span><input value={subject} onChange={e=>setSubject(e.target.value)}/><button className={sc?'bg bx':'bs bx'} onClick={()=>{navigator.clipboard.writeText(subject);setSC(true);setTimeout(()=>setSC(false),1500)}}>{sc?'‚úì':'Copy'}</button></div>
      <textarea value={body} onChange={e=>setBody(e.target.value)} style={{minHeight:220,fontSize:13,lineHeight:1.7}}/>
      <div style={{display:'flex',gap:8,marginTop:16,justifyContent:'space-between',flexWrap:'wrap'}}>
        <button className="bs" onClick={generate}>‚Üª Regenerate</button>
        <div style={{display:'flex',gap:8}}><button className="bs" onClick={()=>{navigator.clipboard.writeText(`Subject: ${subject}\n\n${body}`);alert('Copied!')}}>Copy All</button>
          <button className="bp" onClick={()=>onSent(contact,taskId)}>‚úì Sent ‚Üí Follow-up in 4d</button></div></div></>}
  </div></div>);
}

function CallModal({contact,company,onClose,onSave}){
  const [outcome,setOutcome]=useState('no_answer');const [notes,setNotes]=useState('');const days=outcome==='spoke'?5:outcome==='voicemail'?3:2;
  return(<div className="mo" onClick={onClose}><div className="ml" onClick={e=>e.stopPropagation()}>
    <h3>‚òé Call ‚Äî {contact.name}</h3><div style={{fontSize:12,color:'var(--tm)',marginBottom:16}}>{contact.role} at {company.name}{contact.phone&&<span className="mono"> ¬∑ {contact.phone}</span>}</div>
    <div className="fg"><label>Outcome</label><div style={{display:'flex',gap:8}}>{[{v:'spoke',l:'‚úì Spoke',c:'bg'},{v:'voicemail',l:'‚úâ VM',c:'bb'},{v:'no_answer',l:'‚úó No Answer',c:'bs'}].map(o=>(<button key={o.v} className={outcome===o.v?o.c:'bs'} style={{flex:1,border:outcome===o.v?'2px solid var(--amber)':'1px solid var(--bd)'}} onClick={()=>setOutcome(o.v)}>{o.l}</button>))}</div></div>
    <div className="fg"><label>Notes</label><textarea value={notes} onChange={e=>setNotes(e.target.value)} placeholder="Key points..." style={{minHeight:100}}/></div>
    <div className="mono" style={{fontSize:11,color:'var(--tm)',marginBottom:12}}>Follow-up in {days} days</div>
    <div style={{display:'flex',gap:8,justifyContent:'flex-end'}}><button className="bs" onClick={onClose}>Cancel</button><button className="bp" onClick={()=>onSave(contact,outcome,notes)}>Save & Create Follow-up</button></div>
  </div></div>);
}

function Sidebar({view,setView,ac,fileConnected,onConnect,onSaveNow,uid,setUid}){
  const items=[{id:'actions',icon:'‚ö°',l:'Daily Actions',badge:ac},{id:'companies',icon:'‚óÜ',l:'Companies'},{id:'contacts',icon:'‚óé',l:'Contacts'},{id:'tasks',icon:'‚óá',l:'Tasks'},{id:'trackrecord',icon:'‚ñ£',l:'Track Record'},{id:'settings',icon:'‚öô',l:'Settings'}];
  return(<nav style={{width:220,minHeight:'100vh',background:'var(--bg1)',borderRight:'1px solid var(--bd)',display:'flex',flexDirection:'column',position:'fixed',top:0,left:0,zIndex:100}}>
    <div style={{padding:'20px 16px',borderBottom:'1px solid var(--bd)'}}><div className="mono" style={{fontSize:20,fontWeight:700,color:'var(--amber)',letterSpacing:3}}>‚ñ£ RECON</div><div className="mono" style={{fontSize:10,color:'var(--tm)',marginTop:2,letterSpacing:1}}>BANNER LANE</div></div>
    <div style={{padding:'12px 12px 8px'}}>
      <div className="user-sw">{Object.values(USERS).map(u=>(
        <button key={u.id} className={`user-btn ${uid===u.id?'active':''}`} onClick={()=>setUid(u.id)} style={uid===u.id?{background:u.color,color:'#000'}:{}}>{u.name}</button>
      ))}</div>
    </div>
    <div style={{padding:'4px 8px',flex:1}}>{items.map(it=>(
      <div key={it.id} onClick={()=>setView(it.id)} style={{display:'flex',alignItems:'center',gap:10,padding:'10px 12px',borderRadius:8,cursor:'pointer',marginBottom:2,background:view===it.id?'var(--bgh)':'transparent',color:view===it.id?'var(--amber)':'var(--t2)',fontSize:13,fontWeight:view===it.id?600:400,borderLeft:view===it.id?'2px solid var(--amber)':'2px solid transparent',transition:'all .15s'}}>
        <span style={{fontSize:14,width:20,textAlign:'center'}}>{it.icon}</span>{it.l}
        {it.badge>0&&<span style={{marginLeft:'auto',background:'var(--red)',color:'#fff',borderRadius:10,padding:'1px 7px',fontSize:10,fontWeight:700}}>{it.badge}</span>}
      </div>))}</div>
    <div style={{padding:'8px 8px 6px'}}><div className="save-bar" onClick={fileConnected?onSaveNow:onConnect} style={{color:fileConnected?'var(--green)':'var(--amber)',background:fileConnected?'var(--greend)33':'var(--amberd)33',border:`1px solid ${fileConnected?'var(--green)':'var(--amber)'}33`}}><span style={{fontSize:13}}>{fileConnected?'‚óè':'‚ö†'}</span><span>{fileConnected?'Auto-saving':'Connect save file'}</span></div></div>
    <div className="mono" style={{padding:'0 16px 12px',fontSize:10,color:'var(--tm)'}}>v4.0</div>
  </nav>);
}

function ContactsView({data,setView,setSel,uid}){
  const [search,setSearch]=useState('');const [fCat,setFCat]=useState('');const [fStatus,setFStatus]=useState('');const [fOwner,setFOwner]=useState('');
  const all=[];data.companies.forEach(co=>{(co.contacts||[]).forEach(ct=>{all.push({...ct,companyName:co.name,companyId:co.id,companyCountry:co.country,companyStatus:co.status})})});
  const filtered=all.filter(c=>{
    if(search){const s=search.toLowerCase();if(!c.name.toLowerCase().includes(s)&&!c.companyName.toLowerCase().includes(s)&&!(c.role||'').toLowerCase().includes(s)&&!(c.email||'').toLowerCase().includes(s))return false}
    if(fCat&&c.category!==fCat)return false;if(fOwner&&c.userId!==fOwner)return false;
    if(fStatus==='contacted'&&!c.contacted)return false;if(fStatus==='not_contacted'&&c.contacted)return false;if(fStatus==='li_noted'&&!c.linkedinNoted)return false;
    return true}).sort((a,b)=>a.name.localeCompare(b.name));
  const total=all.length;const contacted=all.filter(c=>c.contacted).length;
  return(<div className="fi">
    <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:24}}><h2 style={{fontSize:22,fontWeight:300}}><span style={{color:'var(--amber)'}} className="mono">‚óé</span> Contacts <span className="mono" style={{fontSize:13,color:'var(--tm)',marginLeft:8}}>{total} total ¬∑ {contacted} contacted</span></h2><button className="bs" onClick={()=>exportCSV(data)}>‚Üì Export CSV</button></div>
    <div style={{display:'flex',gap:12,marginBottom:16,flexWrap:'wrap'}}>
      <input placeholder="Search name, company, role, email..." value={search} onChange={e=>setSearch(e.target.value)} style={{maxWidth:360}}/>
      <select value={fOwner} onChange={e=>setFOwner(e.target.value)} style={{maxWidth:130}}><option value="">All Users</option>{Object.values(USERS).map(u=><option key={u.id} value={u.id}>{u.name}</option>)}</select>
      <select value={fCat} onChange={e=>setFCat(e.target.value)} style={{maxWidth:160}}><option value="">All Categories</option>{CATS.map(c=><option key={c.v} value={c.v}>{c.l}</option>)}</select>
      <select value={fStatus} onChange={e=>setFStatus(e.target.value)} style={{maxWidth:160}}><option value="">All</option><option value="contacted">Contacted</option><option value="not_contacted">Not Contacted</option><option value="li_noted">LinkedIn Noted</option></select>
      <span className="mono" style={{fontSize:12,color:'var(--tm)',alignSelf:'center'}}>{filtered.length}</span>
    </div>
    <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,overflow:'hidden'}}>
      <div style={{display:'grid',gridTemplateColumns:'40px 170px 100px 1fr 70px 170px 100px',padding:'10px 16px',background:'var(--bg2)',fontSize:10,fontWeight:600,textTransform:'uppercase',letterSpacing:1,color:'var(--tm)'}} className="mono"><span></span><span>Name</span><span>Category</span><span>Company</span><span>Country</span><span>Email</span><span>Status</span></div>
      {filtered.length===0&&<div style={{padding:32,textAlign:'center',color:'var(--tm)',fontSize:13}}>No contacts found</div>}
      {filtered.slice(0,100).map(c=>(
        <div key={c.id} style={{display:'grid',gridTemplateColumns:'40px 170px 100px 1fr 70px 170px 100px',padding:'10px 16px',borderBottom:'1px solid var(--bd)',alignItems:'center',fontSize:12,cursor:'pointer',transition:'background .15s'}} onMouseEnter={e=>e.currentTarget.style.background='var(--bgh)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'} onClick={()=>{addRecent(c.companyId,c.companyName);setSel(c.companyId);setView('companyDetail')}}>
          <OwnerTag userId={c.userId}/>
          <div><span style={{fontWeight:600}}>{c.name}</span><div style={{fontSize:10,color:'var(--tm)'}}>{c.role}</div></div>
          <span className="badge" style={{color:CATS.find(x=>x.v===c.category)?.c||'var(--tm)',background:(CATS.find(x=>x.v===c.category)?.c||'var(--tm)')+'18'}}>{c.category}</span>
          <span style={{color:'var(--amber)'}}>{c.companyName}</span>
          <span className="mono" style={{color:'var(--tm)'}}>{c.companyCountry}</span>
          <span className="mono" style={{fontSize:11,color:'var(--t2)'}}>{c.email||'‚Äî'}</span>
          <div style={{display:'flex',gap:4,alignItems:'center'}}>{c.contacted?<span className="badge" style={{color:'var(--green)',background:'var(--green)18'}}>DONE</span>:<span className="badge" style={{color:'var(--tm)',background:'var(--bg2)'}}>PENDING</span>}{c.linkedinNoted&&<span className="badge" style={{color:'var(--blue)',background:'var(--blue)18'}}>LI</span>}</div>
        </div>))}
      {filtered.length>100&&<div style={{padding:12,textAlign:'center',color:'var(--tm)',fontSize:12}}>Showing 100 of {filtered.length}</div>}
    </div>
  </div>);
}

function DailyActions({data,setData,setView,setSel,uid}){
  const [emailM,setEmailM]=useState(null);const [callM,setCallM]=useState(null);const recent=getRecent();
  const open=data.tasks.filter(t=>!t.completed&&t.userId===uid).sort((a,b)=>new Date(a.dueDate)-new Date(b.dueDate));
  const overdue=open.filter(t=>isOD(t.dueDate));const todayT=open.filter(t=>isT(t.dueDate));const upcoming=open.filter(t=>!isOD(t.dueDate)&&!isT(t.dueDate)&&isS(t.dueDate));
  function handleSent(ct,taskId){
    const co=data.companies.find(c=>c.contacts?.some(x=>x.id===ct.id));if(!co)return;
    const act=logActAtomic(data,uid,'email');
    const uCo=data.companies.map(c=>{if(c.id!==co.id)return c;return{...c,status:c.status==='prospect'?'contacted':c.status,claimedBy:uid,claimDate:new Date().toISOString(),updatedAt:new Date().toISOString(),contacts:c.contacts.map(x=>x.id===ct.id?{...x,contacted:true,contactMethod:'email',contactDate:td(),lastContactDate:td()}:x)}});
    let uT=taskId?data.tasks.map(t=>t.id===taskId?{...t,completed:true,completedDate:new Date().toISOString()}:t):[...data.tasks];
    uT.push({id:gid(),companyId:co.id,contactId:ct.id,userId:uid,type:'followup',description:`Follow up with ${ct.name} at ${co.name}`,dueDate:fd(4),completed:false,createdAt:new Date().toISOString()});
    const u={...data,companies:uCo,tasks:uT,activity:act};setData(u);sv(u);setEmailM(null)}
  function handleCall(ct,outcome,notes,taskId){
    const co=data.companies.find(c=>c.contacts?.some(x=>x.id===ct.id));if(!co)return;
    const log={id:gid(),companyId:co.id,contactId:ct.id,contactName:ct.name,companyName:co.name,outcome,notes,userId:uid,date:new Date().toISOString()};
    const act=logActAtomic(data,uid,'call');
    const uCo=data.companies.map(c=>{if(c.id!==co.id)return c;return{...c,status:c.status==='prospect'?'contacted':c.status,claimedBy:uid,claimDate:new Date().toISOString(),updatedAt:new Date().toISOString(),contacts:c.contacts.map(x=>x.id===ct.id?{...x,contacted:true,contactMethod:'call',contactDate:td(),lastContactDate:td(),lastCallOutcome:outcome,lastCallNotes:notes}:x)}});
    const days=outcome==='spoke'?5:outcome==='voicemail'?3:2;
    let uT=taskId?data.tasks.map(t=>t.id===taskId?{...t,completed:true,completedDate:new Date().toISOString()}:t):[...data.tasks];
    uT.push({id:gid(),companyId:co.id,contactId:ct.id,userId:uid,type:outcome==='spoke'?'followup':'call',description:outcome==='spoke'?`Follow up after call with ${ct.name} at ${co.name}`:`Re-call ${ct.name} at ${co.name} (${outcome})`,dueDate:fd(days),completed:false,createdAt:new Date().toISOString()});
    const u={...data,companies:uCo,tasks:uT,callLog:[...(data.callLog||[]),log],activity:act};setData(u);sv(u);setCallM(null)}
  function complete(id){const u={...data,tasks:data.tasks.map(t=>t.id===id?{...t,completed:true,completedDate:new Date().toISOString()}:t)};setData(u);sv(u)}
  function TR({task}){const co=data.companies.find(c=>c.id===task.companyId);const ct=co?.contacts?.find(c=>c.id===task.contactId);const isFU=task.type==='followup';
    return(<div style={{display:'flex',alignItems:'center',gap:10,padding:'12px 16px',borderBottom:'1px solid var(--bd)',transition:'background .15s'}} onMouseEnter={e=>e.currentTarget.style.background='var(--bgh)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}>
      <span style={{fontSize:16,color:task.type==='call'?'var(--green)':task.type==='email'?'var(--blue)':'var(--purple)',width:24,textAlign:'center'}}>{task.type==='call'?'‚òé':task.type==='email'?'‚úâ':'‚óá'}</span>
      <div style={{flex:1,minWidth:0}}><div style={{fontSize:13,fontWeight:500}}>{task.description}</div><div style={{fontSize:11,color:'var(--tm)',marginTop:2}}>{co&&<span onClick={()=>{addRecent(co.id,co.name);setSel(co.id);setView('companyDetail')}} style={{cursor:'pointer',color:'var(--amber)'}}>{co.name}</span>}{ct&&<span> ¬∑ {ct.name}{ct.phone&&<span className="mono" style={{marginLeft:6,color:'var(--tm)'}}>{ct.phone}</span>}</span>}</div></div>
      <span className="mono" style={{fontSize:11,color:isOD(task.dueDate)?'var(--red)':isT(task.dueDate)?'var(--amber)':'var(--tm)',whiteSpace:'nowrap'}}>{isOD(task.dueDate)?'OVERDUE':isT(task.dueDate)?'TODAY':fmt(task.dueDate)}</span>
      <div style={{display:'flex',gap:4}}>{ct?.email&&<button className={isFU?'bpu bx':'bb bx'} onClick={()=>setEmailM({contact:ct,company:co,taskId:task.id,isFollowUp:isFU})}>{isFU?'‚óá Follow-up':'‚úâ Email'}</button>}{ct&&<button className="bg bx" onClick={()=>setCallM({contact:ct,company:co,taskId:task.id})}>‚òé</button>}<button className="bs bx" onClick={()=>complete(task.id)}>‚úì</button></div>
    </div>)}
  return(<div className="fi">
    <h2 style={{fontSize:22,fontWeight:300,marginBottom:4}}><span style={{color:'var(--amber)'}} className="mono">‚ö°</span> Daily Actions</h2>
    <p style={{color:'var(--tm)',fontSize:13,marginBottom:24}}>{new Date().toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</p>
    <ProgressComparison data={data}/>
    <ActivityDashboard data={data} uid={uid}/>
    {recent.length>0&&<div style={{marginBottom:20}}><div className="sh" style={{color:'var(--t2)'}}>RECENTLY VIEWED</div><div style={{display:'flex',gap:8,flexWrap:'wrap'}}>{recent.map(r=>{const co=data.companies.find(c=>c.id===r.id);if(!co)return null;return<div key={r.id} className="recent-chip" onClick={()=>{addRecent(co.id,co.name);setSel(co.id);setView('companyDetail')}}><SB status={co.status}/><span style={{fontWeight:500}}>{co.name}</span><span className="mono" style={{fontSize:10,color:'var(--tm)'}}>{co.country}</span></div>})}</div></div>}
    {overdue.length>0&&<div style={{marginBottom:20}}><div className="sh" style={{color:'var(--red)'}}>‚ö† OVERDUE ({overdue.length})</div><div style={{background:'var(--bgc)',border:'1px solid var(--red)33',borderRadius:10,overflow:'hidden'}}>{overdue.map(t=><TR key={t.id} task={t}/>)}</div></div>}
    <div style={{marginBottom:20}}><div className="sh" style={{color:'var(--amber)'}}>TODAY ({todayT.length})</div><div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,overflow:'hidden'}}>{todayT.length===0&&<div style={{padding:20,textAlign:'center',color:'var(--tm)',fontSize:13}}>No tasks today</div>}{todayT.map(t=><TR key={t.id} task={t}/>)}</div></div>
    {upcoming.length>0&&<div style={{marginBottom:20}}><div className="sh" style={{color:'var(--t2)'}}>COMING UP ({upcoming.length})</div><div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,overflow:'hidden'}}>{upcoming.map(t=><TR key={t.id} task={t}/>)}</div></div>}
    <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:12}}>
      {[{l:'Companies',v:data.companies.length,c:'var(--amber)'},{l:'My Contacts',v:data.companies.reduce((a,c)=>a+((c.contacts||[]).filter(x=>x.userId===uid).length),0),c:'var(--blue)'},{l:'My Tasks',v:open.length,c:'var(--purple)'},{l:'My Calls',v:(data.callLog||[]).filter(l=>l.userId===uid).length,c:'var(--green)'}].map((s,i)=>(
        <div key={i} style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:16,borderTop:`2px solid ${s.c}`}}><div className="mono" style={{fontSize:22,fontWeight:700,color:s.c}}>{s.v}</div><div className="mono" style={{fontSize:10,color:'var(--tm)',letterSpacing:1,marginTop:2,textTransform:'uppercase'}}>{s.l}</div></div>))}
    </div>
    {emailM&&<EmailModal contact={emailM.contact} company={emailM.company} data={data} setData={setData} taskId={emailM.taskId} isFollowUp={emailM.isFollowUp} onClose={()=>setEmailM(null)} onSent={handleSent} uid={uid}/>}
    {callM&&<CallModal contact={callM.contact} company={callM.company} onClose={()=>setCallM(null)} onSave={(ct,o,n)=>handleCall(ct,o,n,callM.taskId)}/>}
  </div>);
}

function CompanyList({data,setData,setView,setSel,uid}){
  const [showAdd,setShowAdd]=useState(false);const [search,setSearch]=useState('');const [fS,setFS]=useState('');const [fC,setFC]=useState('');const [fClaim,setFClaim]=useState('');const [fStar,setFStar]=useState('');const [page,setPage]=useState(0);const PS=50;
  const [form,setForm]=useState({name:'',sector:'Defence',country:'UK',status:'prospect',website:'',notes:''});
  const [bulkE,setBulkE]=useState(null);const bulkStop=useRef(false);
  async function runBulkEnrich(){
    const unenriched=filtered.filter(c=>!c.enrichedDate&&c.status!=='dormant');
    if(unenriched.length===0){alert('No unenriched companies in current view.');return}
    if(!data.settings?.apiKey){alert('Set API key in Settings first.');return}
    if(!confirm(`Enrich ${unenriched.length} companies? This will use ~${unenriched.length} API calls (~$${(unenriched.length*0.005).toFixed(2)}).`))return;
    bulkStop.current=false;setBulkE({running:true,current:'',done:0,total:unenriched.length,errors:0});
    let latestData=data;
    for(let i=0;i<unenriched.length;i++){
      if(bulkStop.current){setBulkE(prev=>({...prev,running:false}));return}
      const co=unenriched[i];setBulkE(prev=>({...prev,current:co.name,done:i}));
      try{
        const raw=await callAI(latestData.settings.apiKey,
          `Defence/aerospace industry analyst. Given a company, return ONLY valid JSON:\n{"description":"1-2 sentences","sector":"Primary sector","subsector":"Specific area","size":"Employee count/range","website":"URL","hq":"HQ city","keyProgrammes":"Notable products/platforms","hiringSignals":"Growth/hiring indicators"}\nIf unsure about a field, use "Unknown".`,
          `Company: ${co.name}\nCountry: ${co.country}\nExisting notes: ${co.notes||'None'}`);
        const cleaned=raw.replace(/```json|```/g,'').trim();
        const d=JSON.parse(cleaned);
        const notes=[];
        if(d.description)notes.push(d.description);
        if(d.subsector&&d.subsector!=='Unknown')notes.push(`Subsector: ${d.subsector}`);
        if(d.size&&d.size!=='Unknown')notes.push(`Size: ~${d.size} employees`);
        if(d.hq&&d.hq!=='Unknown')notes.push(`HQ: ${d.hq}`);
        if(d.website&&d.website!=='Unknown')notes.push(`Web: ${d.website}`);
        if(d.keyProgrammes&&d.keyProgrammes!=='Unknown')notes.push(`Programmes: ${d.keyProgrammes}`);
        if(d.hiringSignals&&d.hiringSignals!=='Unknown')notes.push(`Hiring: ${d.hiringSignals}`);
        const existingNotes=(co.notes||'').trim();
        const newNotes=existingNotes?existingNotes+'\n\n--- AI ENRICHED ---\n'+notes.join('\n'):notes.join('\n');
        const uCo=latestData.companies.map(c=>c.id===co.id?{...c,notes:newNotes,sector:d.sector||c.sector,enrichedDate:new Date().toISOString()}:c);
        latestData={...latestData,companies:uCo};setData(latestData);sv(latestData);
      }catch(e){console.error('Enrich failed:',co.name,e);setBulkE(prev=>({...prev,errors:(prev.errors||0)+1}))}
      await new Promise(r=>setTimeout(r,500));// pace API calls
    }
    setBulkE(prev=>({...prev,running:false,done:unenriched.length,current:'Done!'}));
  }
  const countries=[...new Set(data.companies.map(c=>c.country))].sort();const cc={};data.companies.forEach(c=>{cc[c.country]=(cc[c.country]||0)+1});
  function addCo(){if(!form.name.trim())return;const n={id:gid(),...form,contacts:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),aiNews:''};const u={...data,companies:[...data.companies,n]};setData(u);sv(u);setForm({name:'',sector:'Defence',country:'UK',status:'prospect',website:'',notes:''});setShowAdd(false)}
  function delCo(id){if(!confirm('Delete?'))return;const u={...data,companies:data.companies.filter(c=>c.id!==id),tasks:data.tasks.filter(t=>t.companyId!==id)};setData(u);sv(u)}
  const filtered=data.companies.filter(c=>{if(search&&!c.name.toLowerCase().includes(search.toLowerCase()))return false;if(fS&&c.status!==fS)return false;if(fC&&c.country!==fC)return false;
    if(fClaim==='mine'&&c.claimedBy!==uid)return false;if(fClaim==='other'&&(c.claimedBy===uid||!c.claimedBy))return false;if(fClaim==='free'&&c.claimedBy)return false;if(fClaim==='available'){const cl=getClaimStatus(c,uid);if(cl.status==='locked'||c.avoided)return false}
    if(fStar&&fStar!=='avoided'&&(c.priority||0)!==Number(fStar))return false;
    if(fStar!=='avoided'&&!fStar&&c.avoided)return false;
    if(fStar==='avoided'&&!c.avoided)return false;
    return true}).sort((a,b)=>(b.priority||0)-(a.priority||0));
  const tp=Math.ceil(filtered.length/PS);const paged=filtered.slice(page*PS,(page+1)*PS);
  useEffect(()=>{setPage(0)},[search,fS,fC,fClaim,fStar]);
  return(<div className="fi">
    <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:24}}><h2 style={{fontSize:22,fontWeight:300}}><span style={{color:'var(--amber)'}} className="mono">‚óÜ</span> Companies <span className="mono" style={{fontSize:13,color:'var(--tm)',marginLeft:8}}>{data.companies.length} <span style={{color:'var(--green)'}}>¬∑ {data.companies.filter(c=>c.enrichedDate).length} enriched</span>{data.companies.filter(c=>c.avoided).length>0&&<span style={{color:'var(--red)'}}> ¬∑ {data.companies.filter(c=>c.avoided).length} avoided</span>}</span></h2><div style={{display:'flex',gap:8}}><button className="bb" onClick={runBulkEnrich} disabled={bulkE?.running}>‚ö° Bulk Enrich</button><button className="bp" onClick={()=>setShowAdd(true)}>+ Add Company</button></div></div>
    {bulkE&&<div style={{marginBottom:16,padding:'12px 16px',background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:8}}>
      <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:8}}>
        <span style={{fontSize:13}}>{bulkE.running?<span>Enriching: <strong>{bulkE.current}</strong></span>:<span style={{color:'var(--green)'}}>‚úì {bulkE.current}</span>}</span>
        <span className="mono" style={{fontSize:12,color:'var(--t2)'}}>{bulkE.done}/{bulkE.total}{bulkE.errors>0&&<span style={{color:'var(--red)',marginLeft:8}}>{bulkE.errors} errors</span>}</span>
      </div>
      <div style={{height:6,background:'var(--bg2)',borderRadius:3,overflow:'hidden'}}><div style={{height:'100%',borderRadius:3,background:bulkE.running?'var(--blue)':'var(--green)',width:`${(bulkE.done/bulkE.total)*100}%`,transition:'width .3s'}}/></div>
      <div style={{display:'flex',gap:8,marginTop:8}}>{bulkE.running&&<button className="bd bsm" onClick={()=>{bulkStop.current=true}}>Stop</button>}{!bulkE.running&&<button className="bs bsm" onClick={()=>setBulkE(null)}>Dismiss</button>}</div>
    </div>}
    <div style={{display:'flex',gap:12,marginBottom:12,flexWrap:'wrap'}}><input placeholder="Search..." value={search} onChange={e=>setSearch(e.target.value)} style={{maxWidth:280}}/><select value={fC} onChange={e=>setFC(e.target.value)} style={{maxWidth:160}}><option value="">All Countries</option>{countries.map(c=><option key={c} value={c}>{c} ({cc[c]})</option>)}</select><select value={fS} onChange={e=>setFS(e.target.value)} style={{maxWidth:160}}><option value="">All Statuses</option>{STS.map(s=><option key={s.v} value={s.v}>{s.l}</option>)}</select><select value={fClaim} onChange={e=>setFClaim(e.target.value)} style={{maxWidth:160}}><option value="">All Claims</option><option value="mine">My Claims</option><option value="other">Other's Claims</option><option value="free">Unclaimed</option><option value="available">Available to Me</option></select><select value={fStar} onChange={e=>setFStar(e.target.value)} style={{maxWidth:130}}><option value="">All Priority</option><option value="3">‚òÖ‚òÖ‚òÖ</option><option value="2">‚òÖ‚òÖ</option><option value="1">‚òÖ</option><option value="avoided">‚äò Avoided</option></select><span className="mono" style={{fontSize:12,color:'var(--tm)',alignSelf:'center'}}>{filtered.length}</span></div>
    <div style={{display:'flex',gap:6,marginBottom:16,flexWrap:'wrap'}}>{countries.map(c=><button key={c} className={fC===c?'bp':'bs'} style={{padding:'3px 10px',fontSize:11}} onClick={()=>setFC(fC===c?'':c)}>{c} ({cc[c]})</button>)}</div>
    <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,overflow:'hidden'}}>
      <div style={{display:'grid',gridTemplateColumns:'60px 2fr 70px 100px 200px 40px',padding:'10px 16px',background:'var(--bg2)',fontSize:10,fontWeight:600,textTransform:'uppercase',letterSpacing:1,color:'var(--tm)'}} className="mono"><span>Priority</span><span>Company</span><span>Country</span><span>Status</span><span>Contacts</span><span></span></div>
      {paged.length===0&&<div style={{padding:32,textAlign:'center',color:'var(--tm)',fontSize:13}}>No matches</div>}
      {paged.map(c=>{const tc=(c.contacts||[]).length;const cc2=(c.contacts||[]).filter(x=>x.contacted).length;const myC=(c.contacts||[]).filter(x=>x.userId===uid).length;const claim=getClaimStatus(c,uid);
        function setStar(v){const u={...data,companies:data.companies.map(x=>x.id===c.id?{...x,priority:v,avoided:false}:x)};setData(u);sv(u)}
        function toggleAvoid(e){e.stopPropagation();const u={...data,companies:data.companies.map(x=>x.id===c.id?{...x,avoided:!x.avoided,priority:0}:x)};setData(u);sv(u)}
        return(<div key={c.id} style={{display:'grid',gridTemplateColumns:'60px 2fr 70px 100px 200px 40px',padding:'10px 16px',borderBottom:'1px solid var(--bd)',cursor:'pointer',alignItems:'center',transition:'background .15s',opacity:c.avoided?.4:1}} onMouseEnter={e=>e.currentTarget.style.background='var(--bgh)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'} onClick={()=>{addRecent(c.id,c.name);setSel(c.id);setView('companyDetail')}}>
          <div style={{display:'flex',alignItems:'center',gap:4}}>{c.avoided?<span onClick={toggleAvoid} title="Remove avoid" style={{fontSize:14,color:'var(--red)',cursor:'pointer'}}>‚äò</span>:<StarRating value={c.priority||0} onChange={setStar} size={14}/>}</div>
          <div style={{display:'flex',alignItems:'center',gap:8}}>
            {claim.claimedBy&&<span className="owner-tag" style={{color:USERS[claim.claimedBy]?.color||'var(--tm)',background:(USERS[claim.claimedBy]?.color||'var(--tm)')+'18'}}>{USERS[claim.claimedBy]?.initials}</span>}
            <div><span style={{fontWeight:500}}>{c.name}</span>{tc>0&&<span className="mono" style={{fontSize:10,marginLeft:8,color:cc2===tc?'var(--green)':cc2>0?'var(--amber)':'var(--tm)'}}>{cc2}/{tc}</span>}{myC>0&&<span className="mono" style={{fontSize:9,marginLeft:4,color:'var(--tm)'}}>({myC} mine)</span>}
            {claim.status==='locked'&&<span className="mono" style={{fontSize:9,marginLeft:6,color:'var(--red)'}}>üîí</span>}
            {claim.status==='stale'&&<span className="mono" style={{fontSize:9,marginLeft:6,color:'var(--amber)'}}>‚ö†</span>}
            {c.enrichedDate?<span style={{fontSize:7,marginLeft:4,color:'var(--green)'}}>‚óè</span>:<span style={{fontSize:7,marginLeft:4,color:'var(--tm)',opacity:.4}}>‚óã</span>}
            </div>
          </div>
          <span className="mono" style={{fontSize:11,color:'var(--tm)'}}>{c.country}</span><SB status={c.status}/><ContactProgress contacts={c.contacts}/><button className="bd bx" onClick={e=>{e.stopPropagation();delCo(c.id)}}>‚úï</button>
        </div>)})}
    </div>
    {tp>1&&<div style={{display:'flex',alignItems:'center',justifyContent:'center',gap:8,marginTop:16}}><button className="bs bsm" disabled={page===0} onClick={()=>setPage(p=>p-1)}>‚Üê</button><span className="mono" style={{fontSize:12,color:'var(--tm)'}}>{page+1}/{tp}</span><button className="bs bsm" disabled={page>=tp-1} onClick={()=>setPage(p=>p+1)}>‚Üí</button></div>}
    {showAdd&&<div className="mo" onClick={()=>setShowAdd(false)}><div className="ml" onClick={e=>e.stopPropagation()}><h3>Add Company</h3><div className="fg"><label>Name</label><input value={form.name} onChange={e=>setForm({...form,name:e.target.value})} autoFocus/></div><div className="fr"><div className="fg"><label>Sector</label><input value={form.sector} onChange={e=>setForm({...form,sector:e.target.value})}/></div><div className="fg"><label>Country</label><input value={form.country} onChange={e=>setForm({...form,country:e.target.value})}/></div></div><div className="fg"><label>Website</label><input value={form.website} onChange={e=>setForm({...form,website:e.target.value})} placeholder="company.com"/></div><div className="fg"><label>Status</label><select value={form.status} onChange={e=>setForm({...form,status:e.target.value})}>{STS.map(s=><option key={s.v} value={s.v}>{s.l}</option>)}</select></div><div className="fg"><label>Notes</label><textarea value={form.notes} onChange={e=>setForm({...form,notes:e.target.value})}/></div><div style={{display:'flex',gap:8,marginTop:16,justifyContent:'flex-end'}}><button className="bs" onClick={()=>setShowAdd(false)}>Cancel</button><button className="bp" onClick={addCo}>Add</button></div></div></div>}
  </div>);
}

function CompanyDetail({cid,data,setData,setView,uid}){
  const company=data.companies.find(c=>c.id===cid);
  const [showAddCt,setShowAddCt]=useState(false);const [emailM,setEmailM]=useState(null);const [callM,setCallM]=useState(null);
  const [newsLoad,setNewsLoad]=useState(false);const [justAdded,setJustAdded]=useState(null);
  const [ctForm,setCtForm]=useState({name:'',role:'',category:'management',email:'',phone:'',linkedin:'',notes:''});
  if(!company)return<div style={{color:'var(--tm)'}}>Not found</div>;
  useEffect(()=>{addRecent(cid,company.name)},[cid]);
  function upCo(u){const ud={...data,companies:data.companies.map(c=>c.id===cid?{...c,...u,updatedAt:new Date().toISOString()}:c)};setData(ud);sv(ud)}
  function upCt(ctid,u){upCo({contacts:company.contacts.map(c=>c.id===ctid?{...c,...u}:c)})}
  function delCt(ctid){if(!confirm('Delete?'))return;upCo({contacts:company.contacts.filter(c=>c.id!==ctid)});if(justAdded===ctid)setJustAdded(null)}
  function addCt(){if(!ctForm.name.trim())return;const newId=gid();const nc={id:newId,...ctForm,userId:uid,contacted:false,contactMethod:'',contactDate:'',lastContactDate:''};let newTasks=[...data.tasks];if(ctForm.email||ctForm.phone){const sd=getStaggerDate(company.id,data.tasks,uid);newTasks.push({id:gid(),companyId:company.id,contactId:newId,userId:uid,type:'email',description:`Initial outreach to ${ctForm.name} at ${company.name}`,dueDate:sd,completed:false,createdAt:new Date().toISOString()})}
    const act=logActAtomic(data,uid,'company',company.id);
    const uCo=data.companies.map(c=>c.id===cid?{...c,contacts:[...(c.contacts||[]),nc],claimedBy:uid,claimDate:new Date().toISOString(),updatedAt:new Date().toISOString()}:c);
    const u={...data,companies:uCo,tasks:newTasks,activity:act};setData(u);sv(u);setJustAdded(newId);setCtForm({name:'',role:'',category:'management',email:'',phone:'',linkedin:'',notes:''});setShowAddCt(false)}
  function handleLinkedInCopy(){const act=logActAtomic(data,uid,'linkedin');const u={...data,activity:act};setData(u);sv(u)}
  function handleSent(ct){
    const act=logActAtomic(data,uid,'email');
    const newStatus=(company.status==='prospect')?'contacted':company.status;
    const uCo=data.companies.map(c=>{if(c.id!==cid)return c;return{...c,status:newStatus,claimedBy:uid,claimDate:new Date().toISOString(),updatedAt:new Date().toISOString(),contacts:c.contacts.map(x=>x.id===ct.id?{...x,contacted:true,contactMethod:'email',contactDate:td(),lastContactDate:td()}:x)}});
    const uT=[...data.tasks,{id:gid(),companyId:company.id,contactId:ct.id,userId:uid,type:'followup',description:`Follow up with ${ct.name} at ${company.name}`,dueDate:fd(4),completed:false,createdAt:new Date().toISOString()}];
    const u={...data,companies:uCo,tasks:uT,activity:act};setData(u);sv(u);setEmailM(null)}
  function handleCall(ct,outcome,notes){
    const log={id:gid(),companyId:company.id,contactId:ct.id,contactName:ct.name,companyName:company.name,outcome,notes,userId:uid,date:new Date().toISOString()};
    const act=logActAtomic(data,uid,'call');
    const newStatus=(company.status==='prospect')?'contacted':company.status;
    const uCo=data.companies.map(c=>{if(c.id!==cid)return c;return{...c,status:newStatus,claimedBy:uid,claimDate:new Date().toISOString(),updatedAt:new Date().toISOString(),contacts:c.contacts.map(x=>x.id===ct.id?{...x,contacted:true,contactMethod:'call',contactDate:td(),lastContactDate:td(),lastCallOutcome:outcome,lastCallNotes:notes}:x)}});
    const days=outcome==='spoke'?5:outcome==='voicemail'?3:2;
    const uT=[...data.tasks,{id:gid(),companyId:company.id,contactId:ct.id,userId:uid,type:outcome==='spoke'?'followup':'call',description:outcome==='spoke'?`Follow up after call with ${ct.name}`:`Re-call ${ct.name} (${outcome})`,dueDate:fd(days),completed:false,createdAt:new Date().toISOString()}];
    const u={...data,companies:uCo,tasks:uT,callLog:[...(data.callLog||[]),log],activity:act};setData(u);sv(u);setCallM(null)}
  async function fetchNews(){setNewsLoad(true);try{const n=await callAI(data.settings.apiKey,'Defence industry analyst. Brief factual intel. Bullet points. Focus: contracts, leadership changes, M&A, hiring, growth.',`Intel on ${company.name} (${company.sector||'Defence'}, ${company.country}). Notes: ${company.notes||'Defence company'}. 5-8 bullets.`);upCo({aiNews:n,newsDate:new Date().toISOString()})}catch(e){alert(e.message)}setNewsLoad(false)}
  const [enrichLoad,setEnrichLoad]=useState(false);
  async function aiEnrich(){setEnrichLoad(true);try{
    const raw=await callAI(data.settings.apiKey,
      `You are a defence/aerospace industry analyst. Given a company name and country, return structured data. Be factual. If unsure, say "Unknown".
Return ONLY valid JSON with these fields:
{
  "description": "1-2 sentence description of what they do",
  "sector": "Primary sector (e.g. Defence, Aerospace, Security, Dual-Use, Electronics, Naval, Land Systems)",
  "subsector": "Specific area (e.g. Radar, EW, Comms, Optronics, Armoured Vehicles, UAV, Cyber, MRO)",
  "size": "Approximate employee count or range (e.g. 150, 500-1000, 5000+)",
  "website": "Company website URL if known",
  "hq": "Headquarters city",
  "keyProgrammes": "Notable programmes, products or platforms (comma separated)",
  "hiringSignals": "Any known growth, expansion, or hiring indicators"
}`,
      `Company: ${company.name}\nCountry: ${company.country}\nExisting notes: ${company.notes||'None'}`);
    try{
      const cleaned=raw.replace(/```json|```/g,'').trim();
      const d=JSON.parse(cleaned);
      const notes=[];
      if(d.description)notes.push(d.description);
      if(d.subsector)notes.push(`Subsector: ${d.subsector}`);
      if(d.size)notes.push(`Size: ~${d.size} employees`);
      if(d.hq)notes.push(`HQ: ${d.hq}`);
      if(d.website)notes.push(`Web: ${d.website}`);
      if(d.keyProgrammes&&d.keyProgrammes!=='Unknown')notes.push(`Programmes: ${d.keyProgrammes}`);
      if(d.hiringSignals&&d.hiringSignals!=='Unknown')notes.push(`Hiring signals: ${d.hiringSignals}`);
      const existingNotes=(company.notes||'').trim();
      const newNotes=existingNotes?existingNotes+'\n\n--- AI ENRICHED '+new Date().toLocaleDateString('en-GB')+' ---\n'+notes.join('\n'):notes.join('\n');
      upCo({notes:newNotes,sector:d.sector||company.sector,enrichedDate:new Date().toISOString()});
    }catch(pe){upCo({notes:(company.notes||'')+'\n\n--- AI ENRICHED ---\n'+raw})}
  }catch(e){alert(e.message)}setEnrichLoad(false)}
  const coTasks=data.tasks.filter(t=>t.companyId===cid&&t.userId===uid&&!t.completed).sort((a,b)=>new Date(a.dueDate)-new Date(b.dueDate));
  const coLogs=(data.callLog||[]).filter(l=>l.companyId===cid).sort((a,b)=>new Date(b.date)-new Date(a.date));
  return(<div className="fi">
    <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:8}}><button className="bs bsm" onClick={()=>setView('companies')}>‚Üê Back</button><h2 style={{fontSize:22,fontWeight:300,flex:1}}>{company.name}</h2>
      <StarRating value={company.priority||0} onChange={v=>{upCo({priority:v,avoided:false})}} size={20}/>
      <button className={company.avoided?'bd bsm':'bs bsm'} onClick={()=>upCo({avoided:!company.avoided,priority:company.avoided?company.priority:0})} title={company.avoided?'Remove avoid':'Mark as avoid'}>{company.avoided?'‚äò Avoided':'‚äò Avoid'}</button>
      <select value={company.status} onChange={e=>upCo({status:e.target.value})} style={{maxWidth:140,fontSize:12}}>{STS.map(s=><option key={s.v} value={s.v}>{s.l}</option>)}</select><SB status={company.status}/></div>
    <div className="mono" style={{fontSize:11,color:'var(--tm)',marginBottom:16}}>{company.sector} ¬∑ {company.country}
      {company.claimedBy&&<span style={{marginLeft:12}}>Claimed by <span style={{color:USERS[company.claimedBy]?.color}}>{USERS[company.claimedBy]?.name}</span></span>}
      {company.website&&<span style={{marginLeft:12}}><a href={company.website.startsWith('http')?company.website:'https://'+company.website} target="_blank" style={{color:'var(--blue)',textDecoration:'none'}}>{company.website.replace(/^https?:\/\//,'')} ‚Üó</a></span>}
    </div>
    {company.avoided&&<div style={{padding:'10px 16px',background:'var(--redd)33',border:'1px solid var(--red)33',borderRadius:8,marginBottom:16,display:'flex',alignItems:'center',gap:10}}><span style={{fontSize:16}}>‚äò</span><div style={{flex:1,fontSize:13,color:'var(--red)',fontWeight:500}}>This company is marked as AVOID</div><button className="bs bx" onClick={()=>upCo({avoided:false})}>Remove</button></div>}
    {(()=>{const claim=getClaimStatus(company,uid);
      if(claim.status==='locked')return(<div style={{padding:'12px 16px',background:'var(--redd)44',border:'1px solid var(--red)44',borderRadius:8,marginBottom:16,display:'flex',alignItems:'center',gap:10}}><span style={{fontSize:18}}>üîí</span><div><div style={{fontWeight:600,color:'var(--red)',fontSize:13}}>Claimed by {USERS[claim.claimedBy]?.name} ‚Äî {claim.months} month{claim.months!==1?'s':''} ago</div><div style={{fontSize:12,color:'var(--t2)',marginTop:2}}>Locked for 3 months from last activity. You cannot add contacts or take actions on this company.</div></div></div>);
      if(claim.status==='stale')return(<div style={{padding:'12px 16px',background:'var(--amberd)44',border:'1px solid var(--amber)44',borderRadius:8,marginBottom:16,display:'flex',alignItems:'center',gap:10}}><span style={{fontSize:18}}>‚ö†</span><div><div style={{fontWeight:600,color:'var(--amber)',fontSize:13}}>Claimed by {USERS[claim.claimedBy]?.name} ‚Äî {claim.months} month{claim.months!==1?'s':''} since last activity</div><div style={{fontSize:12,color:'var(--t2)',marginTop:2}}>Claim is stale. You can take over this company.</div></div><button className="bp bsm" onClick={()=>{const uCo=claimCompany(data,cid,uid);const u={...data,companies:uCo};setData(u);sv(u)}}>Claim for {USERS[uid]?.name}</button></div>);
      if(claim.status==='expired')return(<div style={{padding:'12px 16px',background:'var(--bg2)',border:'1px solid var(--bd)',borderRadius:8,marginBottom:16,display:'flex',alignItems:'center',gap:10}}><span style={{fontSize:18}}>‚óá</span><div><div style={{fontWeight:500,fontSize:13,color:'var(--t2)'}}>Previously claimed by {USERS[claim.claimedBy]?.name} ‚Äî expired ({claim.months} months inactive)</div></div><button className="bp bsm" onClick={()=>{const uCo=claimCompany(data,cid,uid);const u={...data,companies:uCo};setData(u);sv(u)}}>Claim for {USERS[uid]?.name}</button></div>);
      if(claim.status==='mine'&&claim.stale)return(<div style={{padding:'12px 16px',background:'var(--amberd)33',border:'1px solid var(--amber)33',borderRadius:8,marginBottom:16,display:'flex',alignItems:'center',gap:10}}><span style={{fontSize:18}}>‚ö†</span><div><div style={{fontWeight:600,color:'var(--amber)',fontSize:13}}>Your claim is going stale ‚Äî {claim.months} months since last activity</div><div style={{fontSize:12,color:'var(--t2)',marginTop:2}}>Take action to keep this company. After 6 months it opens up to {Object.values(USERS).filter(u=>u.id!==uid)[0]?.name}.</div></div></div>);
      return null;
    })()}
    <div style={{display:'grid',gridTemplateColumns:'5fr 3fr',gap:20}}>
      <div>
        <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:16,marginBottom:16}}>
          <div className="sh" style={{color:'var(--amber)'}}>COMPANY INFO</div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:10}}>
            <div style={{display:'flex',gap:6,alignItems:'center'}}><span className="mono" style={{fontSize:9,color:'var(--t2)',fontWeight:600,width:70,whiteSpace:'nowrap'}}>WEBSITE</span><input value={company.website||''} onChange={e=>upCo({website:e.target.value})} placeholder="company.com" style={{flex:1,fontSize:12}}/>{company.website&&<a href={company.website.startsWith('http')?company.website:'https://'+company.website} target="_blank" style={{color:'var(--blue)',fontSize:11,textDecoration:'none'}}>‚Üó</a>}</div>
            <div style={{display:'flex',gap:6,alignItems:'center'}}><span className="mono" style={{fontSize:9,color:'var(--t2)',fontWeight:600,width:70,whiteSpace:'nowrap'}}>HEADCOUNT</span><input value={company.headcount||''} onChange={e=>upCo({headcount:e.target.value})} placeholder="e.g. 250" style={{flex:1,fontSize:12}}/></div>
            <div style={{display:'flex',gap:6,alignItems:'center'}}><span className="mono" style={{fontSize:9,color:'var(--t2)',fontWeight:600,width:70,whiteSpace:'nowrap'}}>PHONE</span><input value={company.companyPhone||''} onChange={e=>upCo({companyPhone:e.target.value})} placeholder="+44..." style={{flex:1,fontSize:12}}/></div>
            <div style={{display:'flex',gap:6,alignItems:'center'}}><span className="mono" style={{fontSize:9,color:'var(--t2)',fontWeight:600,width:70,whiteSpace:'nowrap'}}>EMAIL</span><input value={company.companyEmail||''} onChange={e=>upCo({companyEmail:e.target.value})} placeholder="info@company.com" style={{flex:1,fontSize:12}}/></div>
            <div style={{display:'flex',gap:6,alignItems:'center'}}><span className="mono" style={{fontSize:9,color:'var(--t2)',fontWeight:600,width:70,whiteSpace:'nowrap'}}>REVENUE</span><input value={company.revenue||''} onChange={e=>upCo({revenue:e.target.value})} placeholder="e.g. ¬£50M" style={{flex:1,fontSize:12}}/></div>
            <div style={{display:'flex',gap:6,alignItems:'center'}}><span className="mono" style={{fontSize:9,color:'var(--t2)',fontWeight:600,width:70,whiteSpace:'nowrap'}}>FOUNDED</span><input value={company.founded||''} onChange={e=>upCo({founded:e.target.value})} placeholder="e.g. 2005" style={{flex:1,fontSize:12}}/></div>
            <div style={{display:'flex',gap:6,alignItems:'center'}}><span className="mono" style={{fontSize:9,color:'var(--t2)',fontWeight:600,width:70,whiteSpace:'nowrap'}}>LINKEDIN</span><input value={company.companyLinkedin||''} onChange={e=>upCo({companyLinkedin:e.target.value})} placeholder="linkedin.com/company/..." style={{flex:1,fontSize:12}}/>{company.companyLinkedin&&<a href={company.companyLinkedin.startsWith('http')?company.companyLinkedin:'https://'+company.companyLinkedin} target="_blank" style={{color:'var(--blue)',fontSize:11,textDecoration:'none'}}>‚Üó</a>}</div>
            <div style={{display:'flex',gap:6,alignItems:'center'}}><span className="mono" style={{fontSize:9,color:'var(--t2)',fontWeight:600,width:70,whiteSpace:'nowrap'}}>GROWTH</span><select value={company.growthSignal||''} onChange={e=>upCo({growthSignal:e.target.value})} style={{flex:1,fontSize:12}}><option value="">‚Äî</option><option value="hiring">Hiring actively</option><option value="growing">Headcount growing</option><option value="new_contract">New contract win</option><option value="expanding">New office/site</option><option value="funding">Recent funding</option><option value="acquisition">Acquisition</option><option value="stable">Stable</option><option value="shrinking">Downsizing</option></select></div>
          </div>
          <div style={{display:'flex',gap:6,alignItems:'center',marginBottom:10}}><span className="mono" style={{fontSize:9,color:'var(--t2)',fontWeight:600,width:70,whiteSpace:'nowrap'}}>SPECIALISM</span><input value={company.specialisms||''} onChange={e=>upCo({specialisms:e.target.value})} placeholder="e.g. RF systems, EW, radar, UAVs, naval combat systems" style={{flex:1,fontSize:12}}/></div>
          <div style={{display:'flex',gap:6,alignItems:'center',marginBottom:10}}><span className="mono" style={{fontSize:9,color:'var(--t2)',fontWeight:600,width:70,whiteSpace:'nowrap'}}>KEY PROGS</span><input value={company.keyProgrammes||''} onChange={e=>upCo({keyProgrammes:e.target.value})} placeholder="e.g. Tempest, Type 26, Challenger 3" style={{flex:1,fontSize:12}}/></div>
          <textarea value={company.notes||''} onChange={e=>upCo({notes:e.target.value})} placeholder="Company notes ‚Äî hiring challenges, org structure, intel from calls..." style={{minHeight:50,fontSize:13}}/>
        </div>
        {CATS.map(cat=>{const cts=(company.contacts||[]).filter(c=>c.category===cat.v);const claim=getClaimStatus(company,uid);const locked=claim.status==='locked';
          return(<div key={cat.v} style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:16,marginBottom:16}}>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}}><div><div className="sh" style={{color:cat.c,marginBottom:2}}>{cat.l.toUpperCase()}</div><div style={{fontSize:10,color:'var(--tm)'}}>{cat.d}</div></div>{!locked&&<button className="bs bsm" onClick={()=>{setCtForm({...ctForm,category:cat.v});setShowAddCt(true)}}>+ Add</button>}</div>
            {cts.length===0&&<div style={{color:'var(--tm)',fontSize:12,fontStyle:'italic'}}>No contacts ‚Äî add from LinkedIn</div>}
            {cts.map(ct=>{const qt=data.tasks.find(t=>t.contactId===ct.id&&t.userId===uid&&t.type==='email'&&!t.completed);const du=qt?daysFromNow(qt.dueDate):null;const isOwner=ct.userId===uid;
              return(<div key={ct.id} className="cc" style={{borderLeft:isOwner?`3px solid ${USERS[uid].color}`:`3px solid var(--bd)`,opacity:isOwner?1:.7}}>
                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:4}}>
                  <OwnerTag userId={ct.userId}/>
                  <span style={{fontWeight:600,fontSize:14}}>{ct.name}</span><span style={{fontSize:12,color:'var(--tm)'}}>{ct.role}</span><span style={{flex:1}}/>
                  {ct.contacted?<span className="badge" style={{color:'var(--green)',background:'var(--green)18'}}>CONTACTED</span>
                  :qt?<span className="queue-badge">QUEUED ¬∑ {du<=0?'TODAY':du===1?'TOMORROW':`${du}d`}</span>
                  :<span className="badge" style={{color:'var(--tm)',background:'var(--bg2)'}}>NEW</span>}
                  {ct.linkedinNoted&&<span className="badge" style={{color:'var(--blue)',background:'var(--blue)18'}}>LI NOTED</span>}
                </div>
                <div style={{display:'flex',gap:16,fontSize:12,color:'var(--t2)',marginBottom:4,flexWrap:'wrap'}}>
                  {ct.email&&<span className="mono">‚úâ {ct.email}</span>}{ct.phone&&<span className="mono">‚òé {ct.phone}</span>}
                  {ct.linkedin&&<a href={ct.linkedin.startsWith('http')?ct.linkedin:'https://'+ct.linkedin} target="_blank" style={{color:'var(--blue)',textDecoration:'none'}}>LinkedIn ‚Üó</a>}
                </div>
                {ct.lastContactDate&&<div className="mono" style={{fontSize:10,color:'var(--tm)',marginBottom:4}}>Last: {ct.contactMethod} on {fmt(ct.lastContactDate)}{ct.lastCallOutcome&&` (${ct.lastCallOutcome})`}</div>}
                {ct.linkedinNoted&&<div className="mono" style={{fontSize:10,color:'var(--blue)',marginBottom:4}}>LinkedIn note sent {fmt(ct.linkedinNoteDate)}</div>}
                {ct.notes&&<div style={{fontSize:12,color:'var(--t2)',marginBottom:4}}>{ct.notes}</div>}
                {ct.lastCallNotes&&<div style={{fontSize:11,color:'var(--tm)',marginBottom:6,padding:'4px 8px',background:'var(--bg2)',borderRadius:4,borderLeft:'2px solid var(--green)'}}>Call: {ct.lastCallNotes}</div>}
                {isOwner&&<div style={{display:'flex',gap:6,flexWrap:'wrap',marginTop:6}}>
                  {ct.email&&<button className="bb bx" onClick={()=>setEmailM({contact:ct,isFollowUp:false})}>‚úâ New Email</button>}
                  {ct.email&&ct.contacted&&<button className="bpu bx" onClick={()=>setEmailM({contact:ct,isFollowUp:true})}>‚óá Follow-up</button>}
                  <button className="bg bx" onClick={()=>setCallM(ct)}>‚òé Log Call</button>
                  {!ct.linkedinNoted?<button className="bb bx" onClick={()=>{
                    const act=logActAtomic(data,uid,'linkedin');
                    const newStatus=(company.status==='prospect')?'contacted':company.status;
                    const uCo=data.companies.map(c=>{if(c.id!==cid)return c;return{...c,status:newStatus,claimedBy:uid,claimDate:new Date().toISOString(),updatedAt:new Date().toISOString(),contacts:c.contacts.map(x=>x.id===ct.id?{...x,linkedinNoted:true,linkedinNoteDate:td(),contacted:true,contactMethod:x.contactMethod||'linkedin',contactDate:x.contactDate||td(),lastContactDate:td()}:x)}});
                    const u={...data,companies:uCo,activity:act};setData(u);sv(u)}}>in Note Sent</button>
                  :<button className="bs bx" onClick={()=>upCt(ct.id,{linkedinNoted:false,linkedinNoteDate:''})}>‚Ü© in</button>}
                  {ct.contacted&&<button className="bs bx" onClick={()=>upCt(ct.id,{contacted:false,contactMethod:'',contactDate:'',lastContactDate:''})}>‚Ü©</button>}
                  <button className="bd bx" onClick={()=>delCt(ct.id)}>‚úï</button>
                </div>}
                {justAdded===ct.id&&<LinkedInBox contact={ct} company={company} onCopy={handleLinkedInCopy}/>}
              </div>)})}
          </div>)})}
      </div>
      <div>
        <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:16,marginBottom:16}}>
          <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}}><div className="sh" style={{color:'var(--amber)',marginBottom:0}}>AI INTELLIGENCE</div><div style={{display:'flex',gap:4}}><button className="bb bx" onClick={aiEnrich} disabled={enrichLoad}>{enrichLoad?'Enriching...':'‚ö° Enrich'}</button><button className="bs bx" onClick={fetchNews} disabled={newsLoad}>{newsLoad?'...':'‚Üª News'}</button></div></div>
          {company.aiNews?<div style={{fontSize:13,lineHeight:1.6,whiteSpace:'pre-wrap',color:'var(--t2)'}}>{company.aiNews}{company.newsDate&&<div className="mono" style={{fontSize:10,color:'var(--tm)',marginTop:8}}>Updated: {fmt(company.newsDate)}</div>}</div>:<div style={{color:'var(--tm)',fontSize:12}}>Click "Pull News" for AI intel.</div>}
        </div>
        <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:16,marginBottom:16}}>
          <div className="sh" style={{color:'var(--amber)'}}>MY TASKS ({coTasks.length})</div>
          {coTasks.length===0&&<div style={{color:'var(--tm)',fontSize:12}}>No tasks</div>}
          {coTasks.map(t=>{const ct=company.contacts?.find(c=>c.id===t.contactId);const d=daysFromNow(t.dueDate);
            return(<div key={t.id} style={{padding:'6px 0',borderBottom:'1px solid var(--bd)',display:'flex',alignItems:'center',gap:8,fontSize:12}}>
              <span style={{color:t.type==='call'?'var(--green)':t.type==='email'?'var(--blue)':'var(--purple)'}}>{t.type==='call'?'‚òé':t.type==='email'?'‚úâ':'‚óá'}</span>
              <span style={{flex:1,color:'var(--t2)'}}>{ct?ct.name+' ‚Äî ':''}{t.type==='email'?'Initial outreach':t.description}</span>
              <span className="mono" style={{fontSize:10,color:isOD(t.dueDate)?'var(--red)':d<=0?'var(--amber)':'var(--tm)'}}>{isOD(t.dueDate)?'OVERDUE':d===0?'TODAY':d===1?'TOMORROW':t.dueDate}</span>
              <button className="bs bx" onClick={()=>{const u={...data,tasks:data.tasks.map(x=>x.id===t.id?{...x,completed:true}:x)};setData(u);sv(u)}}>‚úì</button></div>)})}
        </div>
        <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:16}}>
          <div className="sh" style={{color:'var(--green)'}}>CALL LOG ({coLogs.length})</div>
          {coLogs.length===0&&<div style={{color:'var(--tm)',fontSize:12}}>No calls</div>}
          {coLogs.slice(0,10).map(l=>(<div key={l.id} className="cl"><div style={{display:'flex',justifyContent:'space-between',marginBottom:2}}><span style={{fontWeight:500}}>{l.contactName} <OwnerTag userId={l.userId}/></span><span className="mono" style={{fontSize:10,color:'var(--tm)'}}>{fmt(l.date)}</span></div><div><span style={{fontSize:10,fontWeight:600,color:l.outcome==='spoke'?'var(--green)':l.outcome==='voicemail'?'var(--blue)':'var(--tm)'}}>{l.outcome==='spoke'?'‚úì Spoke':l.outcome==='voicemail'?'‚úâ VM':'‚úó No ans'}</span>{l.notes&&<span style={{color:'var(--t2)',marginLeft:8}}>{l.notes}</span>}</div></div>))}
        </div>
      </div>
    </div>
    {showAddCt&&<div className="mo" onClick={()=>setShowAddCt(false)}><div className="ml" onClick={e=>e.stopPropagation()}><h3>Add Decision Maker</h3><p style={{fontSize:12,color:'var(--tm)',marginBottom:4}}>Adding as <strong style={{color:USERS[uid].color}}>{USERS[uid].name}</strong></p><p style={{fontSize:11,color:'var(--blue)',marginBottom:16}}>Contacts at same company spaced 2 weeks apart.</p><div className="fr"><div className="fg"><label>Full Name</label><input value={ctForm.name} onChange={e=>setCtForm({...ctForm,name:e.target.value})} placeholder="John Smith" autoFocus/></div><div className="fg"><label>Job Title</label><input value={ctForm.role} onChange={e=>setCtForm({...ctForm,role:e.target.value})} placeholder="Managing Director"/></div></div><div className="fg"><label>Category</label><select value={ctForm.category} onChange={e=>setCtForm({...ctForm,category:e.target.value})}>{CATS.map(c=><option key={c.v} value={c.v}>{c.l} ({c.d})</option>)}</select></div><div className="fr3"><div className="fg"><label>Email</label><input value={ctForm.email} onChange={e=>setCtForm({...ctForm,email:e.target.value})} placeholder="name@co.com"/></div><div className="fg"><label>Phone</label><input value={ctForm.phone} onChange={e=>setCtForm({...ctForm,phone:e.target.value})} placeholder="+44..."/></div><div className="fg"><label>LinkedIn</label><input value={ctForm.linkedin} onChange={e=>setCtForm({...ctForm,linkedin:e.target.value})} placeholder="linkedin.com/in/..."/></div></div><div className="fg"><label>Notes</label><textarea value={ctForm.notes} onChange={e=>setCtForm({...ctForm,notes:e.target.value})} placeholder="Background..." style={{minHeight:60}}/></div><div style={{display:'flex',gap:8,marginTop:16,justifyContent:'flex-end'}}><button className="bs" onClick={()=>setShowAddCt(false)}>Cancel</button><button className="bp" onClick={addCt}>Save & Queue Outreach</button></div></div></div>}
    {emailM&&<EmailModal contact={emailM.contact} company={company} data={data} setData={setData} isFollowUp={emailM.isFollowUp} onClose={()=>setEmailM(null)} onSent={handleSent} uid={uid}/>}
    {callM&&<CallModal contact={callM} company={company} onClose={()=>setCallM(null)} onSave={handleCall}/>}
  </div>);
}

function TaskList({data,setData,setView,setSel,uid}){
  const [filter,setFilter]=useState('open');const [showAdd,setShowAdd]=useState(false);
  const [form,setForm]=useState({companyId:'',type:'followup',description:'',dueDate:''});
  const tasks=data.tasks.filter(t=>t.userId===uid).filter(t=>{if(filter==='open')return!t.completed;if(filter==='completed')return t.completed;if(filter==='overdue')return!t.completed&&isOD(t.dueDate);if(filter==='calls')return!t.completed&&t.type==='call';if(filter==='emails')return!t.completed&&(t.type==='email'||t.type==='followup');return true}).sort((a,b)=>{if(a.completed!==b.completed)return a.completed?1:-1;return new Date(a.dueDate)-new Date(b.dueDate)});
  return(<div className="fi">
    <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:24}}><h2 style={{fontSize:22,fontWeight:300}}><span style={{color:'var(--amber)'}} className="mono">‚óá</span> Tasks</h2><button className="bp" onClick={()=>setShowAdd(true)}>+ Add Task</button></div>
    <div style={{display:'flex',gap:8,marginBottom:20,flexWrap:'wrap'}}>{['open','overdue','calls','emails','completed','all'].map(f=><button key={f} className={filter===f?'bp':'bs'} style={{textTransform:'capitalize'}} onClick={()=>setFilter(f)}>{f}{f==='overdue'&&` (${data.tasks.filter(t=>t.userId===uid&&!t.completed&&isOD(t.dueDate)).length})`}</button>)}</div>
    <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10}}>
      {tasks.length===0&&<div style={{padding:32,textAlign:'center',color:'var(--tm)',fontSize:13}}>No tasks</div>}
      {tasks.map(t=>{const co=data.companies.find(c=>c.id===t.companyId);return(
        <div key={t.id} style={{display:'flex',alignItems:'center',gap:12,padding:'10px 16px',borderBottom:'1px solid var(--bd)',opacity:t.completed?.5:1}}>
          <input type="checkbox" checked={t.completed} onChange={()=>{const u={...data,tasks:data.tasks.map(x=>x.id===t.id?{...x,completed:!x.completed}:x)};setData(u);sv(u)}} style={{width:16,height:16,cursor:'pointer'}}/>
          <span style={{fontSize:16,color:t.type==='call'?'var(--green)':t.type==='email'?'var(--blue)':'var(--purple)'}}>{t.type==='call'?'‚òé':t.type==='email'?'‚úâ':'‚óá'}</span>
          {co&&<span className="badge" style={{cursor:'pointer',color:'var(--amber)',background:'var(--amber)18'}} onClick={()=>{addRecent(co.id,co.name);setSel(co.id);setView('companyDetail')}}>{co.name}</span>}
          <span style={{flex:1,fontSize:13,textDecoration:t.completed?'line-through':'none'}}>{t.description}</span>
          <span className="mono" style={{fontSize:11,color:isOD(t.dueDate)?'var(--red)':'var(--tm)'}}>{t.dueDate}</span>
          <button className="bd bx" onClick={()=>{const u={...data,tasks:data.tasks.filter(x=>x.id!==t.id)};setData(u);sv(u)}}>‚úï</button>
        </div>)})}
    </div>
    {showAdd&&<div className="mo" onClick={()=>setShowAdd(false)}><div className="ml" onClick={e=>e.stopPropagation()}><h3>Add Task</h3><div className="fg"><label>Company</label><select value={form.companyId} onChange={e=>setForm({...form,companyId:e.target.value})}><option value="">‚Äî None ‚Äî</option>{data.companies.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div><div className="fr"><div className="fg"><label>Type</label><select value={form.type} onChange={e=>setForm({...form,type:e.target.value})}><option value="email">Email</option><option value="call">Call</option><option value="followup">Follow-up</option></select></div><div className="fg"><label>Due Date</label><input type="date" value={form.dueDate} onChange={e=>setForm({...form,dueDate:e.target.value})}/></div></div><div className="fg"><label>Description</label><input value={form.description} onChange={e=>setForm({...form,description:e.target.value})} placeholder="What needs doing?"/></div><div style={{display:'flex',gap:8,marginTop:16,justifyContent:'flex-end'}}><button className="bs" onClick={()=>setShowAdd(false)}>Cancel</button><button className="bp" onClick={()=>{if(!form.description.trim()||!form.dueDate)return;const u={...data,tasks:[...data.tasks,{id:gid(),...form,userId:uid,completed:false,createdAt:new Date().toISOString()}]};setData(u);sv(u);setForm({companyId:'',type:'followup',description:'',dueDate:''});setShowAdd(false)}}>Add</button></div></div></div>}
  </div>);
}

function TrackRecord({data,setData}){const [s,setS]=useState(false);
  return(<div className="fi"><h2 style={{fontSize:22,fontWeight:300,marginBottom:8}}><span style={{color:'var(--amber)'}} className="mono">‚ñ£</span> Track Record</h2><p style={{color:'var(--t2)',fontSize:13,marginBottom:8,maxWidth:600}}>Your background. AI uses this to personalise emails.</p><p style={{color:'var(--amber)',fontSize:12,marginBottom:24,maxWidth:600,background:'var(--amberd)33',padding:'8px 12px',borderRadius:6}}>‚ö† Client names automatically anonymised in AI emails.</p><div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:20}}><div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}}><div className="sh" style={{color:'var(--amber)',marginBottom:0}}>YOUR BACKGROUND</div>{s&&<span className="mono" style={{fontSize:11,color:'var(--green)'}}>SAVED ‚úì</span>}</div><textarea value={data.trackRecord||''} onChange={e=>{const u={...data,trackRecord:e.target.value};setData(u);sv(u);setS(true);setTimeout(()=>setS(false),1000)}} style={{minHeight:400,fontSize:13,lineHeight:1.7}}/></div></div>)}

function Settings({data,setData,fileConnected,onConnect}){
  const [key,setKey]=useState(data.settings?.apiKey||'');const [saved,setSaved]=useState(false);
  return(<div className="fi" style={{maxWidth:560}}>
    <h2 style={{fontSize:22,fontWeight:300,marginBottom:24}}><span style={{color:'var(--amber)'}} className="mono">‚öô</span> Settings</h2>
    <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:20,marginBottom:20}}>
      <div className="sh" style={{color:'var(--amber)'}}>ANTHROPIC API KEY</div>
      <p style={{fontSize:12,color:'var(--tm)',marginBottom:12}}><a href="https://console.anthropic.com" target="_blank" style={{color:'var(--amber)'}}>console.anthropic.com</a></p>
      <div style={{display:'flex',gap:8}}><input type="password" value={key} onChange={e=>setKey(e.target.value)} placeholder="sk-ant-..." style={{flex:1}}/><button className="bp" onClick={()=>{const u={...data,settings:{...data.settings,apiKey:key}};setData(u);sv(u);setSaved(true);setTimeout(()=>setSaved(false),2000)}}>Save</button></div>
      {saved&&<div className="mono" style={{fontSize:11,color:'var(--green)',marginTop:8}}>SAVED ‚úì</div>}
    </div>
    <div style={{background:'var(--bgc)',border:`1px solid ${fileConnected?'var(--green)':'var(--amber)'}33`,borderRadius:10,padding:20,marginBottom:20}}>
      <div className="sh" style={{color:fileConnected?'var(--green)':'var(--amber)'}}>üíæ AUTO-SAVE FILE</div>
      <p style={{fontSize:12,color:'var(--t2)',marginBottom:12}}>{fileConnected?'Connected ‚Äî data auto-saves to your cloud file.':'Connect a save file so data survives browser cache clears.'}</p>
      <div style={{display:'flex',gap:8}}><button className={fileConnected?'bg':'bp'} onClick={onConnect}>{fileConnected?'‚óè Connected ‚Äî Change File':'Connect Save File'}</button>{fileConnected&&<button className="bs" onClick={async()=>{await writeToFile(data);alert('Saved!')}}>Save Now</button>}</div>
      {!fileConnected&&<p className="mono" style={{fontSize:10,color:'var(--amber)',marginTop:8}}>‚ö† NOT CONNECTED</p>}
    </div>
    <div style={{background:'var(--bgc)',border:'1px solid var(--bd)',borderRadius:10,padding:20}}>
      <div className="sh" style={{color:'var(--amber)'}}>DATA</div>
      <div style={{display:'flex',gap:8,flexWrap:'wrap'}}>
        <button className="bs" onClick={()=>{const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`recon-${td()}.json`;a.click()}}>‚Üì Export JSON</button>
        <button className="bs" onClick={()=>exportCSV(data)}>‚Üì Export CSV</button>
        <label className="bs" style={{display:'inline-flex',alignItems:'center',cursor:'pointer'}}>‚Üë Import<input type="file" accept=".json" onChange={e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.companies){const m=migrateData(d);setData(m);sv(m);setKey(m.settings?.apiKey||'');alert('Done!')}}catch{alert('Error')}};r.readAsText(f)}} style={{display:'none'}}/></label>
        <button className="bd" onClick={()=>{if(confirm('Delete ALL?')&&confirm('Sure?')){const f={companies:[],tasks:[],trackRecord:'',callLog:[],activity:{stephen:{},ebrima:{}},settings:{apiKey:data.settings?.apiKey},_version:3};setData(f);sv(f)}}}>‚ö† Clear</button>
        <button className="bs" onClick={async()=>{if(confirm('Reset to seed? Contacts/tasks/activity lost.')){localStorage.removeItem(SK);const f=await lds();const m=migrateData(f);setData(m);setKey(m.settings?.apiKey||'')}}}>‚Ü∫ Reset</button>
      </div>
    </div>
  </div>);
}

function RestoreScreen({onRestore,onFresh}){return(<div className="restore-screen"><div className="mono" style={{fontSize:32,color:'var(--amber)',letterSpacing:4}}>‚ñ£ RECON</div><div style={{fontSize:16,color:'var(--t2)',maxWidth:400}}>Browser data cleared. Load your recon-data.json backup to restore.</div><div style={{display:'flex',gap:12,marginTop:12}}><button className="bp" style={{padding:'12px 24px',fontSize:15}} onClick={onRestore}>Load Save File</button><button className="bs" style={{padding:'12px 24px',fontSize:15}} onClick={onFresh}>Start Fresh (seed data)</button></div><div className="mono" style={{fontSize:11,color:'var(--tm)',maxWidth:400,marginTop:16}}>Pick the recon-data.json from your cloud folder. If you never saved one, hit Start Fresh then connect a save file in Settings.</div></div>)}

function App(){
  const [data,setData]=useState(null);const [loading,setLoading]=useState(true);const [view,setView]=useState('actions');const [sel,setSel]=useState(null);
  const [fileConnected,setFileConnected]=useState(false);const [showRestore,setShowRestore]=useState(false);
  const [uid,setUid]=useState('stephen');

  useEffect(()=>{
    const existing=ld();
    if(existing){const m=migrateData(existing);m.callLog=m.callLog||[];setData(m);sv(m);setLoading(false)}
    else{setShowRestore(true);setLoading(false)}
  },[]);

  async function handleRestore(){
    if(window.showOpenFilePicker){
      const r=await loadFromFile();
      if(r){const m=migrateData(r);setData(m);sv(m);setFileConnected(true);setShowRestore(false)}
    }else{
      // Fallback for browsers without File System Access API
      const input=document.createElement('input');input.type='file';input.accept='.json';
      input.onchange=e=>{const f=e.target.files[0];if(!f)return;const reader=new FileReader();
        reader.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.companies){d.callLog=d.callLog||[];d.activity=d.activity||{};d.tasks=d.tasks||[];d.settings=d.settings||{apiKey:''};d.trackRecord=d.trackRecord||'';const m=migrateData(d);setData(m);sv(m);setShowRestore(false)}else{alert('No companies found in file.')}}catch(err){alert('Error reading file: '+err.message)}};
        reader.readAsText(f)};
      input.click();
    }
  }
  async function handleFresh(){const f=await lds();const m=migrateData(f);setData(m);setShowRestore(false)}
  async function handleConnect(){const ok=await connectSaveFile();if(ok){setFileConnected(true);if(data)await writeToFile(data)}}
  async function handleSaveNow(){if(data&&_fileHandle){const ok=await writeToFile(data);if(ok)alert('Saved to file!')}}

  if(loading)return<div style={{display:'flex',alignItems:'center',justifyContent:'center',height:'100vh',background:'var(--bg0)'}}><div style={{textAlign:'center'}}><div className="mono" style={{fontSize:24,color:'var(--amber)',letterSpacing:4,marginBottom:12}}>‚ñ£ RECON</div><div style={{color:'var(--tm)',fontSize:13}}>Loading...</div></div></div>;
  if(showRestore)return<RestoreScreen onRestore={handleRestore} onFresh={handleFresh}/>;
  if(!data)return null;

  const ac=data.tasks.filter(t=>!t.completed&&t.userId===uid&&(isOD(t.dueDate)||isT(t.dueDate)||isS(t.dueDate))).length;
  const rv=()=>{switch(view){
    case'actions':return<DailyActions data={data} setData={setData} setView={setView} setSel={setSel} uid={uid}/>;
    case'companies':return<CompanyList data={data} setData={setData} setView={setView} setSel={setSel} uid={uid}/>;
    case'contacts':return<ContactsView data={data} setView={setView} setSel={setSel} uid={uid}/>;
    case'companyDetail':return<CompanyDetail cid={sel} data={data} setData={setData} setView={setView} uid={uid}/>;
    case'tasks':return<TaskList data={data} setData={setData} setView={setView} setSel={setSel} uid={uid}/>;
    case'trackrecord':return<TrackRecord data={data} setData={setData}/>;
    case'settings':return<Settings data={data} setData={setData} fileConnected={fileConnected} onConnect={handleConnect}/>;
    default:return<DailyActions data={data} setData={setData} setView={setView} setSel={setSel} uid={uid}/>}};
  return<div style={{display:'flex',minHeight:'100vh'}}><Sidebar view={view} setView={setView} ac={ac} fileConnected={fileConnected} onConnect={handleConnect} onSaveNow={handleSaveNow} uid={uid} setUid={setUid}/><main style={{marginLeft:220,flex:1,padding:'32px 40px',maxWidth:1200}}>{rv()}</main></div>;
}
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
